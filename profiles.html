<script src="girls.js"></script>
<script>
window.onload = async function() {
    const backendUrl = "https://charmr-jfmc.onrender.com";
    const userId = "user1"; // Replace with logged-in user later
    let lastMessageTime = null;

    // Fetch all profiles so we can pick random girls to send initial messages from
    async function sendInitialMessages() {
        try {
            const res = await fetch(`${backendUrl}/api/profiles`);
            const profiles = await res.json();
            // Shuffle and pick 2 random girls
            const selected = [...profiles].sort(() => Math.random() - 0.5).slice(0, 2);

            for (const girl of selected) {
                await fetch(`${backendUrl}/api/send-initial-message`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, girlId: girl.id })
                });
            }
            console.log("Initial messages sent from random girls.");
        } catch (err) {
            console.error("Error sending initial messages:", err);
        }
    }

    // Trigger the random initial messages on page load
    await sendInitialMessages();

    function showNotification(from, text, avatar) {
        const notif = document.createElement("div");
        notif.className = "notification-popup";

        notif.innerHTML = `
            <img src="${avatar}" alt="${from}" class="notif-avatar">
            <div class="notif-text">
                <strong>${from}</strong>
                <p>${text}</p>
            </div>
        `;

        notif.onclick = () => window.location.href = "inbox.html";
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
    }

    async function checkForNewMessages() {
        try {
            const res = await fetch(`${backendUrl}/api/messages/${userId}`);
            const msgsByChat = await res.json();

            // Flatten messages
            const allMsgs = Object.values(msgsByChat).flat();
            if (allMsgs.length === 0) return;

            const latest = allMsgs[allMsgs.length - 1];
            if (!lastMessageTime || new Date(latest.time) > new Date(lastMessageTime)) {
                lastMessageTime = latest.time;
                showNotification(latest.from, latest.text, latest.avatar || "default-avatar.png");
            }
        } catch (err) {
            console.error("Error fetching messages", err);
        }
    }

    // Start polling for new messages
    setTimeout(() => {
        checkForNewMessages();
        setInterval(checkForNewMessages, 5000);
    }, 5000);
};
</script>
