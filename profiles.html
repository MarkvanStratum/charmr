<script src="girls.js"></script>
<script>
window.onload = async function() {
    const backendUrl = "https://charmr-jfmc.onrender.com";
    const token = localStorage.getItem("authToken");
    let lastMessageTime = null;

    // Load profiles and render them
    async function loadProfiles() {
        const res = await fetch(`${backendUrl}/api/profiles`);
        const profiles = await res.json();
        const container = document.getElementById("profileContainer");
        container.innerHTML = "";
        profiles.forEach(profile => {
            const card = document.createElement("div");
            card.className = "profile-card";
            card.innerHTML = `
                <img src="${profile.image}" alt="${profile.name}">
                <h3>${profile.name}</h3>
                <p>Age: ${profile.age}</p>
                <p>City: ${profile.city}</p>
                <div class="btn-group">
                  <button onclick="window.location.href='chat.html?id=${profile.id}'">Chat</button>
                  <button onclick="window.location.href='profile.html?id=${profile.id}'">View Profile</button>
                </div>
            `;
            container.appendChild(card);
        });
        return profiles;
    }

    // Send initial messages from specific girls
    async function sendInitialMessage(girlId) {
        if (!token) return;
        await fetch(`${backendUrl}/api/send-initial-message`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ girlId })
        }).catch(err => console.error("Initial message error:", err));
    }

    // Send 5 random initial messages every minute
    function startCannedMessages(profiles) {
        setInterval(() => {
            const selectedGirls = [...profiles]
                .sort(() => 0.5 - Math.random())
                .slice(0, 5);
            selectedGirls.forEach(g => sendInitialMessage(g.id));
        }, 60000);
    }

    const profiles = await loadProfiles();
    if (token) startCannedMessages(profiles);

    function showNotification(from, text, avatar) {
        const notif = document.createElement("div");
        notif.className = "notification-popup";
        notif.innerHTML = `
            <img src="${avatar}" alt="${from}" class="notif-avatar">
            <div class="notif-text">
                <strong>${from}</strong>
                <p>${text}</p>
            </div>
        `;
        notif.onclick = () => window.location.href = "inbox.html";
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
    }

    async function checkForNewMessages() {
        if (!token) return;
        const res = await fetch(`${backendUrl}/api/messages`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        const msgsByChat = await res.json();
        const allMsgs = Object.values(msgsByChat).flat();
        if (allMsgs.length === 0) return;
        const latest = allMsgs[allMsgs.length - 1];
        if (!lastMessageTime || new Date(latest.time) > new Date(lastMessageTime)) {
            lastMessageTime = latest.time;
            showNotification(latest.from, latest.text, latest.avatar || "default-avatar.png");
        }
    }

    setTimeout(() => {
        checkForNewMessages();
        setInterval(checkForNewMessages, 5000);
    }, 5000);
};
</script>
