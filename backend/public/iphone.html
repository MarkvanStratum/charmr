<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Secure Checkout ‚Äî Intro Offer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#ffffff; --card:#f8f9fc; --text:#111; --muted:#555; --line:#ddd; --cta1:#ffd76b; --cta2:#ffb429; --radius:16px }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:18px 14px 40px; }
    .shell{ width:min(900px,100%); display:flex; flex-direction:column; gap:18px }
    .card{ width:min(720px,100%); background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:24px; box-shadow:0 8px 20px rgba(0,0,0,.05); margin-inline:auto }
    .title{ font-size:28px; font-weight:900; text-align:center; margin:4px 0 12px }
    .sub{ text-align:center; color:var(--muted); margin-top:-6px; margin-bottom:16px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px }
    .btn{ width:100%; border:none; color:#111; border-radius:12px; padding:12px 16px; font-weight:900; cursor:pointer; font-size:16px; background:linear-gradient(180deg,var(--cta1),var(--cta2)); box-shadow:0 8px 18px rgba(255,174,15,.25) }
    .btn-row{ display:flex; gap:12px; margin-top:12px }
    .muted-btn{ background:#eee; color:#333; border:1px solid #ddd }
    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }
    .label{ font-weight:700; margin:4px 0 8px; font-size:14px; color:#333 }
    .el{ width:100%; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px; padding:12px }
    .brands{ display:flex; justify-content:center; gap:12px; margin:14px 0 6px }
    .brands img{ height:22px }
    .trust-text{ font-size:13px; color:#666; text-align:center; margin-top:12px }
    #err{ width:100%; margin-top:10px; font-size:14px; color:#b00020; background:#fde9eb; border:1px solid #e5b2b8; border-radius:10px; padding:8px; display:none }
    #err[aria-hidden="false"]{ display:block }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:9999; text-align:center }
    .loading-overlay[aria-hidden="false"]{ display:flex }
    .loading-box{ width:min(92vw,460px); background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; text-align:center }
    .loading-title{ font-weight:800; margin:2px 0 10px; color:#111 }
    .progress-wrap{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden }
    .progress-bar{ width:0%; height:100%; background:linear-gradient(90deg, var(--cta1), var(--cta2)); animation:loadingBar 2.2s ease-in-out infinite }
    @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }
    .addr-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 0 }
    .addr-grid .full{ grid-column:1/-1 }
  </style>
</head>
<body>
  <div class="shell">

    <!-- STEP 1: Account & contact info (build trust) -->
    <section id="step1" class="card step" aria-hidden="false">
      <h1 class="title">Secure your intro offer</h1>
      <p class="sub">Create your account. You can cancel anytime.</p>

      <div class="grid" style="margin-top:10px">
        <input class="input" id="nameInput" placeholder="Full name" autocomplete="name" required />
        <input class="input" id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" required />
        <input class="input" id="passwordInput" type="password" placeholder="Create a password" autocomplete="new-password" required style="grid-column:1/-1" />
        <input class="input" id="phoneInput" inputmode="tel" placeholder="Phone (for receipts / support)" autocomplete="tel" style="grid-column:1/-1" />
      </div>

      <div class="btn-row">
        <button id="nextBtn" class="btn">Next step ‚Üí</button>
      </div>
      <p class="trust-text">We‚Äôll never share your contact info. 100% privacy guaranteed.</p>
    </section>

    <!-- STEP 2: Payment (two-step: intro charge ‚Üí start subscription) -->
    <section id="step2" class="card step" aria-hidden="true">
      <h2 class="title">Secure Payment</h2>
      <p class="sub">Your details are safe ‚Äî powered by Stripe.</p>
      <p class="sub" style="margin-top:-6px;color:#0b6b3a"><strong>Today's charge:</strong> ¬£20.00 one-time intro payment. Your subscription starts after this succeeds.</p>

      <div class="addr-grid" aria-label="Billing address">
        <input id="addr1" class="input full" placeholder="Address line 1" autocomplete="address-line1" required>
        <input id="city" class="input" placeholder="City" autocomplete="address-level2" required>
        <input id="region" class="input" placeholder="State / Region" autocomplete="address-level1" required>
        <input id="postal" class="input" placeholder="ZIP / Postal code" autocomplete="postal-code" required>
        <select id="country" class="input" required>
          <option value="" selected disabled>Choose country</option>
          <option value="US">United States</option>
          <option value="GB">United Kingdom</option>
          <option value="CA">Canada</option>
          <option value="AU">Australia</option>
          <option value="IE">Ireland</option>
          <option value="NZ">New Zealand</option>
          <option value="DE">Germany</option>
          <option value="FR">France</option>
          <option value="NL">Netherlands</option>
          <option value="SE">Sweden</option>
          <option value="NO">Norway</option>
          <option value="DK">Denmark</option>
          <option value="FI">Finland</option>
          <option value="IT">Italy</option>
          <option value="ES">Spain</option>
          <option value="GE">Georgia</option><!-- ADDED -->
          <option value="CO">Colombia</option><!-- common test case -->
        </select>
      </div>

      <div class="label">Card number</div>
      <div id="card-number" class="el"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <div class="label">Expiration</div>
          <div id="card-expiry" class="el"></div>
        </div>
        <div>
          <div class="label">CVC</div>
          <div id="card-cvc" class="el"></div>
        </div>
      </div>

      <div id="err" role="alert" aria-hidden="true"></div>

      <div class="btn-row">
        <button id="backBtn" class="btn muted-btn">‚Üê Back</button>
        <button class="btn" id="payNow">Pay ¬£20.00 Securely</button>
      </div>

      <div class="brands">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa">
        <img src="https://charmr.xyz/logos/mc2.png" alt="Mastercard">
        <img src="https://charmr.xyz/logos/amex.png" alt="Amex">
        <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay">
      </div>

      <p class="trust-text">üîí 256-bit SSL Secured ¬∑ Powered by Stripe ¬∑ 30-Day Money Back Guarantee</p>
    </section>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-box">
      <div class="loading-title">Processing your payment‚Ä¶</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub">Please wait, this may take a few seconds.</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
    // ---------- Step navigation ----------
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const phoneInput = document.getElementById('phoneInput');

    // Country & phone helpers
    const countrySelect = document.getElementById('country');
    const cityInput = document.getElementById('city');
    const regionInput = document.getElementById('region');
    const postalInput = document.getElementById('postal');

    // Minimal dialing code map (we also read from ip API when available)
    const E164_BY_ISO = {
      US: '+1', CA: '+1', GB: '+44', IE: '+353', AU: '+61', NZ: '+64',
      DE: '+49', FR: '+33', NL: '+31', SE: '+46', NO: '+47', DK: '+45',
      FI: '+358', IT: '+39', ES: '+34', GE: '+995', CO: '+57'
    };

    let geoLocked = false; // prevents late fallback from overwriting
    let lastAutoPrefix = null;

    function setCountryOption(iso2, label) {
      const val = (iso2 || '').toUpperCase();
      if (!val) return;
      let opt = [...countrySelect.options].find(o => o.value === val);
      if (!opt) {
        opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label || val;
        countrySelect.appendChild(opt);
      }
      countrySelect.value = val;
    }

    function maybeSetPhonePrefix(prefix) {
      if (!prefix) return;
      const v = phoneInput.value.trim();
      const looksManual = v && !v.startsWith(lastAutoPrefix || '') && v.replace(/\D/g,'').length > 3;
      if (looksManual) return; // don't fight the user
      if (!v || v[0] !== '+') {
        phoneInput.value = prefix + (v.replace(/^\+/, '') ? (' ' + v.replace(/^\+/, '')) : '');
      } else if (lastAutoPrefix && v.startsWith(lastAutoPrefix)) {
        phoneInput.value = prefix + v.slice(lastAutoPrefix.length);
      }
      lastAutoPrefix = prefix;
    }

    countrySelect.addEventListener('change', () => {
      const iso = countrySelect.value.toUpperCase();
      const prefix = E164_BY_ISO[iso] || lastAutoPrefix || '';
      if (prefix) {
        // only auto-update prefix if user hasn't typed something long themselves
        const raw = phoneInput.value.trim();
        if (!raw || raw.replace(/\D/g,'').length <= 3 || (lastAutoPrefix && raw.startsWith(lastAutoPrefix))) {
          maybeSetPhonePrefix(prefix);
        }
      }
    });

    async function geoFromIpapi() {
      const r = await fetch('https://ipapi.co/json/', { cache: 'no-store' });
      if (!r.ok) throw new Error('ipapi failed');
      const j = await r.json();
      return {
        iso: (j.country || '').toUpperCase(),
        country: j.country_name || '',
        city: j.city || '',
        region: j.region || '',
        postal: j.postal || '',
        dial: j.country_calling_code || ''
      };
    }
    async function geoFromIpwho() {
      const r = await fetch('https://ipwho.is/?fields=country,country_code,region,city,postal,calling_code', { cache: 'no-store' });
      if (!r.ok) throw new Error('ipwho failed');
      const j = await r.json();
      if (j && j.success === false) throw new Error('ipwho bad');
      return {
        iso: (j.country_code || '').toUpperCase(),
        country: j.country || '',
        city: j.city || '',
        region: j.region || '',
        postal: j.postal || '',
        dial: j.calling_code ? ('+' + String(j.calling_code)) : ''
      };
    }

    async function setGeoDefaults() {
      if (geoLocked) return;
      try {
        let g = null;
        try { g = await geoFromIpapi(); } catch {}
        if (!g || !g.iso) { try { g = await geoFromIpwho(); } catch {} }
        if (!g || !g.iso) throw new Error('no geo');

        // Fill UI
        setCountryOption(g.iso, g.country);
        if (!cityInput.value && g.city) cityInput.value = g.city;
        if (!regionInput.value && g.region) regionInput.value = g.region;
        if (!postalInput.value && g.postal) postalInput.value = g.postal;

        const prefix = g.dial || E164_BY_ISO[g.iso] || '';
        maybeSetPhonePrefix(prefix);

        geoLocked = true; // lock once set
      } catch {
        // fallback: try navigator language -> region (e.g., en-GB)
        const m = (navigator.language || '').match(/-([A-Z]{2})$/i);
        const guessIso = m ? m[1].toUpperCase() : '';
        if (guessIso) {
          setCountryOption(guessIso);
          const prefix = E164_BY_ISO[guessIso] || '';
          maybeSetPhonePrefix(prefix);
          geoLocked = true;
        }
      }
    }

    async function ensureAccount(){
      const email = (emailInput.value||'').trim();
      const password = passwordInput.value||'';
      if(!email || !password) throw new Error('Please enter email and password.');
      const res = await fetch('/api/register', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password, phone: (phoneInput.value||'').trim() })
      });
      if (res.status === 201) return true;
      const data = await res.json().catch(()=>({}));
      if (res.status === 400 && /exists/i.test(data?.error||'')) return true;
      throw new Error(data?.error || 'Could not create account');
    }

    document.getElementById('nextBtn').onclick = async () => {
      if(!nameInput.value||!emailInput.value||!passwordInput.value){ alert('Please enter your details'); return; }
      try { await ensureAccount(); } catch(e){ alert(e.message||'Problem creating your account.'); return; }
      localStorage.setItem('checkout_name', nameInput.value);
      localStorage.setItem('checkout_email', emailInput.value);
      step1.setAttribute('aria-hidden','true');
      step2.setAttribute('aria-hidden','false');
      // Do geo *when* step 2 becomes visible to avoid races with slow networks
      setGeoDefaults();
      window.scrollTo({top:0,behavior:'smooth'});
    };
    document.getElementById('backBtn').onclick = () => {
      step1.setAttribute('aria-hidden','false');
      step2.setAttribute('aria-hidden','true');
      window.scrollTo({top:0,behavior:'smooth'});
    };

    // ---------- Stripe setup (two-step, safer) ----------
    const TRIAL_INTENT_URL = '/api/stripe/trial-charge-intent';
    const START_MONTHLY_URL = '/api/stripe/start-monthly-after-trial';
    const PUBLISHABLE_KEY = 'pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q';

    // Intro one-time payment config
    const INTRO_AMOUNT_MINOR = 2000; // ¬£20.00 in minor units
    const INTRO_CURRENCY = 'gbp';

    const stripe = Stripe(PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const cardNumber = elements.create('cardNumber');
    const cardExpiry = elements.create('cardExpiry');
    const cardCvc = elements.create('cardCvc');
    cardNumber.mount('#card-number');
    cardExpiry.mount('#card-expiry');
    cardCvc.mount('#card-cvc');

    const $err = document.getElementById('err');
    const overlay = document.getElementById('loading-overlay');
    function showError(m){ $err.textContent=m; $err.style.display='block'; }
    function hideError(){ $err.textContent=''; $err.style.display='none'; }
    function showLoading(){ overlay.setAttribute('aria-hidden','false'); }
    function hideLoading(){ overlay.setAttribute('aria-hidden','true'); }

    function requiredFilled(){
      const a = document.getElementById('addr1').value.trim();
      const c = document.getElementById('city').value.trim();
      const r = document.getElementById('region').value.trim();
      const p = document.getElementById('postal').value.trim();
      const co = document.getElementById('country').value.trim();
      return a && c && r && p && co;
    }

    document.getElementById('payNow').onclick = async () => {
      hideError();
      if (!requiredFilled()){ showError('Please complete your billing address.'); return; }
      showLoading();
      try{
        const address = {
          line1: document.getElementById('addr1').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('region').value.trim(),
          postal_code: document.getElementById('postal').value.trim(),
          country: document.getElementById('country').value.trim()
        };

        // 1) Create PaymentMethod with full billing_details
        const pmRes = await stripe.createPaymentMethod({
          type:'card',
          card: cardNumber,
          billing_details: {
            name: nameInput.value || undefined,
            email: emailInput.value || undefined,
            phone: phoneInput.value?.trim() || undefined,
            address
          }
        });
        if (pmRes.error) throw new Error(pmRes.error.message);
        const paymentMethodId = pmRes.paymentMethod.id;

        // 2) Ask server for an intro PaymentIntent
        const r1 = await fetch(TRIAL_INTENT_URL,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ paymentMethodId, name: nameInput.value, email: emailInput.value, amountMinor: INTRO_AMOUNT_MINOR, currency: INTRO_CURRENCY })
        });
        const d1 = await r1.json();
        if (!r1.ok || !d1.clientSecret) throw new Error(d1.error || 'Failed to create intro charge.');

        // 3) Confirm intro charge (3DS may occur here)
        const conf = await stripe.confirmCardPayment(d1.clientSecret);
        if (conf.error) throw new Error(conf.error.message);
        if (!(conf.paymentIntent && conf.paymentIntent.status === 'succeeded')) throw new Error('Payment not completed');

        // 4) Start the monthly subscription now that we have a successful charge
        const r2 = await fetch(START_MONTHLY_URL,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ paymentIntentId: conf.paymentIntent.id })
        });
        const d2 = await r2.json();
        if (!r2.ok) throw new Error(d2.error || 'Failed to start subscription');

        // 5) Done
        window.location.href = 'thankyou-iphone.html';
      }catch(err){
        showError(err.message || 'Payment failed');
      }finally{
        hideLoading();
      }
    };
  </script>
</body>
</html>
