<script>
  // Use the same publishable key + backend flow as your current page
  const stripe = Stripe("pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  const form = document.getElementById("payment-form");
  const message = document.getElementById("message");
  const submitBtn = document.getElementById("submit");

  const overlay = document.getElementById('loading-overlay');
  function showLoading(){ overlay.setAttribute('aria-hidden','false'); }
  function hideLoading(){ overlay.setAttribute('aria-hidden','true'); }

  // Helper copied from your current checkout (robust JSON parsing on error)
  async function fetchJSON(url, options = {}) {
    const res = await fetch(url, {
      ...options,
      headers: {
        Accept: "application/json",
        ...(options.body ? {"Content-Type":"application/json"} : {}),
        ...(options.headers || {})
      }
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : {}; } catch { data = { error: text || `HTTP ${res.status}` }; }
    if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
    return data;
  }

  // Watch for new 3DS iframes and hide overlay when challenge appears
  let baselineIframes = new Set(Array.from(document.querySelectorAll('iframe')));
  function startThreeDSWatcher(){
    baselineIframes = new Set(Array.from(document.querySelectorAll('iframe')));
    const isThreeDSLike = (iframe) => {
      const t = (iframe.getAttribute('title') || '').toLowerCase();
      return t.includes('3d') || t.includes('secure') || t.includes('authentication') || t.includes('challenge');
    };
    const observer = new MutationObserver((mutations) => {
      for (const m of mutations) {
        for (const node of m.addedNodes) {
          if (node.tagName === 'IFRAME' && !baselineIframes.has(node)) {
            if (isThreeDSLike(node)) {
              const done = () => { hideLoading(); observer.disconnect(); };
              if (node.complete) done(); else node.addEventListener('load', done, { once:true });
              return;
            }
          }
        }
      }
    });
    observer.observe(document.documentElement, { childList:true, subtree:true });
  }

  async function startSubscription(priceId, cardholderName) {
    // Require auth token (same as existing page)
    const token = localStorage.getItem("token");
    if (!token) throw new Error("You’re not signed in. Please refresh and sign in again.");

    // 1) Create SetupIntent on server
    const siData = await fetchJSON("/api/stripe/setup-intent", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` }
    });

    // 2) Confirm card setup (may trigger 3DS)
    const { setupIntent, error } = await stripe.confirmCardSetup(siData.clientSecret, {
      payment_method: {
        card,
        billing_details: { name: cardholderName || "" }
      }
    });
    if (error) throw new Error(error.message);

    // 3) Create subscription with chosen price on server
    const subData = await fetchJSON("/api/stripe/subscribe", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: JSON.stringify({
        priceId,
        paymentMethodId: setupIntent.payment_method,
        cardholderName: cardholderName || ""   // CHANGE #1
      })
    });

    // 4) Handle first invoice SCA (only when required)  // CHANGE #2
    const thankYouUrl = "https://www.charmr.xyz/thankyou.html?priceId=" + encodeURIComponent(priceId);

    if (subData.clientSecret) {
      // Some cards require 3DS; let Stripe do a full-page redirect to thank-you
      const { error: confirmErr } = await stripe.confirmCardPayment(subData.clientSecret, {
        return_url: thankYouUrl
      });
      if (confirmErr) throw new Error(confirmErr.message || "Payment confirmation failed.");
      return; // Stripe will redirect; no further code runs here
    }

    // 5) No payment needed now (trial) → go straight to thank-you
    window.location.href = thankYouUrl;
  } // <-- closes startSubscription; required

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    message.textContent = "";
    message.setAttribute('aria-hidden','true');
    submitBtn.disabled = true;
    showLoading();
    startThreeDSWatcher();

    // Selected plan (radio in the plan cards)
    const selected = document.querySelector('input[name="plan"]:checked');
    const priceId = selected ? selected.value : null;
    const name = document.getElementById("cardholder-name").value;

    try {
      if (!priceId) throw new Error("Please select a plan.");
      await startSubscription(priceId, name);
    } catch (err) {
      console.error(err);
      hideLoading();
      message.textContent = err.message || "Something went wrong. Try again.";
      message.setAttribute('aria-hidden','false');
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
