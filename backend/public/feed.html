<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Chat Feed</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f0f0f0; }
    img.img-thumb { max-width: 120px; max-height: 120px; }
    #status { margin-bottom: 10px; font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <h2>Live Chat Feed</h2>
  <div id="status">Not started</div>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>

  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>User ID</th>
        <th>Girl ID</th>
        <th>Girl Name</th>
        <th>From</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody id="feedBody"></tbody>
  </table>

  <script>
    let timer = null;
    let lastNow = null;

    const BACKEND_URL = window.location.origin; // auto-detect same server
    const OPERATOR_KEY = "YOUR_OPERATOR_KEY_HERE"; // hardcode your key here

    function headersOp() {
      return { 'X-Operator-Key': OPERATOR_KEY };
    }

    function render(rows) {
      const tbody = document.getElementById('feedBody');
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');

        const tdTime = document.createElement('td');
        tdTime.textContent = new Date(r.createdAt).toLocaleString();
        tr.appendChild(tdTime);

        const tdUser = document.createElement('td');
        tdUser.textContent = r.userId;
        tr.appendChild(tdUser);

        const tdGirlId = document.createElement('td');
        tdGirlId.textContent = r.girlId;
        tr.appendChild(tdGirlId);

        const tdGirlName = document.createElement('td');
        tdGirlName.textContent = r.girlName || 'Unknown';
        tr.appendChild(tdGirlName);

        const tdFrom = document.createElement('td');
        tdFrom.textContent = r.from;
        tr.appendChild(tdFrom);

        const tdMsg = document.createElement('td');
        const m = /^IMAGE:\s*(.+)$/i.exec(r.text || "");
        if (m) {
          const img = document.createElement('img');
          img.src = m[1];
          img.className = 'img-thumb';
          tdMsg.appendChild(img);
        } else {
          tdMsg.textContent = r.text;
        }
        tr.appendChild(tdMsg);

        tbody.appendChild(tr);
      }
    }

    async function tick() {
      try {
        const url = `${BACKEND_URL}/api/operator/feed?limit=100${lastNow ? `&since=${lastNow}` : ''}`;
        const res = await fetch(url, { headers: headersOp() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        render(payload.rows);
        lastNow = payload.now;
        document.getElementById('status').textContent = `Last update: ${new Date(lastNow).toLocaleTimeString()}`;
      } catch (e) {
        document.getElementById('status').textContent = `Error: ${e.message}`;
      }
    }

    function start() {
      if (timer) return;
      lastNow = null;
      tick();
      timer = setInterval(tick, 2000);
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    }

    function stop() {
      if (!timer) return;
      clearInterval(timer);
      timer = null;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('startBtn').onclick = start;
      document.getElementById('stopBtn').onclick = stop;
    });
  </script>
</body>
</html>
