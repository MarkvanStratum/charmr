<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Paiement</title>
  <style>
    :root{
      --bg:#ffffff; --text:#0a2540; --muted:#5b6b82; --line:#e3e8ee; --accent:#10b981; --accentText:#fff; --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#ffffff;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .shell{max-width:800px;margin:24px auto 48px;padding:0 16px}

    /* En-t√™te : r√©capitulatif */
    .summarybar{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;background:#f9fafb;padding:14px 18px;margin-bottom:6px}
    .summary-title{font-weight:700;font-size:14px;color:#000;line-height:1.2}
    .summarybar .price{font-weight:900}
    .logos-under{margin:6px 0 12px; padding-left:32px;}
    .summary-logos{max-height:28px;display:block}

    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:none;padding:18px}
    h2{font-size:18px;margin:6px 0 12px}
    .sub{font-size:13px;color:var(--muted);margin:-4px 0 12px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:640px){.grid-2,.grid-3{grid-template-columns:1fr}}

    .label{font-size:13px;font-weight:700;color:#334;margin:6px 0 6px}
    .input,.select,.el{width:100%;background:#fff;border:1px solid #c7d0dd;border-radius:10px;padding:12px;font-size:15px;outline:none}
    .checkbox{display:flex;align-items:center;gap:8px;margin:8px 0 8px;font-size:14px;color:#233}

    .shipping-row{display:flex;align-items:center;justify-content:space-between;border:1px dashed #d7deea;border-radius:10px;background:#f7f9fd;padding:10px 12px;margin:8px 0 12px}

    .btn{width:100%;border:none;border-radius:12px;padding:12px 16px;font-weight:900;font-size:16px;cursor:pointer;background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff;margin-top:12px}
    .footnote{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}

    .err{display:none;background:#fff1f1;border:1px solid #f5bcbc;color:#9a1a1a;padding:10px;border-radius:10px;font-size:14px;margin-top:10px}
    .err[aria-hidden="false"]{display:block}

    /* Overlay de chargement */
    .loading-overlay{position:fixed;inset:0;background:rgba(246,249,252,.92);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay[aria-hidden="false"]{display:flex}
    .loading-box{width:min(92vw,460px);background:#fff;border:1px solid #e6edf5;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px;text-align:center;color:#2a3b55}
    .loading-title{font-weight:800;margin:2px 0 10px;font-size:18px}
    .progress-wrap{width:100%;height:10px;background:#ecf1f8;border-radius:999px;overflow:hidden}
    .progress-bar{width:0%;height:100%;background:linear-gradient(90deg,#22c55e,#60a5fa);animation:loadingBar 2.2s ease-in-out infinite}
    @keyframes loadingBar{0%{width:0%}60%{width:80%}100%{width:100%}}

    /* Num√©ros de section */
    .section{margin-bottom:16px}
    .section > .num{display:inline-block;font-weight:900;margin-right:6px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="summarybar">
      <div class="summary-title">R√©capitulatif de commande</div>
      <div class="price" id="topPrice">9,95&nbsp;‚Ç¨</div>
    </div>
    <!-- Logos sous le bloc r√©capitulatif (pas √† l'int√©rieur) -->
    <div class="logos-under">
      <img class="summary-logos" src="cclogos.png" alt="Logos de cartes : Verified by Visa et MasterCard SecureCode">
    </div>

    <section class="card">
      <!-- 1. Informations de contact -->
      <div class="section">
        <h2><span class="num">1.</span> Informations de contact</h2>
        <div class="grid-2">
          <div>
            <div class="label">Pr√©nom</div>
            <input id="firstName" class="input" autocomplete="given-name" placeholder="Pr√©nom" />
          </div>
          <div>
            <div class="label">Nom</div>
            <input id="lastName" class="input" autocomplete="family-name" placeholder="Nom" />
          </div>
          <div class="grid-span-2">
            <div class="label">Adresse e‚Äëmail</div>
            <input id="email" class="input" type="email" autocomplete="email" placeholder="vous@exemple.com" />
          </div>
        </div>
      </div>

      <!-- 2. Adresse de livraison (utilis√©e aussi comme adresse de facturation) -->
      <div class="section">
        <h2><span class="num">2.</span> Adresse de livraison</h2>
        <div class="label">Adresse</div>
        <input id="shipAddress" class="input" autocomplete="address-line1" placeholder="Adresse" />

        <div class="grid-3" style="margin-top:8px">
          <div>
            <div class="label">Ville</div>
            <input id="shipCity" class="input" autocomplete="address-level2" placeholder="Ville" />
          </div>
          <div>
            <div class="label">√âtat / Province</div>
            <input id="shipState" class="input" autocomplete="address-level1" placeholder="√âtat / Province" />
          </div>
          <div>
            <div class="label">Code postal</div>
            <input id="shipZip" class="input" autocomplete="postal-code" placeholder="Code postal" />
          </div>
        </div>
        <div style="margin-top:8px">
          <div class="label">Num√©ro de t√©l√©phone</div>
          <input id="phone" class="input" inputmode="tel" autocomplete="tel" placeholder="Votre num√©ro" />
        </div>
        <label class="checkbox"><input id="sameAs" type="checkbox" checked /> L‚Äôadresse de facturation est identique √† l‚Äôadresse de livraison</label>
      </div>

      <!-- 3. Mode de livraison (statique) -->
      <div class="section">
        <h2><span class="num">3.</span> Mode de livraison</h2>
        <div class="shipping-row">
          <div>‚Ä¢ Livraison suivie (exp√©dition sous 48&nbsp;h)</div>
          <div style="font-weight:700">Gratuite</div>
        </div>
      </div>

      <!-- 4. Paiement -->
      <div class="section">
        <h2><span class="num">4.</span> Paiement</h2>
        <p class="sub">Toutes les transactions sont s√©curis√©es et chiffr√©es. Propuls√© par Stripe.</p>
        <div class="label">Num√©ro de carte</div>
        <div id="card-number" class="el"></div>
        <div class="grid-2" style="margin-top:10px">
          <div>
            <div class="label">MM / AAAA</div>
            <div id="card-expiry" class="el"></div>
          </div>
          <div>
            <div class="label">CVV</div>
            <div id="card-cvc" class="el"></div>
          </div>
        </div>
      </div>

      <div id="err" class="err" role="alert" aria-hidden="true"></div>
      <button id="orderNow" class="btn">Valider la commande</button>
      <p class="footnote">üîí Transaction s√©curis√©e SSL</p>
    </section>
  </div>

  <!-- Overlay de chargement -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true" style="display:none">
    <div class="loading-box">
      <div class="loading-title">Traitement de votre paiement‚Ä¶</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub" style="margin-top:10px">Veuillez patienter, cela peut prendre quelques secondes.</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <!-- Pr√©remplissage affili√©s : sub1..sub8 -> champs -->
  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const map = {
        sub1: 'firstName',
        sub2: 'lastName',
        sub3: 'email',
        sub4: 'shipAddress',
        sub5: 'shipCity',
        sub6: 'shipState',
        sub7: 'shipZip',
        sub8: 'phone'
      };
      function clean(v){ if(v==null) return v; return v.replace(/\+/g,' '); }
      window.addEventListener('DOMContentLoaded', function(){
        Object.entries(map).forEach(function([key,id]){
          const val = params.get(key);
          if(val!==null){ const el = document.getElementById(id); if(el) el.value = clean(val); }
        });
      });
    })();
  </script>
  <script>
    // ----- M√™me endpoint / cl√©s / flow que atlas.html -----
    const SUBSCRIBE_URL = "https://charmr-jfmc.onrender.com/api/stripe/intro-charge-20"; // m√™me endpoint server.js
    const PUBLISHABLE_KEY = "pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";

    const overlay = document.getElementById('loading-overlay');
    const errBox = document.getElementById('err');
    function showLoading(){overlay.style.display='flex';overlay.setAttribute('aria-hidden','false');}
    function hideLoading(){overlay.setAttribute('aria-hidden','true');overlay.style.display='none';}

    // Init Stripe Elements
    let stripe, elements, cardNumber, cardExpiry, cardCvc;
    if(window.Stripe){
      stripe = Stripe(PUBLISHABLE_KEY);
      elements = stripe.elements();
      cardNumber = elements.create('cardNumber');
      cardExpiry = elements.create('cardExpiry');
      cardCvc    = elements.create('cardCvc');
      cardNumber.mount('#card-number');
      cardExpiry.mount('#card-expiry');
      cardCvc.mount('#card-cvc');
    }

    function nameFrom(first, last){
      return [first||'', last||''].join(' ').trim() || undefined;
    }

    // Indisponibilit√© temporaire
    const UNAVAILABLE_MSG = 'Paiement temporairement indisponible. Veuillez r√©essayer.';

    // Deviner rapidement le pays (facultatif)
    function guessISO(){ const cc=(navigator.language||'').split('-')[1]; return cc?cc.toUpperCase():undefined; }

    async function handlePay(){
      if(!stripe){ alert(UNAVAILABLE_MSG); return; }
      errBox.setAttribute('aria-hidden','true'); errBox.textContent='';
      showLoading();

      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim() || undefined;

      // Livraison = facturation dans cette mise en page en une √©tape
      const address = {
        line1: document.getElementById('shipAddress').value.trim() || undefined,
        city: document.getElementById('shipCity').value.trim() || undefined,
        state: document.getElementById('shipState').value.trim() || undefined,
        postal_code: document.getElementById('shipZip').value.trim() || undefined,
        country: guessISO() // undefined accept√© par le serveur/Stripe
      };

      try{
        // 1) Cr√©er un PaymentMethod (comme atlas)
        const pmRes = await stripe.createPaymentMethod({
          type:'card',
          card: cardNumber,
          billing_details:{ name: nameFrom(first,last), email: email||undefined, phone, address }
        });
        if(pmRes.error) throw new Error(pmRes.error.message);

        // 2) Appeler le m√™me endpoint (server.js) pour d√©marrer le d√©bit
        const resp = await fetch(SUBSCRIBE_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          paymentMethodId: pmRes.paymentMethod.id,
          name: nameFrom(first,last),
          email, phone, address
        })});
        const data = await resp.json();
        if(!data.clientSecret) throw new Error(data.error || 'Le paiement n\'a pas pu d√©marrer');

        // 3) Confirmer le PaymentIntent (g√®re l\'SCA)
        const conf = await stripe.confirmCardPayment(data.clientSecret);
        if(conf.error) throw new Error(conf.error.message);
        if(!(conf.paymentIntent && conf.paymentIntent.status==='succeeded')) throw new Error('Paiement non finalis√©');

        // 4) Redirection ‚Äì conserver la r√©partition 60/40 d'atlas.html
        (function(){
          const A = 'thankyou-iphone.html';
          const B = 'thankyou-iphone-skip.html';
          const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';
          function fnv1a32(str){ let h=0x811c9dc5>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,0x01000193)>>>0; } return h>>>0; }
          function cryptoRandInt(max){ try{ const u32=new Uint32Array(1); crypto.getRandomValues(u32); return Number(u32[0]%BigInt(max)); }catch{ return Math.floor(Math.random()*max); } }
          const bucket = pid ? (fnv1a32(pid)%100) : cryptoRandInt(100);
          const goSkip = bucket < 60; // 60% vers thankyou-iphone.html
          const qb = pid ? ('?v='+encodeURIComponent(pid)) : ('?t='+Date.now());
          window.location.href = (goSkip?B:A) + qb;
        })();
      }catch(err){
        errBox.textContent = err.message || 'Une erreur est survenue.';
        errBox.setAttribute('aria-hidden','false');
        hideLoading();
      }
      // En cas de succ√®s, on garde l'overlay jusqu'√† la redirection / 3DS
    }

    document.getElementById('orderNow').addEventListener('click', handlePay);
  </script>

  <!-- Chargeur GoAffPro (conserv√©, conforme √† l'int√©gration atlas.html) -->
  <script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>
</body>
</html>
