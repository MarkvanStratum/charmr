<!-- Same up to your <script> tag -->
<script src="https://js.stripe.com/v3/"></script> <!-- Include Stripe JS -->

<script>
  const backendUrl = "https://charmr-jfmc.onrender.com"; 
  const token = localStorage.getItem("token");

  if (!token) {
    window.location.href = "login.html";
  }

  const stripe = Stripe("pk_test_XXXXXXXXXXXXXXXXXXXXXXXX"); // Replace with your real Stripe public key

  const params = new URLSearchParams(window.location.search);
  const girlId = parseInt(params.get('id'));
  const girl = girls.find(g => g.id === girlId);

  const chatBox = document.getElementById('chatBox');
  document.getElementById('chatName').textContent = girl.name;
  document.getElementById('chatPhoto').src = girl.image;

  function appendMessage(text, sender, isTyping = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}`;
    msgDiv.textContent = text;
    if (isTyping) msgDiv.classList.add('typing');
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    return msgDiv;
  }

  function randomDelay(min = 700, max = 2000) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  async function loadMessages() {
    try {
      const res = await fetch(`${backendUrl}/api/messages/${girlId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      chatBox.innerHTML = "";
      data.forEach(msg => appendMessage(msg.text, msg.from_user ? "user" : "girl"));
    } catch (err) {
      console.error("Error loading messages:", err);
    }
  }

  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const messageText = input.value.trim();
    if (!messageText) return;

    appendMessage(messageText, 'user');
    input.value = '';
    const typingBubble = appendMessage("...", 'girl', true);

    try {
      const res = await fetch(`${backendUrl}/api/chat`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ girlId, message: messageText })
      });

      if (res.status === 403) {
        const data = await res.json();
        typingBubble.remove();

        appendMessage(data.error || "You're out of credits!", 'girl');

        const btn = document.createElement("button");
        btn.textContent = "🔁 Buy More Credits";
        btn.style.marginTop = "10px";
        btn.style.background = "#ef476f";
        btn.style.color = "white";
        btn.style.border = "none";
        btn.style.padding = "8px 12px";
        btn.style.borderRadius = "6px";
        btn.style.cursor = "pointer";
        btn.onclick = async () => {
          try {
            const res = await fetch(`${backendUrl}/api/create-checkout-session`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({
                priceId: "price_1RsdzREJXIhiKzYG45b69nSl", // your £20 subscription
                mode: "subscription"
              })
            });

            const session = await res.json();
            if (session.url) {
              window.location.href = session.url;
            } else {
              alert("Could not start payment. Please try again.");
            }
          } catch (err) {
            console.error("Payment error:", err);
            alert("Something went wrong.");
          }
        };

        chatBox.appendChild(btn);
        chatBox.scrollTop = chatBox.scrollHeight;
        return;
      }

      const data = await res.json();
      await new Promise(resolve => setTimeout(resolve, randomDelay()));
      typingBubble.remove();

      appendMessage(data.reply || "(No reply received)", 'girl');
    } catch (err) {
      console.error("Chat error:", err);
      typingBubble.remove();
    }
  }

  loadMessages();
</script>
