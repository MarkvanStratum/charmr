<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0e0f; --panel:#111114; --block:#15151a; --text:#fff; --muted:#c8cad2;
    --stroke:rgba(255,255,255,.08); --accent:#ffb62c; --accent2:#ffad0f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#0a0a0b; color:var(--text)}
  .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px}
  .sheet{width:min(980px,96vw); height:min(90vh,780px); background:#111114; border-radius:16px; display:flex; flex-direction:column; box-shadow:0 24px 80px rgba(0,0,0,.6)}
  .header{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--stroke)}
  .header h1{margin:0; font-size:22px}
  .header .total{color:#e8e9ee; font-weight:700}
  .closeX{cursor:pointer; opacity:.85}
  .body{flex:1; overflow:auto; padding:22px}
  .stack{max-width:520px; margin:0 auto; display:flex; flex-direction:column; gap:18px}
  .block{background:#15151a; border-radius:16px; padding:18px; box-shadow:0 0 0 1px var(--stroke)}
  .block h3{margin:0 0 12px; font-size:18px}

  /* Mount target for Stripe PRB (unstyled) */
  #gpay-button{ display:block; height:44px; }

  /* Branded fallback only shown if PRB not available */
  .gpay-fallback{
    display:none; width:100%; height:44px;
    border-radius:12px; border:1px solid #2b2b2f; background:#000;
    align-items:center; justify-content:center; gap:8px;
  }
  .gpay-fallback img{ height:18px; display:block }

  .btn-gpay{display:flex; align-items:center; justify-content:center; font-weight:800; border-radius:12px; padding:14px 16px}
  .btn-gpay{
    background:#000; color:#fff; border:1px solid #2b2b2f;
    padding:10px 16px; border-radius:12px; height:44px;
  }
  .btn-gpay img{height:18px; display:block}
  .brands{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .right-note{margin-left:auto; opacity:.9}
  .stripe{color:#635bff; font-weight:800}
  .label{font-weight:600; font-size:14px; color:#e2e3ea; margin:8px 0 6px}
  .input{width:100%; background:#0f0f12; color:#fff; border:1px solid #23232a; border-radius:12px; padding:14px 12px; outline:none}
  .input:focus{border-color:#3a3a44}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .cta{width:100%; padding:14px; border:none; border-radius:12px; font-weight:800; color:#111; background:linear-gradient(180deg,#ffc640,#ffad0f)}
  .note{color:#b8bac4; font-size:13px}
  .error{background:#2a1214; color:#ffb4b4; border:1px solid #7a1c1c; border-radius:10px; padding:10px 12px; display:none}
  .hidden{display:none}
  .el{background:#0f0f12; border:1px solid #23232a; border-radius:12px; padding:14px 12px}
  .el-focus{border-color:#3a3a44}

  /* Loading overlay */
  .loading-overlay{
    position:fixed; inset:0; background:rgba(255,255,255,.92);
    display:none; align-items:center; justify-content:center; flex-direction:column;
    z-index:9999; backdrop-filter:saturate(1.1) blur(2px);
  }
  .loading-overlay[aria-hidden="false"]{ display:flex }
  .loading-box{
    width:min(92vw,420px); background:#fff; border:1px solid #e5e7eb; border-radius:14px;
    box-shadow:0 10px 28px rgba(239,71,111,.12); padding:18px; text-align:center; color:#111;
  }
  .loading-title{ font-weight:900; letter-spacing:.3px; margin:2px 0 10px; }
  .progress-wrap{ width:100%; height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #e5e7eb; }
  .progress-bar{
    width:0%; height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2));
    animation: loadingBar 2.2s ease-in-out infinite;
  }
  @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }
  .loading-sub{ font-size:12px; color:#555; margin-top:8px }
</style>
</head>
<body>
  <div class="wrap">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="coTitle">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <span class="closeX" onclick="history.back()">✕</span>
          <h1 id="coTitle">Checkout</h1>
        </div>
      </div>

      <div class="body">
        <div class="stack">
          <div class="block">
            <h3>Fast Payments</h3>
            <!-- Real Stripe PRB mount point -->
            <div id="gpay-button" aria-label="Google Pay"></div>
            <!-- Branded fallback (shown only if PRB unavailable) -->
            <button id="gpay-fallback" type="button" class="gpay-fallback" aria-disabled="true">
              <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay" />
            </button>
          </div>

          <div class="block">
            <h3>Credit card</h3>
            <div class="brands">
              <img alt="visa" src="/logos/visa.png" style="height:18px">
<img alt="mc"   src="/logos/mc2.png" style="height:18px">
<img alt="amex" src="/logos/amex.png" style="height:18px">

              <span class="right-note">Secured by <span class="stripe">stripe</span></span>
            </div>

            <!-- New: Cardholder name -->
            <div class="label">Name on card</div>
            <input class="input" id="nameInput" placeholder="Full name" autocomplete="cc-name">

            <div class="label">Card number</div>
            <div id="card-number" class="el"></div>

            <div class="grid2">
              <div>
                <div class="label">Expiration date</div>
                <div id="card-expiry" class="el"></div>
              </div>
              <div>
                <div class="label">Security code</div>
                <div id="card-cvc" class="el"></div>
              </div>
            </div>
          </div>

          <div id="err" class="error"></div>

          <button class="cta" id="payNow">Complete Payment</button>

          <div class="note">Your card is processed securely on this page. If 3-D Secure is required, a quick verification will pop up.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-label="Processing payment">
    <div class="loading-box" role="status">
      <div class="loading-title">Processing your payment…</div>
      <div class="progress-wrap" aria-hidden="true"><div class="progress-bar"></div></div>
      <div class="loading-sub">You may be asked to complete a quick 3-D Secure check. Please don’t close this window.</div>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
  // ====== CONFIG ======
  const SUBSCRIBE_URL = "https://charmr-jfmc.onrender.com/api/stripe/subscribe-notrial";
  const PUBLISHABLE_KEY = "pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";

  const PRICE_IDS = {
    month:   "price_1Rzdp0EJXIhiKzYGlVxHGH7W",
    quarter: "price_1RzdrwEJXIhiKzYGdWE0hxhU",
    year:    "price_1RzdpXEJXIhiKzYGOyrmUiQU"
  };
  const PLAN_TOTALS = { month:20, quarter:44, year:120 };

  let selectedPlan = sessionStorage.getItem("selectedPlan") || "quarter";

  // Init Stripe + Elements
  const stripe = Stripe(PUBLISHABLE_KEY);
  const elements = stripe.elements({
    appearance: {
      theme: 'night',
      variables: { colorText:'#fff', colorBackground:'#0f0f12', colorPrimary:'#ffad0f', colorIcon:'#c9ccd6' }
    }
  });
  const style = { classes: { focus: 'el-focus' } };

  const cardNumber = elements.create('cardNumber', style);
  const cardExpiry = elements.create('cardExpiry', style);
  const cardCvc    = elements.create('cardCvc', style);
  cardNumber.mount('#card-number'); cardExpiry.mount('#card-expiry'); cardCvc.mount('#card-cvc');

  /* ---------- Google Pay / Payment Request Button ---------- */
  function guessCountry() {
    try {
      const loc = Intl.DateTimeFormat().resolvedOptions().locale || '';
      const part = loc.split('-')[1];
      if (part && part.length === 2) return part.toUpperCase();
    } catch {}
    return 'US';
  }

  const amountMinor = Math.round(
    (PLAN_TOTALS[selectedPlan] ?? PLAN_TOTALS.quarter) * 100
  );

  const paymentRequest = stripe.paymentRequest({
    country: guessCountry(),
    currency: 'gbp',
    total: { label: 'Charmr.xyz', amount: amountMinor },
    requestPayerEmail: false,
    requestPayerName: true  // also ask wallet for a name when available
  });

  const prButton = elements.create('paymentRequestButton', {
    paymentRequest,
    style: { paymentRequestButton: { type: 'buy', theme: 'dark', height: '44px' } }
  });

  paymentRequest.canMakePayment().then(result => {
    const mount = document.getElementById('gpay-button');
    const fallback = document.getElementById('gpay-fallback');

    if (result) {
      prButton.mount('#gpay-button');
      if (fallback) fallback.style.display = 'none';
      if (mount) mount.style.display = 'block';
    } else {
      if (mount) mount.style.display = 'none';
      if (fallback) {
        fallback.style.display = 'flex';
        fallback.addEventListener('click', () => {
          alert("Google Pay isn't available on this device or browser right now. Please use your card below.");
        }, { once:true });
      }
    }
  });

  paymentRequest.on('paymentmethod', async (ev) => {
    try {
      const name = (document.getElementById('nameInput')?.value || '').trim();

      const res = await fetch(SUBSCRIBE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          priceId: PRICE_IDS[selectedPlan] || PRICE_IDS.year,
          paymentMethodId: ev.paymentMethod.id,
          name // forward to backend so it can set Customer/PM name
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.clientSecret) {
        throw new Error(data?.error || 'Server error creating subscription');
      }

      const { error, paymentIntent } = await stripe.confirmCardPayment(
        data.clientSecret,
        { payment_method: ev.paymentMethod.id }
      );

      if (error) {
        ev.complete('fail');
        showError(error.message || 'Payment could not be completed.');
        return;
      }

      ev.complete('success');
      if (paymentIntent && paymentIntent.status === 'succeeded') {
        window.location.href = 'thankyou2.html';
      } else {
        showError('Payment not completed. Status: ' + (paymentIntent?.status || 'unknown'));
      }
    } catch (e) {
      ev.complete('fail');
      showError(e.message || 'Payment failed.');
    }
  });
  /* ---------- End Google Pay section ---------- */

  const $err = document.getElementById('err');
  function showError(msg){ $err.textContent = msg; $err.style.display = 'block'; }
  function clearError(){ $err.style.display='none'; $err.textContent=''; }

  // Loading helpers
  const overlay = document.getElementById('loading-overlay');
  function showLoading(){ overlay && overlay.setAttribute('aria-hidden','false'); }
  function hideLoading(){ overlay && overlay.setAttribute('aria-hidden','true'); }
  let baselineIframes = new Set();
  function startThreeDSWatcher(){
    baselineIframes = new Set(Array.from(document.querySelectorAll('iframe')));
    const isThreeDSLike = (iframe) => {
      const t = (iframe.getAttribute('title') || '').toLowerCase();
      return t.includes('3d') || t.includes('secure') || t.includes('authentication') || t.includes('challenge');
    };
    const observer = new MutationObserver((mutations) => {
      for (const m of mutations) {
        for (const node of m.addedNodes) {
          if (node.tagName === 'IFRAME' && !baselineIframes.has(node)) {
            if (isThreeDSLike(node)) {
              const done = () => { hideLoading(); observer.disconnect(); };
              if (node.complete) done(); else node.addEventListener('load', done, { once:true });
              return;
            }
          }
        }
      }
    });
    observer.observe(document.documentElement, { childList:true, subtree:true });
  }

  document.getElementById('payNow').addEventListener('click', async ()=>{
    clearError();

    const urlPlan = new URLSearchParams(location.search).get('plan');
    if(urlPlan) { selectedPlan = urlPlan; sessionStorage.setItem('selectedPlan', selectedPlan); }

    showLoading();
    startThreeDSWatcher();

    let pm;
    try{
      const name = (document.getElementById('nameInput')?.value || '').trim();

      const pmRes = await stripe.createPaymentMethod({
        type:'card',
        card: cardNumber,
        billing_details: { name }
      });
      if(pmRes.error) throw pmRes.error;
      pm = pmRes.paymentMethod;
    }catch(e){
      hideLoading();
      showError(e.message || 'Card details are invalid.'); return;
    }

    let clientSecret;
    try{
      const name = (document.getElementById('nameInput')?.value || '').trim();

      const res = await fetch(SUBSCRIBE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          priceId: PRICE_IDS[selectedPlan] || PRICE_IDS.year,
          paymentMethodId: pm.id,
          name
        })
      });

      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const preview = await res.text().catch(()=> '');
        throw new Error(`Server returned non-JSON (${res.status}). Check route. Preview: ${preview.slice(0,120)}…`);
      }
      const data = await res.json();

      if(!res.ok){ throw new Error(data?.error || 'Server error creating subscription'); }
      clientSecret = data.clientSecret;
      if(!clientSecret){ throw new Error('No clientSecret returned by server'); }
    }catch(e){
      hideLoading();
      showError(e.message); return;
    }

    const {paymentIntent, error} = await stripe.confirmCardPayment(clientSecret);
    if(error){ hideLoading(); showError(error.message || 'Payment could not be completed.'); return; }

    if(paymentIntent && paymentIntent.status === 'succeeded'){
      window.location.href = 'thankyou2.html';
    }else{
      hideLoading();
      showError('Payment not completed. Status: ' + (paymentIntent?.status || 'unknown'));
    }
  });
  </script>
</body>
</html>
