<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Justsignup</title>
  <!-- analytics + styles unchanged ... -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    /* ... your existing styles ... */
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .input{ width:100%; padding:12px; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px; font-size:16px; }
    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; }
    @media (max-width:520px){ .phone-wrap{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <!-- promo modal unchanged -->

  <div class="shell">
    <!-- STEP 1 -->
    <section id="step1" class="card step" aria-hidden="false">
      <h1 class="title">Girls looking for hookups!!</h1>
      <p class="sub">On time offer: Full Premium Access for $2.50!</p>

      <div class="video-wrap" aria-label="AI girlfriend video">
        <video src="video1.mp4" autoplay loop muted playsinline preload="metadata"></video>
      </div>

      <div id="pricing" class="pricing" style="margin-top:14px">
        <span class="was"><span data-price="99" data-precision="0">$99</span></span>
        <span class="now">Now <span data-price="2.5" data-precision="2">$2.50</span></span>
        <span class="save">Save 97%</span>
      </div>

      <div class="lifetime-offer">ONE TIME OFFER: LIFE TIME ACCESS</div>

      <!-- ✨ ADDED: address inputs (kept simple & optional except country + postal) -->
      <div class="grid" style="margin-top:10px">
        <input class="input" id="nameInput" placeholder="Full name" autocomplete="name" required />
        <input class="input" id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" required />

        <input class="input" id="passwordInput" type="password" placeholder="Create a password" autocomplete="new-password" required style="grid-column: 1 / -1;" />

        <div class="phone-wrap" style="grid-column: 1 / -1;">
          <select id="phonePrefix" class="input" aria-label="Country calling code"></select>
          <input id="phoneNumber" class="input" inputmode="tel" placeholder="Phone number" autocomplete="tel-national" />
        </div>

        <!-- Country + Postal Code -->
        <select id="country" class="input" autocomplete="country" required>
          <option value="">Country</option>
          <!-- populated by JS using IP (falls back to US) -->
        </select>
        <input id="postal" class="input" placeholder="ZIP / Postal code" autocomplete="postal-code" required />

        <!-- Address line 1 + City -->
        <input id="addr1" class="input" placeholder="Address line 1" autocomplete="address-line1" style="grid-column: 1 / -1;" />
        <input id="city" class="input" placeholder="City" autocomplete="address-level2" />
        <input id="region" class="input" placeholder="State / Region" autocomplete="address-level1" />
      </div>

      <!-- hidden defaults for /api/register -->
      <input type="hidden" id="gender" value="nonbinary"/>
      <input type="hidden" id="lookingFor" value="any"/>
      <input type="hidden" id="phone" value=""/>

      <div class="btn-row">
        <button id="nextBtn" class="btn">Next step →</button>
      </div>
      <p class="trust-text">We’ll never share your email. 100% privacy guaranteed.</p>
    </section>

    <!-- STEP 2 (unchanged UI) -->
    <section id="step2" class="card step" aria-hidden="true">
      <h2 class="title">Secure Payment</h2>
      <p class="sub">Your details are safe — powered by Stripe.</p>
      <!-- features & elements ... unchanged -->
      <div id="gpay-button"></div>
      <div class="label">Card number</div>
      <div id="card-number" class="el"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <div class="label">Expiration</div>
          <div id="card-expiry" class="el"></div>
        </div>
        <div>
          <div class="label">CVC</div>
          <div id="card-cvc" class="el"></div>
        </div>
      </div>

      <div id="err" role="alert" aria-hidden="true"></div>

      <div class="btn-row">
        <button id="backBtn" class="btn muted-btn">← Back</button>
        <button class="btn" id="payNow">Unlock Her Now</button>
      </div>

      <!-- brand logos + trust text unchanged -->
    </section>
  </div>

  <!-- loading overlay unchanged -->

  <script src="https://js.stripe.com/v3"></script>
  <script>
    /* ---------- Step navigation ---------- */
    const step1=document.getElementById('step1'),step2=document.getElementById('step2');
    const nameInput=document.getElementById('nameInput');
    const emailInput=document.getElementById('emailInput');
    const passwordInput=document.getElementById('passwordInput');

    // helper to read assembled phone for both steps
    function getFullPhone(){
      const raw = (document.getElementById('phoneNumber')?.value||'').replace(/[^\d]/g,'');
      const pref = (document.getElementById('phonePrefix')?.value||'+1').trim();
      return raw ? (pref + raw) : "";
    }

    async function ensureAccount() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { throw new Error("Please enter email and password."); }

      // ensure hidden phone is assembled for /api/register
      document.getElementById('phone').value = getFullPhone();

      const payload = {
        email,
        password,
        gender: document.getElementById('gender').value || "nonbinary",
        lookingFor: document.getElementById('lookingFor').value || "any",
        phone: document.getElementById('phone').value || ""
      };

      const res = await fetch("/api/register", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      if (res.status === 201) return true;
      const data = await res.json().catch(()=>({}));
      if (res.status === 400 && data && /exists/i.test(data.error||"")) return true;
      throw new Error(data?.error || "Could not create account");
    }

    document.getElementById('nextBtn').onclick=async()=>{ 
      if(!nameInput.value||!emailInput.value||!passwordInput.value){alert("Please enter your details");return}
      try { await ensureAccount(); } catch(e){ alert(e.message); return; }
      localStorage.setItem("checkout_name",nameInput.value);
      localStorage.setItem("checkout_email",emailInput.value);
      step1.setAttribute("aria-hidden","true");
      step2.setAttribute("aria-hidden","false");
      window.scrollTo({top:0,behavior:'smooth'});
    };

    document.getElementById('backBtn').onclick=()=>{ 
      step1.setAttribute("aria-hidden","false");
      step2.setAttribute("aria-hidden","true");
      window.scrollTo({top:0,behavior:'smooth'});
    };

    /* ---------- Currency symbol by IP (unchanged) ---------- */
    (function setCurrencyByIP(){ /* ... unchanged ... */ })();

    /* ---------- Phone prefix by IP (unchanged list) ---------- */
    (function phonePrefixByIP(){ /* ... unchanged ... */ })();

    /* ---------- Country select by IP (NEW) ---------- */
    (function countryByIP(){
      const countryEl = document.getElementById('country');
      const opts = new Intl.DisplayNames([navigator.language||'en'], { type: 'region' });
      const common = ['US','GB','CA','AU','IE','NZ','DE','FR','NL','SE','NO','IT','ES'];
      function add(cc, selected=false){
        const name = opts.of(cc) || cc;
        const o = new Option(`${name} (${cc})`, cc, selected, selected);
        countryEl.append(o);
      }
      // prime with some popular choices
      common.forEach((cc,i)=>add(cc, i===0));
      // try to set from IP
      fetch('https://ipapi.co/json/')
        .then(r=>r.ok?r.json():Promise.reject())
        .then(d=>{
          const cc=(d && (d.country||d.country_code)||'US').toUpperCase();
          countryEl.value = cc;
          if(!Array.from(countryEl.options).some(o=>o.value===cc)) add(cc,true);
        })
        .catch(()=>{ /* keep defaults */ });
    })();

    /* ---------- Stripe logic (trial → monthly) ---------- */
    const TRIAL_INTENT_URL="https://charmr-jfmc.onrender.com/api/stripe/trial-charge-intent";
    const START_MONTHLY_URL="https://charmr-jfmc.onrender.com/api/stripe/start-monthly-after-trial";
    const PUBLISHABLE_KEY="pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";

    const stripe=Stripe(PUBLISHABLE_KEY),elements=stripe.elements();
    const cardNumber=elements.create("cardNumber"),cardExpiry=elements.create("cardExpiry"),cardCvc=elements.create("cardCvc");
    cardNumber.mount("#card-number");cardExpiry.mount("#card-expiry");cardCvc.mount("#card-cvc");

    const $err=document.getElementById("err"),overlay=document.getElementById("loading-overlay");
    function showError(m){$err.textContent=m;$err.style.display="block"}
    function hideError(){$err.textContent="";$err.style.display="none"}
    function showLoading(){overlay.setAttribute("aria-hidden","false")}
    function hideLoading(){overlay.setAttribute("aria-hidden","true")}

    document.getElementById("payNow").onclick=async()=>{
      hideError();showLoading();
      try{
        // Build billing details (✨ includes phone + address now)
        const billing = {
          name: nameInput.value,
          email: emailInput.value,
          phone: getFullPhone() || undefined,
          address: {
            line1: (document.getElementById('addr1').value||'').trim() || undefined,
            city: (document.getElementById('city').value||'').trim() || undefined,
            state: (document.getElementById('region').value||'').trim() || undefined,
            postal_code: (document.getElementById('postal').value||'').trim() || undefined,
            country: (document.getElementById('country').value||'').trim() || undefined
          }
        };

        // 1) Create a PaymentMethod from Elements with full billing_details
        const pmRes = await stripe.createPaymentMethod({
          type:"card",
          card:cardNumber,
          billing_details: billing
        });
        if(pmRes.error){ throw new Error(pmRes.error.message); }
        const paymentMethodId = pmRes.paymentMethod.id;

        // 2) Tell your server to create the intro-charge PaymentIntent
        const r1 = await fetch(TRIAL_INTENT_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentMethodId,
            name: billing.name,
            email: billing.email
            // phone/address are already on the PaymentMethod.billing_details
          })
        });
        const d1 = await r1.json();
        if(!r1.ok || !d1.clientSecret){ 
          throw new Error(d1.error || "Payment failed while creating the intro charge."); 
        }

        // 3) Confirm the intro charge
        const conf = await stripe.confirmCardPayment(d1.clientSecret);
        if(conf.error){ throw new Error(conf.error.message); }
        if(!(conf.paymentIntent && conf.paymentIntent.status==="succeeded")){
          throw new Error("Payment not completed");
        }

        // 4) Start the monthly subscription
        const r2 = await fetch(START_MONTHLY_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            paymentIntentId: conf.paymentIntent.id
          })
        });
        const d2 = await r2.json();
        if(!r2.ok){ throw new Error(d2.error || "Failed to start subscription"); }

        // 5) Success!
        window.location.href="thankyou2.html";
      }catch(err){
        showError(err.message || "Payment failed");
      }finally{
        hideLoading();
      }
    };

    /* ---------- Promo modal (unchanged) ---------- */
    (function promoModal(){ /* ... unchanged ... */ })();
  </script>
</body>
</html>
