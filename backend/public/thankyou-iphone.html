<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You iphone</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    // GA4 init
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>

  <!-- GoAffPro loader -->
  <script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f7fa;
      font-family: Arial, sans-serif;
      color: #333;
    }
    .thankyou-box {
      text-align: center;
      background: #fff;
      padding: 40px 60px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .thankyou-box h1 { font-size: 28px; margin-bottom: 15px; color: #2c3e50; }
    .thankyou-box p { font-size: 16px; color: #555; }
    .muted { color:#888; font-size:12px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="thankyou-box">
    <h1>Thank you for your order.</h1>
    <p>You will be contacted shortly with the details.</p>
    <p class="muted" id="dbg"></p>
  </div>

  <!-- GoAffPro conversion pixel (fires once per order) -->
  <script>
  (function () {
    function qp(name){
      var m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
      return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
    }

    var ORDER_NUMBER = qp('order');          // required
    var TOTAL_RAW    = qp('total');
    var CURRENCY     = (qp('cur') || 'USD').toUpperCase();

    var ORDER_TOTAL = (TOTAL_RAW !== '' && !isNaN(+TOTAL_RAW)) ? +TOTAL_RAW : null;

    if (!ORDER_NUMBER) {
      console.warn('[GoAffPro] Missing order id → not posting.');
      document.getElementById('dbg')?.append('(no order id; not posting)');
      return;
    }

    if (ORDER_TOTAL === null) {
      console.warn('[GoAffPro] Missing total; defaulting to 0.01 for safety.');
      ORDER_TOTAL = 0.01;
    }

    var STORAGE_KEY = 'gaffpro_fired_' + ORDER_NUMBER;
    var RENDER_FLAG = '__gaffpro_fired_this_render';

    function alreadyFired() {
      try {
        return sessionStorage.getItem(STORAGE_KEY) === '1' || localStorage.getItem(STORAGE_KEY) === '1';
      } catch (e) {
        return false;
      }
    }
    function markFired() {
      try {
        sessionStorage.setItem(STORAGE_KEY, '1');
        localStorage.setItem(STORAGE_KEY, '1');
      } catch (e) {}
    }

    if (window[RENDER_FLAG] || alreadyFired()) {
      console.log('[GoAffPro] Already posted for', ORDER_NUMBER, '— skipping.');
      document.getElementById('dbg')?.append(' (already posted; skipped)');
      return;
    }

    window.goaffproOrder = {
      number: ORDER_NUMBER,
      total: ORDER_TOTAL,
      currency: CURRENCY
    };

    function tryFire() {
      if (window[RENDER_FLAG]) return true;
      if (typeof window.goaffproTrackConversion !== 'function') return false;

      if (alreadyFired()) {
        console.log('[GoAffPro] Already posted (race) for', ORDER_NUMBER, '— skipping.');
        return true;
      }

      window[RENDER_FLAG] = true;
      window.goaffproTrackConversion(window.goaffproOrder);
      markFired();
      console.log('[GoAffPro] Posted once for', ORDER_NUMBER, window.goaffproOrder);
      return true;
    }

    if (document.visibilityState === 'prerender') {
      document.addEventListener('visibilitychange', function onv(){
        if (document.visibilityState === 'visible') {
          document.removeEventListener('visibilitychange', onv);
          (tryFire() || poll());
        }
      });
    } else {
      (tryFire() || poll());
    }

    function poll() {
      var tries = 0, iv = setInterval(function(){
        if (tryFire() || ++tries > 60) clearInterval(iv);
      }, 150);
    }

    var dbgEl = document.getElementById('dbg');
    if (dbgEl) dbgEl.textContent =
      'GoAffPro payload → number: ' + ORDER_NUMBER +
      ', total: ' + ORDER_TOTAL +
      ', currency: ' + CURRENCY;
  })();
  </script>
</body>
</html>
