<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>iPhone Thank You | Charmr</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .container { background:white; padding:2rem 3rem; text-align:center; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    p { font-size:1.25rem; margin:0; color:#111827; }
  </style>

  <!-- ====== GOAFFPRO GATE: strict alternating TRACK/SKIP ====== -->
  <script>
    (function(){
      const KEY = "gaffpro_track_counter";
      let memCounter = 0; // fallback if localStorage is blocked
      let firedThisPage = false; // in-page duplicate guard (no session-wide suppression)

      function safeGetCounter(){
        try {
          const raw = localStorage.getItem(KEY);
          return raw == null ? 0 : (parseInt(raw, 10) || 0);
        } catch(e) {
          return memCounter | 0;
        }
      }
      function safeSetCounter(v){
        try { localStorage.setItem(KEY, String(v)); }
        catch(e){ memCounter = v | 0; }
      }

      // TRACK on odd, SKIP on even — deterministic alternation across page loads in this browser
      function shouldTrackNext(){
        let c = safeGetCounter();
        c += 1;
        safeSetCounter(c);
        return (c % 2) === 1;
      }

      // Intercept assignment so the first fire is always gated
      Object.defineProperty(window, "goaffproTrackConversion", {
        configurable: true,
        enumerable: true,
        set(fn){
          if (typeof fn === "function") {
            const original = fn;
            const wrapped = function(payload){
              if (firedThisPage) {
                console.log("[GoAffPro Gate] Already fired on this page; skipping duplicate.");
                return;
              }
              if (shouldTrackNext()) {
                console.log("[GoAffPro Gate] TRACK (alternating).");
                firedThisPage = true;
                return original.apply(this, arguments);
              } else {
                console.log("[GoAffPro Gate] SKIP (alternating).");
                firedThisPage = true; // mark so we don't attempt again this render
              }
            };
            Object.defineProperty(window, "goaffproTrackConversion", {
              value: wrapped,
              writable: false,
              configurable: true,
              enumerable: true
            });
            window.__goaffproTrackConversionOriginal = original; // for debugging
            console.log("[GoAffPro Gate] Alternating gate installed (track/skip/track/skip).");
          } else {
            Object.defineProperty(window, "goaffproTrackConversion", {
              value: fn,
              writable: true,
              configurable: true,
              enumerable: true
            });
          }
        },
        get(){ return undefined; }
      });

      // Simple waiter that runs a callback once the wrapped function exists
      window.__ensureGaffproPatched = function(cb){
        (function wait(){
          if (typeof window.goaffproTrackConversion === "function" &&
              typeof window.__goaffproTrackConversionOriginal === "function") {
            cb();
          } else {
            setTimeout(wait, 100);
          }
        })();
      };
    })();
  </script>
  <!-- ====== END GATE ====== -->
</head>
<body>
  <div class="container">
    <p>Thank you for your order. You’ll be contacted shortly with the details.</p>
  </div>

  <!-- Load GoAffPro AFTER the gate so we always wrap it -->
  <script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

  <script>
    // ---- helpers ----
    function uniqueOrderId() {
      const ts = Date.now();
      const rand = Math.random().toString(16).slice(2, 6);
      return `ORD-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${ts}-${rand}`;
    }

    // GEO-BASED AMOUNT: US/GB/AU/NZ => $30, others => $10
    async function resolveGeoAmount() {
      const preferred = ["US","GB","AU","NZ"];
      let code = "";
      try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 2500);
        const resp = await fetch("https://ipapi.co/json/", { signal: controller.signal });
        clearTimeout(timer);
        if (resp.ok) {
          const data = await resp.json();
          code = (data && (data.country_code || data.country) || "").toString().toUpperCase();
        }
      } catch(e) { /* default below */ }
      return preferred.includes(code) ? 30 : 10;
    }

    // Build an order every load (no sessionStorage suppression)
    (async function () {
      const saleAmount = await resolveGeoAmount();

      window.goaffpro_order = {
        number: uniqueOrderId(),
        total: saleAmount,
        currency: "USD"
      };

      // Fire ONLY after the gate-wrapped function exists
      __ensureGaffproPatched(function(){
        console.log("GoAffPro: firing conversion", window.goaffpro_order);
        window.goaffproTrackConversion(window.goaffpro_order);
      });
    })();
  </script>
</body>
</html>
