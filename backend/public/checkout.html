<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #card-element { border: 1px solid #ccc; padding: 10px; border-radius: 4px; }
    button { margin-top: 15px; padding: 10px 20px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Checkout</h2>

  <label for="cardholder-name">Cardholder Name</label><br>
  <input id="cardholder-name" type="text" placeholder="Your name"><br><br>

  <div id="card-element"></div>

  <button id="subscribe-5">Subscribe £5</button>
  <button id="subscribe-20">Subscribe £20</button>
  <button id="subscribe-99">Subscribe £99</button>

  <script>
    const stripe = Stripe("YOUR_PUBLISHABLE_KEY"); // replace with your real publishable key
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    async function startSubscription(priceId, cardholderName) {
      const TRIAL_ELIGIBLE = new Set([
        "price_1Rsdy1EJXIhiKzYGOtzvwhUH", // £5 plan
        "price_1RsdzREJXIhiKzYG45b69nSl", // £20 plan
      ]);

      // 1) Create SetupIntent
      const siRes = await fetch("/api/stripe/setup-intent", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        }
      });
      const siData = await siRes.json();
      if (!siRes.ok || !siData.clientSecret) {
        throw new Error("Failed to start payment setup.");
      }

      // 2) Confirm card setup
      const { setupIntent, error } = await stripe.confirmCardSetup(siData.clientSecret, {
        payment_method: {
          card,
          billing_details: { name: cardholderName || "" }
        }
      });
      if (error) throw new Error(error.message);

      if (TRIAL_ELIGIBLE.has(priceId)) {
        // === £1 trial path ===
        const piRes = await fetch("/api/create-payment-intent", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`
          },
          body: JSON.stringify({ priceId: "trial_fee" })
        });
        const piData = await piRes.json();
        if (!piRes.ok || !piData.clientSecret) {
          throw new Error("Failed to create trial fee.");
        }

        const { error: trialErr } = await stripe.confirmCardPayment(piData.clientSecret, {
          payment_method: setupIntent.payment_method
        });
        if (trialErr) throw new Error(trialErr.message || "Trial fee confirmation failed.");

        // Create subscription (trialing)
        const subRes = await fetch("/api/stripe/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`
          },
          body: JSON.stringify({
            priceId,
            paymentMethodId: setupIntent.payment_method
          })
        });
        const subData = await subRes.json();
        if (!subRes.ok) {
          throw new Error(subData?.error || "Subscription failed");
        }

        window.location.href = `/thankyou.html?priceId=${encodeURIComponent(priceId)}`;
      } else {
        // === £99 plan path (immediate invoice) ===
        const subRes = await fetch("/api/stripe/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`
          },
          body: JSON.stringify({
            priceId,
            paymentMethodId: setupIntent.payment_method
          })
        });
        const subData = await subRes.json();
        if (!subRes.ok || !subData.clientSecret) {
          throw new Error(subData?.error || "Missing payment client secret.");
        }

        const { error: confirmErr } = await stripe.confirmCardPayment(subData.clientSecret);
        if (confirmErr) throw new Error(confirmErr.message || "Payment confirmation failed.");

        window.location.href = `/thankyou.html?priceId=${encodeURIComponent(priceId)}`;
      }
    }

    document.getElementById("subscribe-5").addEventListener("click", () => {
      startSubscription("price_1Rsdy1EJXIhiKzYGOtzvwhUH", document.getElementById("cardholder-name").value);
    });

    document.getElementById("subscribe-20").addEventListener("click", () => {
      startSubscription("price_1RsdzREJXIhiKzYG45b69nSl", document.getElementById("cardholder-name").value);
    });

    document.getElementById("subscribe-99").addEventListener("click", () => {
      startSubscription("price_1Rse3AEJXIhiKzYGYOUR99ID", document.getElementById("cardholder-name").value); // replace with actual 99 plan priceId
    });
  </script>
</body>
</html>
