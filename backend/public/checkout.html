  async function startSubscription(priceId, cardholderName) {
    const TRIAL_ELIGIBLE = new Set([
      "price_1Rsdy1EJXIhiKzYGOtzvwhUH", // £5 plan
      "price_1RsdzREJXIhiKzYG45b69nSl", // £20 plan
    ]);

    // 1) Create SetupIntent
    const siRes = await fetch("/api/stripe/setup-intent", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    });
    const siData = await siRes.json();
    if (!siRes.ok || !siData.clientSecret) {
      throw new Error("Failed to start payment setup.");
    }

    // 2) Confirm card setup (may open 3DS)
    const { setupIntent, error } = await stripe.confirmCardSetup(siData.clientSecret, {
      payment_method: {
        card,
        billing_details: { name: cardholderName || "" }
      }
    });
    if (error) throw new Error(error.message);

    if (TRIAL_ELIGIBLE.has(priceId)) {
      // === £1 trial path (for £5 / £20) ===

      // 3a) Charge £1 one-time trial fee
      const piRes = await fetch("/api/create-payment-intent", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({ priceId: "trial_fee" })
      });
      const piData = await piRes.json();
      if (!piRes.ok || !piData.clientSecret) {
        throw new Error("Failed to create trial fee.");
      }

      const { error: trialErr } = await stripe.confirmCardPayment(piData.clientSecret, {
        payment_method: setupIntent.payment_method
      });
      if (trialErr) throw new Error(trialErr.message || "Trial fee confirmation failed.");

      // 3b) Create subscription (returns status "trialing"; no invoice to confirm now)
      const subRes = await fetch("/api/stripe/subscribe", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({
          priceId,
          paymentMethodId: setupIntent.payment_method
        })
      });
      const subData = await subRes.json();
      if (!subRes.ok) {
        throw new Error(subData?.error || "Subscription failed");
      }

      // Success → redirect
      window.location.href = `/thankyou.html?priceId=${encodeURIComponent(priceId)}`;

    } else {
      // === £99 plan path (immediate invoice) ===
      const subRes = await fetch("/api/stripe/subscribe", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({
          priceId,
          paymentMethodId: setupIntent.payment_method
        })
      });
      const subData = await subRes.json();
      if (!subRes.ok || !subData.clientSecret) {
        throw new Error(subData?.error || "Missing payment client secret.");
      }

      const { error: confirmErr } = await stripe.confirmCardPayment(subData.clientSecret);
      if (confirmErr) throw new Error(confirmErr.message || "Payment confirmation failed.");

      window.location.href = `/thankyou.html?priceId=${encodeURIComponent(priceId)}`;
    }
  }
