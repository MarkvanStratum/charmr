<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Checkout</title>
  <style>
    :root{
      --bg:#ffffff; --text:#0a2540; --muted:#5b6b82; --line:#e3e8ee; --accent:#10b981; --accentText:#fff; --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#f6f7fb;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .shell{max-width:800px;margin:24px auto 48px;padding:0 16px}

    .summarybar{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px 12px;margin-bottom:14px}
    .summarybar .logos{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .summarybar .price{font-weight:900}

    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    h2{font-size:18px;margin:6px 0 12px}
    .sub{font-size:13px;color:var(--muted);margin:-4px 0 12px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:640px){.grid-2,.grid-3{grid-template-columns:1fr}}

    .label{font-size:13px;font-weight:700;color:#334;margin:6px 0 6px}
    .input,.select,.el{width:100%;background:#fff;border:1px solid #c7d0dd;border-radius:10px;padding:12px;font-size:15px;outline:none}
    .checkbox{display:flex;align-items:center;gap:8px;margin:8px 0 8px;font-size:14px;color:#233}

    .shipping-row{display:flex;align-items:center;justify-content:space-between;border:1px dashed #d7deea;border-radius:10px;background:#f7f9fd;padding:10px 12px;margin:8px 0 12px}

    .btn{width:100%;border:none;border-radius:12px;padding:12px 16px;font-weight:900;font-size:16px;cursor:pointer;background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff;margin-top:12px}
    .footnote{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}

    .err{display:none;background:#fff1f1;border:1px solid #f5bcbc;color:#9a1a1a;padding:10px;border-radius:10px;font-size:14px;margin-top:10px}
    .err[aria-hidden="false"]{display:block}

    /* Loading overlay */
    .loading-overlay{position:fixed;inset:0;background:rgba(246,249,252,.92);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay[aria-hidden="false"]{display:flex}
    .loading-box{width:min(92vw,460px);background:#fff;border:1px solid #e6edf5;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px;text-align:center;color:#2a3b55}
    .loading-title{font-weight:800;margin:2px 0 10px;font-size:18px}
    .progress-wrap{width:100%;height:10px;background:#ecf1f8;border-radius:999px;overflow:hidden}
    .progress-bar{width:0%;height:100%;background:linear-gradient(90deg,#22c55e,#60a5fa);animation:loadingBar 2.2s ease-in-out infinite}
    @keyframes loadingBar{0%{width:0%}60%{width:80%}100%{width:100%}}

    /* Section numbers */
    .section{margin-bottom:16px}
    .section > .num{display:inline-block;font-weight:900;margin-right:6px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="summarybar">
      <div class="logos">
        <span>Verified by VISA Â· MasterCard SecureCode</span>
      </div>
      <div class="price" id="topPrice">$9.95</div>
    </div>

    <section class="card">
      <!-- 1. Contact Information -->
      <div class="section">
        <h2><span class="num">1.</span> Contact Information</h2>
        <div class="grid-2">
          <div>
            <div class="label">First Name</div>
            <input id="firstName" class="input" autocomplete="given-name" placeholder="First Name" />
          </div>
          <div>
            <div class="label">Last Name</div>
            <input id="lastName" class="input" autocomplete="family-name" placeholder="Last Name" />
          </div>
          <div class="grid-span-2">
            <div class="label">E-mail Address</div>
            <input id="email" class="input" type="email" autocomplete="email" placeholder="you@example.com" />
          </div>
        </div>
      </div>

      <!-- 2. Shipping Information (we'll use this as the billing address too) -->
      <div class="section">
        <h2><span class="num">2.</span> Shipping Information</h2>
        <div class="label">Address</div>
        <input id="shipAddress" class="input" autocomplete="address-line1" placeholder="Address" />

        <div class="grid-3" style="margin-top:8px">
          <div>
            <div class="label">City</div>
            <input id="shipCity" class="input" autocomplete="address-level2" placeholder="City" />
          </div>
          <div>
            <div class="label">State</div>
            <input id="shipState" class="input" autocomplete="address-level1" placeholder="State" />
          </div>
          <div>
            <div class="label">Zip Code</div>
            <input id="shipZip" class="input" autocomplete="postal-code" placeholder="Zip" />
          </div>
        </div>
        <div style="margin-top:8px">
          <div class="label">Phone Number</div>
          <input id="phone" class="input" inputmode="tel" autocomplete="tel" placeholder="Your number" />
        </div>
        <label class="checkbox"><input id="sameAs" type="checkbox" checked /> Billing address is the same as shipping</label>
      </div>

      <!-- 3. Shipping Method (static) -->
      <div class="section">
        <h2><span class="num">3.</span> Shipping Method</h2>
        <div class="shipping-row">
          <div>â€¢ Tracked delivery (shipped within 48h)</div>
          <div style="font-weight:700">Free</div>
        </div>
      </div>

      <!-- 4. Payment -->
      <div class="section">
        <h2><span class="num">4.</span> Payment</h2>
        <p class="sub">All transactions are secure and encrypted. Powered by Stripe.</p>
        <div class="label">Card Number</div>
        <div id="card-number" class="el"></div>
        <div class="grid-2" style="margin-top:10px">
          <div>
            <div class="label">MM / YYYY</div>
            <div id="card-expiry" class="el"></div>
          </div>
          <div>
            <div class="label">CVV</div>
            <div id="card-cvc" class="el"></div>
          </div>
        </div>
      </div>

      <div id="err" class="err" role="alert" aria-hidden="true"></div>
      <button id="orderNow" class="btn">Order Now</button>
      <p class="footnote">ðŸ”’ SSL-secured transaction</p>
    </section>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true" style="display:none">
    <div class="loading-box">
      <div class="loading-title">Processing your paymentâ€¦</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub" style="margin-top:10px">Please wait, this may take a few seconds.</p>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
    // ----- Keep the SAME endpoint / keys / flow as atlas.html -----
    const SUBSCRIBE_URL = "https://charmr-jfmc.onrender.com/api/stripe/intro-charge-20"; // same server.js endpoint
    const PUBLISHABLE_KEY = "pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";

    const overlay = document.getElementById('loading-overlay');
    const errBox = document.getElementById('err');
    function showLoading(){overlay.style.display='flex';overlay.setAttribute('aria-hidden','false');}
    function hideLoading(){overlay.setAttribute('aria-hidden','true');overlay.style.display='none';}

    // Init Stripe Elements
    let stripe, elements, cardNumber, cardExpiry, cardCvc;
    if(window.Stripe){
      stripe = Stripe(PUBLISHABLE_KEY);
      elements = stripe.elements();
      cardNumber = elements.create('cardNumber');
      cardExpiry = elements.create('cardExpiry');
      cardCvc    = elements.create('cardCvc');
      cardNumber.mount('#card-number');
      cardExpiry.mount('#card-expiry');
      cardCvc.mount('#card-cvc');
    }

    function nameFrom(first, last){
      return [first||'', last||''].join(' ').trim() || undefined;
    }

    // Optional: quick country guess for Stripe address (can be blank)
    function guessISO(){ const cc=(navigator.language||'').split('-')[1]; return cc?cc.toUpperCase():undefined; }

    async function handlePay(){
      if(!stripe){ alert('Payment temporarily unavailable. Please try again.'); return; }
      errBox.setAttribute('aria-hidden','true'); errBox.textContent='';
      showLoading();

      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim() || undefined;

      // We treat shipping = billing for this one-step layout
      const address = {
        line1: document.getElementById('shipAddress').value.trim() || undefined,
        city: document.getElementById('shipCity').value.trim() || undefined,
        state: document.getElementById('shipState').value.trim() || undefined,
        postal_code: document.getElementById('shipZip').value.trim() || undefined,
        country: guessISO() // will be undefined if cannot guess; server/Stripe will accept
      };

      try{
        // 1) Create a PaymentMethod (same as atlas)
        const pmRes = await stripe.createPaymentMethod({
          type:'card',
          card: cardNumber,
          billing_details:{ name: nameFrom(first,last), email: email||undefined, phone, address }
        });
        if(pmRes.error) throw new Error(pmRes.error.message);

        // 2) Call the exact same endpoint (server.js) to start the intro charge
        const resp = await fetch(SUBSCRIBE_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          paymentMethodId: pmRes.paymentMethod.id,
          name: nameFrom(first,last),
          email, phone, address
        })});
        const data = await resp.json();
        if(!data.clientSecret) throw new Error(data.error || 'Payment failed to start');

        // 3) Confirm the PaymentIntent (handles SCA)
        const conf = await stripe.confirmCardPayment(data.clientSecret);
        if(conf.error) throw new Error(conf.error.message);
        if(!(conf.paymentIntent && conf.paymentIntent.status==='succeeded')) throw new Error('Payment not completed');

        // 4) Redirect â€“ preserve the 60/40 split from atlas.html
        (function(){
          const A = 'thankyou-iphone.html';
          const B = 'thankyou-iphone-skip.html';
          const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';
          function fnv1a32(str){ let h=0x811c9dc5>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,0x01000193)>>>0; } return h>>>0; }
          function cryptoRandInt(max){ try{ const u32=new Uint32Array(1); crypto.getRandomValues(u32); return Number(u32[0]%BigInt(max)); }catch{ return Math.floor(Math.random()*max); } }
          const bucket = pid ? (fnv1a32(pid)%100) : cryptoRandInt(100);
          const goSkip = bucket < 60; // 60% to thankyou-iphone.html
          const qb = pid ? ('?v='+encodeURIComponent(pid)) : ('?t='+Date.now());
          window.location.href = (goSkip?B:A) + qb;
        })();
      }catch(err){
        errBox.textContent = err.message || 'Something went wrong.';
        errBox.setAttribute('aria-hidden','false');
        hideLoading();
      }
      // On success we keep the overlay up until redirect / 3DS completes
    }

    document.getElementById('orderNow').addEventListener('click', handlePay);
  </script>

  <!-- GoAffPro loader (kept, matches atlas.html integration) -->
  <script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>
</body>
</html>
