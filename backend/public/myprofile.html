<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Profile</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FDQ6REQWS8');
</script>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: linear-gradient(to bottom right, #f2e6ff, #ffffff);
      font-family: Arial, sans-serif;
    }
    .profile-container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .profile-container img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
      border: 3px solid #6a3fb5;
    }
    .profile-container h2 {
      margin-bottom: 5px;
      color: #6a3fb5;
    }
    .profile-container p {
      margin: 8px 0;
      color: #444;
    }
    .profile-buttons button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      background: #6a3fb5;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .profile-buttons button:hover {
      background: #562e94;
    }
  </style>
<script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>
</head>
<body>
  <div class="profile-container">
    <img src="https://via.placeholder.com/120" alt="User Photo">
    <h2 id="username">Loading...</h2>
    <p><strong>Email:</strong> <span id="email">Loading...</span></p>
    <p><strong>Credits left:</strong> <span id="credits">Loading...</span></p>
    <p><strong>Lifetime access:</strong> <span id="lifetime">Loading...</span></p>

    <!-- ðŸ”¹ Subscription link (moved details to subscriptions.html) -->
    <div style="margin-top:14px;">
      <a href="subscriptions.html" style="
        display:block;
        margin-top:24px;
        font-size:12px;
        color:#6b7280;
        text-decoration:underline;
        background:transparent;
        padding:0;
        border-radius:0;
      ">
        See active subscriptions
      </a>
    </div>

    <div class="profile-buttons">
      <button>Edit Profile</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    async function loadProfile() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("You must be logged in");
        window.location.href = "/login.html";
        return;
      }

      try {
        // ðŸ”¹ Fetch credits and lifetime info
        const creditRes = await fetch("/api/credits", {
          headers: { Authorization: `Bearer ${token}` },
        });

        const creditData = await creditRes.json();
        if (!creditRes.ok) throw new Error(creditData.error || "Failed to fetch credits");

        // ðŸ”¹ Decode token to extract user email
        const [, payload] = token.split(".");
        const decoded = JSON.parse(atob(payload));
        const email = decoded.email;

        document.getElementById("email").innerText = email;
        document.getElementById("username").innerText = email.split("@")[0];
        document.getElementById("credits").innerText = creditData.lifetime
          ? "Unlimited"
          : `${creditData.credits} messages`;
        document.getElementById("lifetime").innerText = creditData.lifetime ? "Yes âœ…" : "No";

        // ðŸ”¹ After profile basics, load subscription block
        await loadSubscriptionPanel(token);

      } catch (err) {
        console.error("Profile error:", err);
        alert("Could not load your profile.");
      }
    }

    // ðŸ”¹ Subscription panel logic
    async function loadSubscriptionPanel(token) {
      const target = document.getElementById('subscription-panel');
      if (!target) return;

      const labelMap = {
        free: 'Free',
        plus: 'Plus (Â£5/mo)',
        pro: 'Pro (Â£20/mo)',
        ultra: 'Ultra (Â£99 / 6mo)'
      };

      function fmt(d) {
        try { return new Date(d).toLocaleString(); } catch { return d || ''; }
      }

      target.innerHTML = 'Loading subscription...';
      try {
        const r = await fetch('/api/me/subscription', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!r.ok) throw new Error('Failed to load subscription');
        const sub = await r.json();

        const tierName = labelMap[sub.tier] || sub.tier || 'Free';
        const isPaid = sub.tier && sub.tier !== 'free' && sub.status !== 'inactive';
        const willCancel = !!sub.cancelAtPeriodEnd;

        let html = `
          <div style="padding:12px;border:1px solid #eee;border-radius:8px;background:#faf7ff;text-align:left">
            <div style="font-weight:700;margin-bottom:6px">Subscription</div>
            <div>Plan: <b>${tierName}</b></div>
            <div>Status: <b>${sub.status}</b></div>
            ${sub.trialEnd ? `<div>Trial ends: ${fmt(sub.trialEnd)}</div>` : ``}
            ${sub.currentPeriodEnd ? `<div>Current period end: ${fmt(sub.currentPeriodEnd)}</div>` : ``}
        `;

        if (isPaid && !willCancel) {
          html += `
            <button id="cancelSubBtn" style="
              margin-top:10px;padding:10px 16px;border:0;border-radius:6px;
              background:#6a3fb5;color:#fff;cursor:pointer">
              Cancel subscription
            </button>
            <div style="font-size:12px;color:#6b7280;margin-top:6px">
              Cancels at the end of the current period.
            </div>
          `;
        } else if (isPaid && willCancel) {
          html += `<div style="margin-top:10px;color:#b91c1c">
            Cancellation scheduled at period end.
          </div>`;
        } else {
          html += `<div style="margin-top:10px;color:#6b7280">No active subscription.</div>`;
        }

        html += `</div>`;
        target.innerHTML = html;

        const btn = document.getElementById('cancelSubBtn');
        if (btn) {
          btn.onclick = async () => {
            if (!confirm('Cancel at the period end?')) return;
            btn.disabled = true;
            try {
              const rr = await fetch('/api/stripe/cancel', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ atPeriodEnd: true })
              });
              const data = await rr.json();
              if (!rr.ok) throw new Error(data?.error || 'Cancel failed');
              alert('Cancellation scheduled. You keep access until the period end.');
              loadSubscriptionPanel(token);
            } catch (e) {
              alert(e.message || 'Failed to cancel');
              btn.disabled = false;
            }
          };
        }
      } catch (e) {
        target.innerHTML = `<div style="color:#b91c1c">Could not load subscription.</div>`;
        console.warn('Subscription panel error:', e);
      }
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("cachedMessages"); // âœ… extra cleanup
      window.location.href = "/login.html";
    }

    loadProfile();
  </script>
</body>
</html>
