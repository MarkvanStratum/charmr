<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subscriptions</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: linear-gradient(to bottom right, #f2e6ff, #ffffff);
      font-family: Arial, sans-serif;
    }
    .subscription-container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .subscription-container h2 {
      margin-bottom: 20px;
      color: #6a3fb5;
    }
    .back-link {
      display:inline-block;
      margin-top:20px;
      padding:10px 16px;
      background:#6a3fb5;
      color:white;
      border-radius:6px;
      text-decoration:none;
    }
    .back-link:hover {
      background:#562e94;
    }
  </style>
</head>
<body>
  <div class="subscription-container">
    <h2>Your Subscription</h2>
    <div id="subscription-panel">Loading subscription...</div>
    <a href="myprofile.html" class="back-link">← Back to Profile</a>
  </div>

  <script>
    async function loadSubscription() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("You must be logged in");
        window.location.href = "/login.html";
        return;
      }

      const target = document.getElementById('subscription-panel');
      const labelMap = {
        free: 'Free',
        plus: 'Plus (£5/mo)',
        pro: 'Pro (£20/mo)',
        ultra: 'Ultra (£99 / 6mo)'
      };

      function fmt(d) {
        try { return new Date(d).toLocaleString(); } catch { return d || ''; }
      }

      target.innerHTML = 'Loading...';
      try {
        const r = await fetch('/api/me/subscription', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!r.ok) throw new Error('Failed to load subscription');
        const sub = await r.json();

        const tierName = labelMap[sub.tier] || sub.tier || 'Free';
        const isPaid = sub.tier && sub.tier !== 'free' && sub.status !== 'inactive';
        const willCancel = !!sub.cancelAtPeriodEnd;

        let html = `
          <div style="padding:12px;border:1px solid #eee;border-radius:8px;background:#faf7ff;text-align:left">
            <div style="font-weight:700;margin-bottom:6px">Subscription</div>
            <div>Plan: <b>${tierName}</b></div>
            <div>Status: <b>${sub.status}</b></div>
            ${sub.trialEnd ? `<div>Trial ends: ${fmt(sub.trialEnd)}</div>` : ``}
            ${sub.currentPeriodEnd ? `<div>Current period end: ${fmt(sub.currentPeriodEnd)}</div>` : ``}
        `;

        if (isPaid && !willCancel) {
          html += `
            <button id="cancelSubBtn" style="
              margin-top:10px;padding:10px 16px;border:0;border-radius:6px;
              background:#6a3fb5;color:#fff;cursor:pointer">
              Cancel subscription
            </button>
            <div style="font-size:12px;color:#6b7280;margin-top:6px">
              Cancels at the end of the current period.
            </div>
          `;
        } else if (isPaid && willCancel) {
          html += `<div style="margin-top:10px;color:#b91c1c">
            Cancellation scheduled at period end.
          </div>
          <button id="reactivateSubBtn" style="
            margin-top:10px;padding:10px 16px;border:0;border-radius:6px;
            background:#6a3fb5;color:#fff;cursor:pointer">
            Keep subscription (undo cancel)
          </button>`;
        } else {
          html += `<div style="margin-top:10px;color:#6b7280">No active subscription.</div>
          <button id="reactivateSubBtn" style="
            margin-top:10px;padding:10px 16px;border:0;border-radius:6px;
            background:#6a3fb5;color:#fff;cursor:pointer">
            Reactivate subscription
          </button>`;
        }

        html += `</div>`;
        target.innerHTML = html;

        const btn = document.getElementById('cancelSubBtn');
        if (btn) {
          btn.onclick = async () => {
            if (!confirm('Cancel at the period end?')) return;
            btn.disabled = true;
            try {
              const rr = await fetch('/api/stripe/cancel', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ atPeriodEnd: true })
              });
              const data = await rr.json();
              if (!rr.ok) throw new Error(data?.error || 'Cancel failed');
              alert('Cancellation scheduled. You keep access until the period end.');
              loadSubscription();
            } catch (e) {
              alert(e.message || 'Failed to cancel');
              btn.disabled = false;
            }
          };
        }

        // NEW: Reactivate (undo cancel or start same plan again)
        const reactBtn = document.getElementById('reactivateSubBtn');
        if (reactBtn) {
          reactBtn.onclick = async () => {
            reactBtn.disabled = true;
            try {
              const rr = await fetch('/api/stripe/reactivate', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                // Let the server decide whether to undo a scheduled cancel
                // or create a new subscription on the same plan.
                body: JSON.stringify({}) 
              });
              const data = await rr.json().catch(()=> ({}));
              if (!rr.ok) throw new Error(data?.error || 'Reactivate failed');
              alert('Subscription reactivated.');
              loadSubscription();
            } catch (e) {
              alert(e.message || 'Failed to reactivate');
              reactBtn.disabled = false;
            }
          };
        }
      } catch (e) {
        target.innerHTML = `<div style="color:#b91c1c">Could not load subscription.</div>`;
        console.warn('Subscription error:', e);
      }
    }

    loadSubscription();
  </script>
</body>
</html>
